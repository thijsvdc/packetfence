= Network Devices Configuration Guide
:encoding: UTF-8
:lang: en
:doctype: book
:toc: left

// to display images directly on GitHub
ifdef::env-github[]
:imagesdir: images
endif::[]

////

    This file is part of the PacketFence project.

    See PacketFence_Network_Devices_Configuration_Guide-docinfo.xml for 
    authors, copyright and license information.

////

include::includes/global-attributes.asciidoc[]

== About this Guide

This guide covers the configuration of network devices in order to integrate 
them with PacketFence in VLAN enforcement. Switches, wireless controllers and 
wireless access points are all considered network devices in PacketFence's 
terms.

The latest version of this guide is available at https://packetfence.org/documentation/

=== Other sources of information

<<PacketFence_Clustering_Guide.asciidoc#,Clustering Guide>>::
  Covers installation in a clustered environment.
<<PacketFence_Developers_Guide.asciidoc#,Developer's Guide>>::
  Covers API, captive portal customization, application code customizations and
  instructions for supporting new equipment.
<<PacketFence_Installation_Guide.asciidoc#,Installation Guide>>::
  Covers installation and configuration of PacketFence.
<<PacketFence_Upgrade_Guide.asciidoc#,Upgrade Guide>>::
  Covers compatibility related changes, manual instructions and general notes
  about upgrading.
`NEWS.asciidoc`::
  Covers noteworthy features, improvements and bug fixes by release.

These files are included in the package and release tarballs.

Note on Inline enforcement support
----------------------------------

There is no need to follow the instructions in this guide if you plan on deploying in inline 
enforcement, except RADIUS inline. In this case all you need to do is to have a flat layer 2 network up to 
PacketFence's inline interface with no other gateway available for devices to reach out to the 
Internet. 

This technique is usually used when your network hardware doesn't support VLAN 
enforcement.


Note on RADIUS accounting
-------------------------

Enabling RADIUS accounting on your network devices will increase significantly
your database size and can cause performance issues.  You should be aware of
this and use accounting only if you really need it.


List of supported Network Devices
---------------------------------

PacketFence supports a whole lot of different wireless and wired network equipment from various vendors running 
different versions. Since we want to provide the most accurate information and avoid duplication of that same 
information, please refer to our website https://packetfence.org/about.html#/material

You'll find on this page the enforcement modes supported by each and every single piece of equipment we tested and 
worked with. 

Switch configuration
--------------------

Assumptions
~~~~~~~~~~~

Throughout this configuration example we use the following assumptions for 
our network infrastructure: 

[options="compact"]
* PacketFence is fully configured with FreeRADIUS running (if you want 802.1X or MAC Auth) 
* PacketFence IP address: 192.168.1.5 
* Normal VLAN: 1 
* Registration VLAN: 2 
* Isolation VLAN: 3 
* MAC Detection VLAN: 4 
* Guest VLAN: 5
* VoIP, Voice VLAN: 100 
* use SNMP v2c
* SNMP Read community: public
* SNMP Write community: private
* SNMP Trap community: public 
* RADIUS Secret: useStrongerSecret 


3COM
~~~~

SuperStack 3 Switch 4200 and 4500
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

PacketFence supports these 3Com switches _without VoIP_ using one trap type:

* linkUp/linkDown
* Port Security (with static MACs)

Don't forget to update the startup config!

linkUp / linkDown only
++++++++++++++++++++++

Global config settings:

  snmp-agent
  snmp-agent target-host trap address udp-domain 192.168.1.5 params securityname public
  snmp-agent trap enable standard linkup linkdown

On each interface:

  port access vlan 4

In Port Security
++++++++++++++++

Global config settings:

  snmp-agent
  snmp-agent target-host trap address udp-domain 192.168.1.5 params securityname public
  snmp-agent trap enable
  port-security enable
  port-security trap addresslearned
  port-security trap intrusion

On each interface:

  port access vlan 4
  port-security max-mac-count 1
  port-security port-mode secure
  port-security intrusion-mode blockmac
  undo enable snmp trap updown

In MAC Auth 
+++++++++++
 Voice vlan : 6
 Normal vlan : 1
 Registration vlan : 2
 Isolation vlan : 3

Global config settings:

 lldp enable
 lldp timer tx-interval 5
 lldp compliance cdp
 lldp compliance cdp

 port-security enable
 MAC-authentication domain packetfence

 radius scheme system
 radius scheme packetfence
  server-type extended
  primary authentication 192.168.1.5
  primary accounting 192.168.1.5
  key authentication P@cketfence
  key accounting cipher P@cketfence
  user-name-format without-domain

 domain packetfence
  authentication radius-scheme packetfence
  accounting radius-scheme packetfence
  vlan-assignment-mode string
  accounting optional
 domain system

 voice vlan mac-address f4ea-6700-0000 mask ffff-ff00-0000 description Cisco IP Phone
 undo voice vlan security enable
 voice vlan 6 enable

On each interface with VoIP:


 interface Ethernet1/0/1
  stp edged-port enable
  lldp compliance admin-status cdp txrx
  port link-type hybrid
  port hybrid vlan 6 tagged
  port hybrid vlan 1 2 3 untagged
  undo voice vlan mode auto
  voice vlan enable
  port-security max-mac-count 3
  port-security port-mode mac-authentication
  port-security intrusion-mode blockmac
  undo enable snmp trap updown

E4800G
^^^^^^

PacketFence supports these 3Com switches with the following techniques:

* 802.1X with MAC Authentication fallback
* linkUp/linkDown (not recommended)

Voice over IP support was not explicitly tested during implementation however 
it does not mean that it won't work. 

Don't forget to update the startup config!

linkUp / linkDown only
++++++++++++++++++++++

Global config settings:

  snmp-agent
  snmp-agent target-host trap address udp-domain 192.168.1.5 params securityname public
  snmp-agent trap enable standard linkup linkdown

On each interface:

  port access vlan 4

802.1X with MAC Authentication fallback
+++++++++++++++++++++++++++++++++++++++

Global config settings:

  system-view 
     radius scheme PacketFence 
       primary authentication 192.168.1.5 1812 
       primary accounting 192.168.1.5 1812 
       key authentication useStrongerSecret 
       user-name-format without-domain 
       quit 
     domain packetfence.local 
       authentication default radius-scheme PacketFence 
       authorization default radius-scheme PacketFence 
       quit 
     domain default enable packetfence.local 
     dot1x authentication-method eap 
     port-security enable 
  quit 

If your management authentication on your switch is default, applying the 
configuration above will have your authentication switch to a RADIUS based one
with PacketFence as the authentication server. *It is almost certain that you 
do not want that!*

Below, we will just create a local password for `vty` accesses (telnet) and 
nothing on the console. *In order to avoid locking yourself out, make sure 
to verify your configuration!*

  system-view 
     user-interface aux 0 
       authentication-mode none 
    user-interface vty 0 4 
      user privilege level 3 
      set authentication password simple useStrongerPassword 
    quit 
  quit 

On each interface:

  system-view 
    interface gigabitEthernet 1/0/xx 
      port-security port-mode mac-else-userlogin-secure-ext 
      # userlogin-secure-or-mac-ext could be used below instead 
      # see the Switch_4200G's documentation for a discussion about it 
      undo enable snmp trap updown 
      quit 
  quit 

where `xx` stands for the interface index.

E5500G and Switch 4200G 
^^^^^^^^^^^^^^^^^^^^^^^

PacketFence supports these 3Com switches with the following techniques: 

* 802.1X with MAC Authentication fallback 
* linkUp/linkDown (not recommended) 

Voice over IP support was not explicitly tested during implementation however 
it does not mean that it won't work.

Don't forget to update the startup config ! 

linkUp / linkDown only
++++++++++++++++++++++

Global config settings:

  snmp-agent 
  snmp-agent target-host trap address udp-domain 192.168.1.5 params 
  securityname public 
  snmp-agent trap enable standard linkup linkdown 

On each interface: 

  port access vlan 4 

802.1X with MAC Authentication fallback 
+++++++++++++++++++++++++++++++++++++++

Global config settings:

  system-view 
     radius scheme PacketFence 
       server-type standard 
       primary authentication 192.168.1.5 1812 
       primary accounting 192.168.1.5 1812 
       accounting optional 
       key authentication useStrongerSecret 
       user-name-format without-domain 
       quit 
     domain packetfence.local 
       radius-scheme PacketFence 
       vlan-assignment-mode string 
       quit 
     domain default enable packetfence.local 
     dot1x authentication-method eap 
     port-security enable 
  quit 

If your management authentication on your switch is default, applying the configuration above 
will have your authentication switch to a RADIUS based one with PacketFence as the 
authentication server. *It is almost certain that you do not want that!*

Below, we will just create a local password for `vty` accesses (telnet) and nothing on the 
console. *In order to avoid locking yourself out, make sure to verify your configuration!*

  system-view 
     user-interface aux 0 
       authentication-mode none 
    user-interface vty 0 4 
      user privilege level 3 
      set authentication password simple useStrongerPassword 
    quit 
  quit 

On each interface: 

  system-view 
    interface gigabitEthernet 1/0/xx 
      port-security port-mode mac-else-userlogin-secure-ext 
      # userlogin-secure-or-mac-ext could be used below instead 
      # see the Switch_4200G's documentation for a discussion about it 
      undo enable snmp trap updown 
      quit 
  quit 

where `xx` stands for the interface index 

NJ220 
^^^^^

This switch does not support port-security. 

To configure: use web interface to send the linkUp/linkDown traps to the PacketFence server. 

Alcatel
~~~~~~~

OS6250, OS6450 
^^^^^^^^^^^^^^

PacketFence supports this switch using 802.1X, Mac authentication and also supports VoIP.

Global configuration
++++++++++++++++++++

First define any VLAN that you want to use on the switch.

    vlan 2
    vlan 5
    vlan 20
    vlan 100

Next, configure the RADIUS server to be PacketFence

    aaa radius-server "packetfence" host 192.168.1.5 key useStrongerSecret
    aaa authentication mac packetfence
    aaa authentication 802.1X packetfence

You now need to configure a user profile (equivalent of a role) that will determine which VLAN is assigned to the device. In this case the profile names are 'unreg', 'employee' and 'guest'.

    aaa user-network-profile name unreg vlan 2
    aaa user-network-profile name guest vlan 5
    aaa user-network-profile name employee vlan 20

Next, configure the switch in PacketFence. In the case of this example, the uplink is port 1/1.
 
    [192.168.1.10]
    mode=production
    description=alcatel
    type=Alcatel
    radiusSecret=useStrongerSecret
    uplink_dynamic=0
    uplink=1001
    RoleMap=Y
    VlanMap=N
    registrationRole=unreg
    isolationRole=unreg
    defaultRole=employee
    guestRole=guest

802.1X
++++++

First, make sure you followed the steps above in 'Global configuration'

You will need to configure the ports you want to do authentication on.

    vlan port mobile 1/2
    vlan port 1/2 802.1X enable
    802.1X 1/2 supplicant policy authentication pass group-mobility block fail block
    802.1X 1/2 non-supplicant policy authentication pass group-mobility block fail block

MAC Authentication
++++++++++++++++++

First, make sure you followed the steps above in 'Global configuration' and '802.1X'

Next configure the interface to bypass 802.1X authentication

    802.1X 1/2 supplicant bypass enable

VoIP
++++

PacketFence supports VoIP on Alcatel by having multiple devices using multiple untagged VLANs on the same port.

First configure the user profile for voice. In this example it is only isolating it on another VLAN but any user profile attributes can be added to the profile.

    aaa user-network-profile name voice vlan 3

Next, make sure you enable VoIP in the switch configuration in PacketFence and configure the voiceRole.

    [192.168.1.10]
    VoIPEnabled=Y
    voiceRole=voice


OS6860
^^^^^^

PacketFence supports this switch using 802.1X, Mac authentication and also supports VoIP.

NOTE: This documentation is made for Alcatel OS 8.1+. Lower versions do not support this configuration.

Global configuration
++++++++++++++++++++

First define any VLAN that you want to use on the switch.

    vlan 2 admin-state enable
    vlan 5 admin-state enable
    vlan 20 admin-state enable
    vlan 100 admin-state enable

Next, configure the RADIUS server to be PacketFence

    aaa radius-server "packetfence" host 192.168.1.5 key useStrongerSecret
    aaa device-authentication mac packetfence
    aaa device-authentication 802.1X packetfence

You now need to configure an edge profile (equivalent of a role) that will determine which VLAN is assigned to the device. In this case the profile names are 'unreg', 'employee' and 'guest'.


    unp edge-profile unreg
    unp edge-profile unreg redirect enable
    unp edge-profile unreg authentication-flag enable
    unp vlan-mapping edge-profile unreg vlan 2

    unp edge-profile guest
    unp edge-profile guest redirect enable
    unp edge-profile guest authentication-flag enable
    unp vlan-mapping edge-profile guest vlan 5

    unp edge-profile employee
    unp edge-profile employee redirect enable
    unp edge-profile employee authentication-flag enable
    unp vlan-mapping edge-profile employee vlan 20

CAUTION: Make sure you enable the redirect on *all* your roles as the access reevaluation will not work without it.

Next, configure the switch in PacketFence. In the case of this example, the uplink is port 1/1/1.
 
    [192.168.1.10]
    mode=production
    description=alcatel
    type=Alcatel
    radiusSecret=useStrongerSecret
    uplink_dynamic=0
    uplink=1001
    RoleMap=Y
    VlanMap=N
    registrationRole=unreg
    isolationRole=unreg
    defaultRole=employee
    guestRole=guest

MAC Authentication
++++++++++++++++++

First, make sure you followed the steps above in 'Global configuration'

You will need to create an edge template and apply it on the ports you want to do authentication on.

    unp edge-template pf_mab
    unp edge-template pf_mab mac-authentication enable
    unp edge-template pf_mab classification enable
    unp port 1/1/2 port-type edge
    unp port 1/1/2 edge-template pf_mab

802.1X
++++++

First, make sure you followed the steps above in 'Global configuration'

You will need to create an edge template and apply it on the ports you want to do authentication on.

    unp edge-template pf_dot1x
    unp edge-template pf_dot1x 802.1X-authentication enable
    unp edge-template pf_dot1x mac-authentication enable
    unp edge-template pf_dot1x 802.1X-authentication failure-policy mac-authentication
    unp port 1/1/2 port-type edge
    unp port 1/1/2 edge-template pf_dot1x

VoIP
++++

PacketFence supports VoIP on Alcatel by having multiple devices using multiple untagged VLANs on the same port.

First configure the edge profile for voice. In this example it is only isolating it on another VLAN but any edge profile attributes can be added to the profile.

    unp edge-profile voice
    unp edge-profile voice redirect enable
    unp edge-profile voice authentication-flag enable
    unp vlan-mapping edge-profile voice vlan 100

Next, make sure you enable VoIP in the switch configuration in PacketFence and configure the voiceRole.

    [192.168.1.10]
    VoIPEnabled=Y
    voiceRole=voice


AlliedTelesis
~~~~~~~~~~~~~

AT8000GS
^^^^^^^^

PacketFence supports the AT8000GS switch using :

* MAC Authentication
* 802.1X
* 802.1X + VOIP

Assumptions
+++++++++++

  PacketFence management IP: 192.168.1.5
  Switch management IP: 10.0.0.14
  Guest VLAN (Internet): VLAN 1


MAC Authentication
++++++++++++++++++

First, enable 802.1X globally:

   dot1x system-auth-control

Next, configure the RADIUS server and AAA settings:

   radius-server host 192.168.1.5               
   radius-server key useStrongerSecret
   radius-server source-ip 10.0.0.14
   aaa authentication dot1x default radius 
   aaa accounting dot1x radius

In order to get mac authentication, you need to enable the guest VLAN globally: 

   interface vlan 1
   name "Guest Vlan"
   dot1x guest-vlan
   exit

Finally, enable the necessary 802.1X settings for mac-only authentication:

   interface ethernet g1
   dot1x mac-authentication mac-only
   dot1x radius-attributes vlan                
   dot1x port-control auto
   dot1x guest-vlan enable


802.1X
++++++

The settings are almost the same as the MAC Authentication with some small differences.

First, enable 802.1X globally:

   dot1x system-auth-control

Next, configure the RADIUS server and AAA settings:

   radius-server host 192.168.1.5               
   radius-server key useStrongerSecret
   radius-server source-ip 10.0.0.14
   aaa authentication dot1x default radius 
   aaa accounting dot1x radius

Finally, enable the necessary 802.1X settings:

   interface ethernet g1    
   dot1x radius-attributes vlan
   dot1x port-control auto

802.1X + VOIP
+++++++++++++


First, enable 802.1X globally:

   dot1x system-auth-control

Next, configure the RADIUS server configuration and AAA settings:


   radius-server host 192.168.1.5               
   radius-server key useStrongerSecret
   radius-server source-ip 10.0.0.14
   aaa authentication dot1x default radius 
   aaa accounting dot1x radius

Then, LLDP configuration:

   hostname switch-name
   ip domain-name domain.local
   lldp med network-policy 1 voice vlan 100 vlan-type tagged dscp 34
   lldp med network-policy 2 voice-signaling vlan 100 vlan-type tagged dscp 34

Finally, enable the necessary 802.1X and VOIP settings on each interface:

   interface ethernet g1
    dot1x port-control force-authorized
    no dot1x guest-vlan enable
    no dot1x mac-authentication
    no dot1x radius-attributes vlan
    no dot1x re-authentication
    switchport mode trunk
    switchport trunk native vlan 5
    switchport trunk allowed vlan add 100
    lldp med enable network-policy
    lldp med network-policy add 1
    lldp med network-policy add 2

GS950
^^^^^

PacketFence supports the GS950 switch using :

* MAC Authentication
* 802.1X (without fallback to MAC authentication)

Global configuration
++++++++++++++++++++

First, ensure that the VLANs you want to assign are part of the VLAN database via the following page:

image::allied-telesis-gs950/vlan-config.png[scaledwidth="100%",alt="VLAN configuration"]

Note that they only need to be tagged on the trunk and don't need any specific configuration for the dynamic VLAN assignment here.

Next, configure the RADIUS server (Security->RADIUS):

image::allied-telesis-gs950/radius-server.png[scaledwidth="100%",alt="RADIUS configuration"]

Next, configure an SNMP community (SNMP->Community Table)

image::allied-telesis-gs950/snmp-config.png[scaledwidth="100%",alt="SNMP configuration"]

MAC authentication
++++++++++++++++++

Go in Security->Port Access Control, select the port you want to enable MAB on, and ensure you set:

[options="compact"]
* Authentication Mode: MAC Based
* Port Control: Auto
* Supplicant Mode: Single
* VLAN Assignment: Enabled

image::allied-telesis-gs950/port-control-MAB.png[scaledwidth="100%",alt="MAB config"]

802.1x
++++++

Go in Security->Port Access Control, select the port you want to enable MAB on, and ensure you set:

[options="compact"]
* Authentication Mode: 802.1X
* Port Control: Auto
* Supplicant Mode: Multiple
* VLAN Assignment: Enabled

image::allied-telesis-gs950/port-control-802.1x.png[scaledwidth="100%",alt="802.1x configuration"]

PacketFence configuration
+++++++++++++++++++++++++

Ensure you configure at least:

[options="compact"]
* Type: Allied Telesis GS950
* RADIUS secret: useStrongerSecret
* SNMP Version: v2c
* SNMP Community Read: private
* SNMP Community Write: private

If you are using MAC authentication on this switch, you must adjust the FreeRADIUS configuration so it transforms the EAP requests this switch sends into requests that PacketFence will interpret as MAC authentication. This configuration will also set missing attributes in the RADIUS requests since this switch doesn't follow the standard attributes that are usually sent during RADIUS authentication.

To adjust it, go in `/usr/local/pf/conf/radiusd/packetfence` and add the following below the line that contains `packetfence-eap-mac-policy`:

  packetfence-allied-gs950-mab

And then restart FreeRADIUS:

  # /usr/local/pf/bin/pfcmd service radiusd restart

Amer 
~~~~

PacketFence supports Amer switches _without VoIP_ using one trap type: 

* linkUp/linkDown 

Don't forget to update the startup config! 

L2 Switch SS2R24i 
^^^^^^^^^^^^^^^^^

Global config settings:

  create snmp host 192.168.1.5 v2c public 
  create snmp user public ReadGroup 
  enable snmp traps 

On each interface: 

  config vlan default delete xx 
  config vlan mac-detection add untagged xx 

where `xx` stands for the interface index 

Avaya 
~~~~~

Avaya bought Nortel's wired networks assets. So Avaya switches are, in effect, re-branded 
Nortels. See <<_nortel,Nortel section>> of this document for configuration instructions. 

802.1X with MAC Authentication Bypass and VoIP
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

NOTE: The configuration below requires an ntp server. We use the PacketFence server as the NTP server but any other one will do. If you want to use the PacketFence server for NTP, make sure you install the appropriate service and open port 123 in `/usr/local/pf/conf/iptables.conf`

Global config settings:

  sntp server primary address 192.168.1.5
  sntp enable
  radius server host 192.168.1.5 acct-enable 
  radius server host key useStrongerSecret
  radius server host key useStrongerSecret used-by eapol
  radius server host key useStrongerSecret used-by non-eapol
  radius dynamic-server client 192.168.1.5
  radius dynamic-server client 192.168.1.5 secret useStrongerSecret
  radius dynamic-server client 192.168.1.5 enable
  radius dynamic-server client 192.168.1.5 process-change-of-auth-requests
  radius dynamic-server client 192.168.1.5 process-disconnect-requests

  vlan create 2,3,4,5 type port
  vlan create 100 type port voice-vlan
  vlan name 2 "Reg"
  vlan name 3 "Isol"
  vlan name 4 "Detect"
  vlan name 5 "Guest"
  vlan name 100 "Voice"

  #Uplink configuration
  vlan ports 24 tagging tagAll 
  vlan configcontrol autopvid

  eapol multihost allow-non-eap-enable
  eapol multihost radius-non-eap-enable
  eapol multihost non-eap-phone-enable
  eapol multihost use-radius-assigned-vlan
  eapol multihost non-eap-use-radius-assigned-vlan
  eapol multihost eap-packet-mode unicast
  eapol multihost non-eap-reauthentication-enable
  eapol multihost adac-non-eap-enable
  no eapol multihost non-eap-pwd-fmt ip-addr
  no eapol multihost non-eap-pwd-fmt port-number
  eapol multihost voip-vlan 1 enable vid 100

  adac voice-vlan 100
  adac uplink-port 24
  adac op-mode tagged-frames
  adac enable

  qos if-group name TrustedLinks class trusted
  qos if-assign port ALL name TrustedLinks

Port 1 configuration:

  interface FastEthernet ALL
  vlan ports 1 tagging tagAll
  vlan members 2,3,4,5 1
  vlan ports 1 pvid 2
  eapol multihost port 1 enable eap-mac-max 8 allow-non-eap-enable non-eap-mac-max 8 radius-non-eap-enable use-radius-assigned-vlan non-eap-use-radius-assigned-vlan eap-packet-mode unicast adac-non-eap-enable
  eapol port 1 status auto traffic-control in re-authentication enable
  eapol port 1 radius-dynamic-server enable
  lldp port 1 vendor-specific avaya dot1q-framing tagged
  no adac detection port 1 mac
  adac port 1 tagged-frames-tagging tag-all
  adac port 1 enable
  spanning-tree port 1 learning fast


Brocade
~~~~~~~

NOTE: By default, all deconnections will be done using SNMP.

ICX 6400 Series
^^^^^^^^^^^^^^^

Those switches are supported using 802.1X for networks with or without VoIP.

* Global config settings:

  aaa authentication dot1x default radius
  radius-server host 192.168.1.5 auth-port 1812 acct-port 1813 default
  radius-server key useStrongerSecret

  vlan 1 name DEFAULT-VLAN by port
  !
  vlan 100 by port
   tagged ethe 1/1/xx ethe 1/1/yy

Where `xx` and `yy` represent the range of ports where you want PacketFence
enforcement.

MAC-Authentication without VoIP
+++++++++++++++++++++++++++++++

* Enable MAC-Authentication globally

  mac-authentication enable
  mac-authentication mac-vlan-dyn-activation

* Enable MAC-Authentication on each interface you want PacketFence active

   mac-authentication enable
   mac-authentication enable-dynamic-vlan

MAC-Authentication with VoIP
++++++++++++++++++++++++++++

* Enable cdp globally

  cdp run

* Apply the following configuration on each interface you want PacketFence active

   dual-mode
   mac-authentication enable
   mac-authentication enable-dynamic-vlan
   voice-vlan 100
   cdp enable

802.1X/MAC-Auth
+++++++++++++++

* Enable 802.1X globally

  dot1x-enable
   re-authentication
   enable ethe 1/1/xx

Where `xx` is the switch port number

* Apply the following configuration on each interface you want PacketFence active

   dot1x port-control auto
   dual-mode
   mac-authentication enable
   mac-authentication enable-dynamic-vlan
   voice-vlan 100

Firmware 08.0.80 and above
^^^^^^^^^^^^^^^^^^^^^^^^^^

802.1x/MAC-Auth
+++++++++++++++

Those switches are supported using 802.1X for networks with or without VoIP.

* RADIUS server configuration

  radius-server host 192.168.1.5 auth-port 1812 acct-port 1813 default key useStrongerSecret dot1x mac-auth no-login

* Authentication configuration

  aaa authentication dot1x default radius
  authentication
    auth-default-vlan 2
    re-authentication
    auth-fail-action restricted-vlan
    dot1x enable
    dot1x enable ethe 1/1/1
    dot1x port-control auto ethe 1/1/1
    dot1x macauth-override
    dot1x timeout tx-period 3
    dot1x timeout quiet-period 2
    mac-authentication enable
    mac-authentication enable ethe 1/1/1

The configuration above enables authentication on port 1/1/1 - make sure you change this to the ports where you want to perform enforcement.

* SNMP configuration

  snmpserver community public ro
  snmpserver community private rw

* PacketFence configuration

While configuring the switch in PacketFence, ensure you set at least the following values:
 * Definition, Type: Brocade Switches
 * RADIUS, Secret Passphrase: useStrongerSecret
 * SNMP, Version: v2c
 * SNMP, Community Read: public
 * SNMP, Community Write: private

VoIP
++++

In order to enable VoIP, you first need to enable LLDP then define the network policy for tagging VoIP traffic on the ports where PacketFence is enabled.

  lldp run
  lldp med network-policy application voice tagged vlan 5 priority 5 dscp 46 ports ethe 1/1/1 

NOTE: Make sure you change VLAN 5 to the VLAN you use for VoIP

* PacketFence configuration

While configuring the switch in PacketFence, ensure you set at least the following values:
 * Roles, voice VLAN: 5
 * Definition, VoIP: enabled

Radius CLI Login
^^^^^^^^^^^^^^^^

If you want to use the server PacketFence to authenticate users on the Brocade switch.

 * Configure the radius server to send user authentication request to PacketFence
   
   aaa authentication login default radius local

NOTE: Make sure to have a local account in case the switch can not reach the PacketFence server

Cisco
~~~~~

PacketFence supports Cisco switches with VoIP using three different trap types: 

* linkUp/linkDown 
* MAC Notification 
* Port Security (with static MACs) 

You also need to make sure that lldp or cdp notification is configured on all ports that will handle VoIP.

On some recent models, we can also use more secure and robust features like: 

* MAC Authentication (Cisco's MAC Authentication Bypass or MAB) 
* 802.1X (Multi-Host or Multi-Domain) 

Depending of the switch model, we recommend the use of the most secure and reliable feature 
first. In other words, you should consider the following order:

. 802.1X/MAB
. Port-Security
. linkUp/linkDown

2900XL / 3500XL Series
^^^^^^^^^^^^^^^^^^^^^^

SNMP | linkUP/linkDown
++++++++++++++++++++++

Global config settings: 

  snmp-server community public RO
  snmp-server community private RW
  snmp-server enable traps snmp linkdown linkup 
  snmp-server enable traps mac-notification 
  snmp-server host 192.168.1.5 trap version 2c public snmp mac-notification 
  mac-address-table notification interval 0 
  mac-address-table notification 
  mac-address-table aging-time 3600 

On each interface _without VoIP_: 

  switchport mode access 
  switchport access vlan 4 
  snmp trap mac-notification added 

On each interface _with VoIP_:

  switchport trunk encapsulation dot1q 
  switchport trunk native vlan 4 
  switchport mode trunk 
  switchport voice vlan 100 
  snmp trap mac-notification added 
  snmp trap mac-notification removed 

2950
^^^^

Those switches are now supported using 802.1X for networks with or without VoIP. 
You can also use port-security with static MAC address but we can not secure 
a MAC on the data VLAN specifically so enable it if there is no VoIP, use 
linkUp/linkDown and MAC notification otherwise.So on setup that needs to 
handle VoIP with this switch, go with a 802.1X configuration. 

802.1X
++++++

[WARNING]
====
Make sure that you have a local account, because enabling 802.1X or MAB will ask for a username and password on the next login.
====

Global config settings:

  dot1x system-auth-control 

AAA configuration:

  aaa new-model 
  aaa group server radius packetfence 
   server 192.168.1.5 auth-port 1812 acct-port 1813 
  aaa authentication login default local 
  aaa authentication dot1x default group packetfence 
  aaa authorization network default group packetfence

AAA configuration (accounting):

----
aaa accounting dot1x default start-stop group packetfence
----

RADIUS server configuration:

  radius-server host 192.168.1.5 auth-port 1812 acct-port 1813 timeout 2 
  key useStrongerSecret 
  radius-server vsa send authentication 

On each interface _without VoIP_:

  switchport access vlan 4 
  switchport mode access 
  dot1x port-control auto 
  dot1x host-mode multi-host 
  dot1x reauthentication 

On each interface _with VoIP_:

  switchport access vlan 4 
  switchport mode access 
  switchport voice vlan 100 
  dot1x port-control auto 
  dot1x host-mode multi-host 
  dot1x reauthentication 

Port-Security 
+++++++++++++

CAUTION: With port-security, if no MAC is connected on ports when activating port-security, we need 
to secure bogus MAC addresses on ports in order for the switch to send a trap when a new 
MAC appears on a port. On the other hand, if a MAC is actually connected when you enable 
port security, you must secure this MAC rather than the bogus one. Otherwise this MAC will 
lose its connectivity instantly. 

Global config settings _without VoIP_:

  snmp-server enable traps port-security 
  snmp-server enable traps port-security trap-rate 1 
  snmp-server host 192.168.1.5 version 2c public port-security 

On each interface _without VoIP_:

  switchport mode access 
  switchport access vlan 4 
  switchport port-security 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.0000.00xx 

where `xx` stands for the interface `ifIndex`.

[NOTE]
.ifIndex mapping
===========================================================================
Use the following templates for interface `IfIndex` in bogus MAC addresses 
(0200.0000.00xx):

* Fa0/1, ..., Fa0/48 => 1, ..., 48 
* Gi0/1, Gi0/2 => 49, 50 
===========================================================================

Global config settings _with VoIP_:

  snmp-server community public RO
  snmp-server community private RW
  snmp-server enable traps snmp linkdown linkup 
  snmp-server enable traps mac-notification 
  snmp-server host 192.168.1.5 trap version 2c public snmp mac-notification 
  mac-address-table notification interval 0 
  mac-address-table notification 
  mac-address-table aging-time 3600 

On each interface _with VoIP_:

  switchport voice vlan 100 
  switchport access vlan 4 
  switchport mode access 
  snmp trap mac-notification added 
  snmp trap mac-notification removed 

3550 (802.1X with MAB)
^^^^^^^^^^^^^^^^^^^^^^

CAUTION: The Catalyst 3550 does *not* support 802.1X with Multi-Domain, it can only support 802.1X with MAB using Multi-Host, MAB, and port security. 

CAUTION: The Catalyst 3550 does *not* support CoA. https://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst3750/software/release/12-2_55_se/release/notes/OL23054.html[Minimal IOS required for CoA is 12.2(52)SE]. Latest available IOS for 3550 is 12.2(46)SE. Set "Deauthentication Method" to "SNMP" in PacketFence Administration GUI under Network-> Switches for the switch IP configured below.

Global settings:
++++++++++++++++

  dot1x system-auth-control 
  aaa new-model 
  aaa group server radius packetfence 
   server 192.168.1.5 auth-port 1812 acct-port 1813
  aaa authentication login default local 
  aaa authentication dot1x default group packetfence 
  aaa authorization network default group packetfence 

RADIUS server configuration:

  radius-server host 192.168.1.5 auth-port 1812 acct-port 1813 timeout 2 key useStrongerSecret 
  radius-server vsa send authentication 

Enable SNMP on the switch:

  snmp-server community public RO
  snmp-server community private RW

On each interface:

  switchport mode access
  dot1x mac-auth-bypass
  dot1x pae authenticator
  dot1x port-control auto
  dot1x violation-mode protect
  dot1x timeout quiet-period 2
  dot1x timeout reauth-period 7200
  dot1x timeout tx-period 3
  dot1x reauthentication

2960 
^^^^

CAUTION: For 802.1X and MAB configurations, refer to <<Catalyst_RADIUS,this section below>>.

Port­Security for IOS earlier than 12.2(46)SE  
+++++++++++++++++++++++++++++++++++++++++++++

Global config settings:

  snmp-server community public RO
  snmp-server community private RW
  snmp-server enable traps port-security 
  snmp-server enable traps port-security trap-rate 1 
  snmp-server host 192.168.1.5 version 2c public port-security 

On each interface _without VoIP_: 

  switchport access vlan 4 
  switchport port-security 
  switchport port-security maximum 1 vlan access 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.000x.xxxx 

where `xxxxx` stands for the interface `ifIndex` 

On each interface with VoIP:

  switchport voice vlan 100 
  switchport access vlan 4 
  switchport port-security 
  switchport port-security maximum 2 
  switchport port-security maximum 1 vlan access 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.000x.xxxx 

where `xxxxx` stands for the interface `ifIndex` 

[NOTE]
.ifIndex mapping
===========================================================================
Use the following templates for interface `IfIndex` in bogus MAC addresses 
(0200.000x.xxxx):

* Fa0/1...Fa0/48 -> 10001...10048 
* Gi0/1...Gi0/48 -> 10101...10148 
===========================================================================

Port­Security for IOS 12.2(46)SE or greater
+++++++++++++++++++++++++++++++++++++++++++

Since version PacketFence 2.2.1, the way to handle VoIP when using 
port-security dramatically changed. Ensure that you follow the instructions 
below. To make the story short, instead on relying on the dynamic 
MAC learning for VoIP, we use a static entry on the voice VLAN so we can trigger a new security 
violation, and then authorize the phone MAC address on the network. 

Global config settings:

  snmp-server community public RO
  snmp-server community private RW
  snmp-server enable traps port-security 
  snmp-server enable traps port-security trap-rate 1 
  snmp-server host 192.168.1.5 version 2c public port-security 

On each interface _without VoIP_:

  switchport access vlan 4 
  switchport port-security 
  switchport port-security maximum 1 vlan access 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.000x.xxxx 

where `xxxxx` stands for the interface `ifIndex`

On each interface _with VoIP_: 

  switchport voice vlan 100 
  switchport access vlan 4 
  switchport port-security 
  switchport port-security maximum 2 
  switchport port-security maximum 1 vlan access 
  switchport port-security maximum 1 vlan voice 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.010x.xxxx vlan voice 
  switchport port-security mac-address 0200.000x.xxxx vlan access 

where `xxxxx` stands for the interface `ifIndex` 

[NOTE]
.ifIndex mapping
===========================================================================
Use the following templates for interface `IfIndex` in bogus MAC addresses
(0200.000x.xxxx):

* Fa0/1...Fa0/48 -> 10001...10048 
* Gi0/1...Gi0/48 -> 10101...10148 
===========================================================================

[[Catalyst_RADIUS]]
2960, 2970, 3560, 3750
^^^^^^^^^^^^^^^^^^^^^^

NOTE: You shouldn't use any port-security features when doing 802.1X and/or Mac Authentication. This can cause unexpected behavior.

[WARNING]
====
Make sure that you have a local account, because enabling 802.1X or MAB will ask for a username and password on the next login.
====

Global settings:
++++++++++++++++

  dot1x system-auth-control 
  aaa new-model 
  aaa group server radius packetfence 
   server name pfnac
  aaa authentication login default local 
  aaa authentication dot1x default group packetfence 
  aaa authorization network default group packetfence 

RADIUS server configuration:

  radius server pfnac
    address ipv4 192.168.1.5 auth-port 1812 acct-port 1813
    automate-tester username dummy ignore-acct-port idle-time 3
    key 0 useStrongerSecret
  
  radius-server vsa send authentication 

CoA configuration

  aaa server radius dynamic-author
   client 192.168.1.5 server-key useStrongerSecret
   port 3799

Activate SNMP v1 on the switch:

  snmp-server community public RO

802.1X with MAC Authentication bypass (Multi­Domain) 
++++++++++++++++++++++++++++++++++++++++++++++++++++

On each interface:

  switchport mode access 
  switchport voice vlan 100
  authentication host-mode multi-domain 
  authentication order dot1x mab 
  authentication priority dot1x mab 
  authentication port-control auto 
  authentication periodic 
  authentication timer restart 10800 
  authentication timer reauthenticate 10800 
  authentication violation replace
  mab 
  no snmp trap link-status 
  dot1x pae authenticator 
  dot1x timeout quiet-period 2 
  dot1x timeout tx-period 3 

802.1X with MAC Authentication bypass (Multi­Host)
++++++++++++++++++++++++++++++++++++++++++++++++++

On each interface:

  switchport mode access 
  authentication order dot1x mab 
  authentication priority dot1x mab 
  authentication port-control auto 
  authentication periodic 
  authentication timer restart 10800 
  authentication timer reauthenticate 7200 
  authentication violation replace
  mab 
  no snmp trap link-status 
  dot1x pae authenticator 
  dot1x timeout quiet-period 2 
  dot1x timeout tx-period 3 

MAC Authentication bypass only 
++++++++++++++++++++++++++++++

On each interface:

  switchport mode access 
  switchport voice vlan 100 
  dot1x mac-auth-bypass 
  dot1x pae authenticator 
  dot1x port-control auto 
  dot1x timeout tx-period 5 
  dot1x reauthentication 
  authentication periodic 
  authentication timer restart 10800 
  authentication timer reauthenticate 7200 
  authentication violation replace
  mab 
  no snmp trap link-status 

[NOTE]
.802.1X on various models of 2960
============================================================================
There's a lot of different versions of the Catalyst 2960. Some of them
may not accept the command stated in this guide for 802.1X.

We have found a couple of commands that are working great or MAB:

On each interface

  switchport mode access
  authentication order mab
  authentication port-control auto
  mab
  dot1x pae authenticator

But, as it is difficult for us to maintain the whole list of commands to 
configure each and every different model of 2960 with different IOS, 
please refer to Cisco documentation for very specific cases.
============================================================================

Port-­Security 
++++++++++++++

Global config settings 

  snmp-server community public RO
  snmp-server community private RW
  snmp-server enable traps port-security 
  snmp-server enable traps port-security trap-rate 1 
  snmp-server host 192.168.1.5 version 2c public port-security 

On each interface _without VoIP_: 

  switchport access vlan 4 
  switchport port-security 
  switchport port-security maximum 1 vlan access 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.000x.xxxx 

where `xxxxx` stands for the interface `ifIndex` 

On each interface _with VoIP_: 

  switchport voice vlan 100 
  switchport access vlan 4 
  switchport port-security 
  switchport port-security maximum 2 
  switchport port-security maximum 1 vlan access 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.000x.xxxx 

where `xxxxx` stands for the interface `ifIndex` 

[NOTE]
.ifIndex mapping
===========================================================================
Use the following templates for interface `IfIndex` in bogus MAC addresses
(0200.000x.xxxx):

* Fa0/1...Fa0/48 -> 10001...10048 
* Gi0/1...Gi0/48 -> 10101...10148 
===========================================================================

Web auth
++++++++

The Catalyst 2960 supports web authentication from IOS 12.2.55SE3. This procedure has been tested on IOS 15.0.2SE5.

In this example, the ACL that triggers the redirection to the portal for registration is 'registration'.

Configure the global configuration of the switch using the section __MAC Authentication bypass only__ of the 2960 in this document.

Then add this additional configuration on the global level

  ip device tracking
  ip http server
  ip http secure-server
  snmp-server community public RO
  snmp-server community private RW

Add the required access lists

  ip access-list extended registration
   deny ip any host <your captive portal ip> 
   permit tcp any any eq www
   permit tcp any any eq 443

Then on each controlled interface

   switchport access vlan <vlan> 
   switchport mode access
   authentication priority mab
   authentication port-control auto
   authentication periodic
   authentication violation replace
   mab
   spanning-tree portfast

PacketFence switch configuration 

* Select the type to 'Cisco Catalyst 2960'
* Set the 'Registration' role to 'registration' (If left empty then it will use the role name)
* Set Role by Web Auth URL for registration to 'http://<your_captive_portal_ip>/Cisco::Catalyst_2960'
* The URL can contain dynamic parameters, like the MAC address ($mac), the switch IP ($switch_ip), the username ($user_name).
* Screenshots of this configuration are available in the Cisco WLC section of this guide.

Downloadable ACLs
+++++++++++++++++

The Catalyst 2960 supports RADIUS pushed ACLs which means that you can define the ACLs centrally in PacketFence without configuring them in your switches and their rules will be applied to the switch during the authentication.

These ACLs are defined by role like the VLANs which means you can define different ACLs for your registration VLAN, production VLAN, guest VLAN, etc.

Add the following configuration setting on the global level 

   ip device tracking

For IOS 12.2, you need to create this acl and assign it to the switch port interface:

 ip access-list extended Auth-Default-ACL
  permit udp any range bootps 65347 any range bootpc 65348
  permit udp any any range bootps 65347
  permit udp any any eq domain
  deny   ip any any

 interface GigabitEthernetx/y/z
  ...
  ip access-group Auth-Default-ACL in
  ...

Before continuing, configure your switch to be in MAC authentication bypass or 802.1X.

Now in the PacketFence interface go in the switch configuration and in the Roles tab.

Check 'Role by access list' and you should now be able to configure the access lists as below.

For example if you want the users that are in the registration VLAN to only use HTTP, HTTPS, DNS and DHCP you can configure this ACL in the registration category.

image::cisco-downloadable-acl-reg.png[scaledwidth="100%",alt="Registration ACL"]

Now if for example, your normal users are placed in the 'default' category and your guests in the 'guest' category.

If for example the 'default' category uses the network 192.168.5.0/24 and your guest network uses the network 192.168.10.0/24.

You can prevent communications between both networks using these access lists

image::cisco-downloadable-acl-cross-network.png[scaledwidth="100%",alt="Cross network deny ACL"]

You could also only prevent your guest users from using shared directories

image::cisco-downloadable-acl-deny-shares.png[scaledwidth="100%",alt="Deny shares ACL"]

Or also you could restrict your users to use only your DNS server where 192.168.5.2 is your DNS server

image::cisco-downloadable-acl-force-dns.png[scaledwidth="100%",alt="Force DNS ACL"]


Web auth and Downloadable ACLs
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

It's possible to mix web authentication and downloadable ACLs starting from version 12.2 of the IOS, each roles can be configured to forward the device to the captive portal for an http or an https and only allow specific traffic with the ACL.
To do that, you need to configure PacketFence with Role by Web Auth URL and with Role by access list (For each role you need).
On the switch you need to change the Auth-Default-ACL to add the portal IP address:

For IOS 12.2:

  ip access-list extended Auth-Default-ACL
   permit udp any range bootps 65347 any range bootpc 65348
   permit udp any any range bootps 65347
   permit ip any host ip_of_the_captive_portal
   permit udp any any eq domain
   deny   ip any any

And assign this ACL on the switch port yo want to do ACL per port.

 interface GigabitEthernetx/y/z
  ...
  ip access-group Auth-Default-ACL in
  ...

For IOS 15.0:

  Extended IP access list Auth-Default-ACL
    10 permit udp any range bootps 65347 any range bootpc 65348
    20 permit udp any any range bootps 65347
    30 deny ip any any

  conf t
  ip access-list extend  Auth-Default-ACL
  21 permit ip any host ip_of_the_captive_portal

For IOS 15.2:

  Extended IP access list Auth-Default-ACL
      10 permit udp any any eq domain
      20 permit tcp any any eq domain
      30 permit udp any eq bootps any
      40 permit udp any any eq bootpc
      50 permit udp any eq bootpc any
      60 deny ip any any

  conf t
  ip access-list extend  Auth-Default-ACL
  51 permit ip any host ip_of_the_captive_portal


Stacked 29xx, Stacked 35xx, Stacked 3750, 4500 Series, 6500 Series
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The 4500 Series and all the stacked switches work exactly the same way as if they were not stacked so the configuration is the same: they support port-security with static MAC address and allow us to secure a MAC on the data VLAN so we enable it whether there is VoIP or not. 

We need to secure bogus MAC addresses on ports in order for the switch to send a trap when a new MAC appears on a port. 

Global config settings 

  snmp-server community public RO
  snmp-server community private RW
  snmp-server enable traps port-security 
  snmp-server enable traps port-security trap-rate 1 
  snmp-server host 192.168.1.5 version 2c public port-security 

On each interface _without VoIP_: 

  switchport access vlan 4 
  switchport port-security 
  switchport port-security maximum 1 vlan access 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.000x.xxxx 

On each interface _with VoIP_: 

  switchport voice vlan 100 
  switchport access vlan 4 
  switchport port-security 
  switchport port-security maximum 2 
  switchport port-security maximum 1 vlan access 
  switchport port-security violation restrict 
  switchport port-security mac-address 0200.000x.xxxx 

where `xxxxx` stands for the interface `ifIndex` 

[NOTE]
.ifIndex mapping
===========================================================================
Use the following templates for interface `IfIndex` in bogus MAC addresses
(0200.000x.xxxx):

* Fa1/0/1...Fa1/0/48 -> 10001...10048 
* Gi1/0/1...Gi1/0/48 -> 10101...10148 
* Fa2/0/1...Fa2/0/48 -> 10501...10548 
* Gi2/0/1...Gi2/0/48 -> 10601...10648 
* Fa3/0/1...Fa3/0/48 -> 11001...11048 
* Gi3/0/1...Gi3/0/48 -> 11101...11148 
* Fa4/0/1...Fa4/0/48 -> 11501...11548 
* Gi4/0/1...Gi4/0/48 -> 11601...11648 
* ... 
===========================================================================

IOS XE Switches
^^^^^^^^^^^^^^^

PacketFence supports the IOS XE switches in MAC Authentication Bypass, 802.1X and web authentication.

MAC Authentication Bypass
+++++++++++++++++++++++++

Global config settings:

  dot1x system-auth-control 

On each interface:

  authentication host-mode multi-domain
  authentication order mab
  authentication priority mab
  authentication port-control auto
  authentication periodic
  authentication timer restart 10800
  authentication timer reauthenticate 10800
  authentication violation replace
  mab
  no snmp trap link-status
  dot1x pae authenticator
  dot1x timeout quiet-period 2
  dot1x timeout tx-period 3

AAA groups and configuration:

  aaa new-model 
  aaa group server radius packetfence 
   server 192.168.1.5 auth-port 1812 acct-port 1813 
  aaa authentication login default local 
  aaa authentication dot1x default group packetfence 
  aaa authorization network default group packetfence 

RADIUS server configuration:

  radius-server host 192.168.1.5 auth-port 1812 acct-port 1813 timeout 2 key useStrongerSecret 
  radius-server vsa send authentication 

CoA configuration:

  aaa server radius dynamic-author
   client 192.168.1.5 server-key useStrongerSecret
  port 3799
  
Activate SNMP on the switch:

  snmp-server community public RO


802.1X only
+++++++++++

Follow the same configuration as for MAC Authentication Bypass but change the `authentication priority` line with the following: 

  authentication priority dot1x

802.1X with MAC Authentication fallback
+++++++++++++++++++++++++++++++++++++++

Follow the same configuration as for MAC Authentication Bypass but change the `authentication priority` line with the following:

  authentication priority dot1x mab

Web auth
++++++++

Web auth requires at least MAC Authentication Bypass to be activated on the switchport but can also work with 802.1X. Configure your switchports as you would usually do, then add the following access lists.

  ip access-list extended redirect
   deny   ip any host 192.168.1.5
   deny   udp any any eq domain
   deny   tcp any any eq domain
   deny   udp any any eq bootpc
   deny   udp any any eq bootps
   permit tcp any any eq www
   permit tcp any any eq 443
  ip access-list extended registered
   permit ip any any

Global config settings:

 ip device tracking

PacketFence switch configuration:

* Select the type to 'Cisco Catalyst 2960'
* Set the 'Registration' role to 'registration' (If left empty then it will use the role name)
* Set Role by Web Auth URL for registration to 'http://<your_captive_portal_ip>/Cisco::Catalyst_2960'
* The URL can contain dynamic parameters, like the MAC address ($mac), the switch IP ($switch_ip), the username ($user_name).
* Screenshots of this configuration are available in the Cisco WLC section of this guide.

NOTE: AAA authentication is slow to come up after a reload of the IOS XE switches. This makes the recovery from a reboot longer to complete. This is due to a bug in IOS XE. A workaround is to execute the following command `no aaa accounting system default start-stop group tacacs+`.

Identity Networking Policy
++++++++++++++++++++++++++

Starting from version 15.2(1)E (IOS) and 3.4.0E (IOSXE) , Cisco introduced the Identity Based Networking Services.
It means that you can create an authentication workflow on the switch and create interfaces templates.

To enable it:

 authentication display new-style

Global config settings:

  dot1x system-auth-control 

AAA groups and configuration:

  aaa new-model 
  aaa group server radius packetfence 
   server name packetfence
  !
  aaa authentication login default local 
  aaa authentication dot1x default group packetfence 
  aaa authorization network default group packetfence 
  radius-server vsa send authentication

RADIUS server configuration:

  radius-server dead-criteria time 5 tries 4
  radius-server deadtime 1
  radius server packetfence
   address ipv4 192.168.1.5 auth-port 1812 acct-port 1813
   key useStrongerSecret
   automate-tester username cisco ignore-acct-port idle-time 1

CoA configuration:

  aaa server radius dynamic-author
   client 192.168.1.5 server-key useStrongerSecret
  port 3799

Enable SNMP on the switch:

  snmp-server community public RO

Enable HTTP and HTTPS server:

  ip http server
  ip http secure-server

Enable IP device tracking:

  ip device tracking

Fallback ACL:

 ip access-list extended ACL-CRITICAL-V4
  permit ip any any

Service Template:

 service-template DEFAULT_LINKSEC_POLICY_MUST_SECURE
 service-template DEFAULT_LINKSEC_POLICY_SHOULD_SECURE
 service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
  voice vlan
 service-template CRITICAL_AUTH_VLAN
 service-template CRITICAL-ACCESS
  description *Fallback Policy on AAA Fail*
  access-group ACL-CRITICAL-V4
 !

Class map:

 class-map type control subscriber match-any IN_CRITICAL_AUTH
 match activated-service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
 match activated-service-template CRITICAL_AUTH_VLAN
 match activated-service-template CRITICAL-ACCESS
 !
 class-map type control subscriber match-none NOT_IN_CRITICAL_AUTH
 match activated-service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
 match activated-service-template CRITICAL_AUTH_VLAN
 match activated-service-template CRITICAL-ACCESS
 !
 class-map type control subscriber match-all AAA_SVR_DOWN_UNAUTHD_HOST
 match result-type aaa-timeout
 match authorization-status unauthorized
 !
 class-map type control subscriber match-all AAA_SVR_DOWN_AUTHD_HOST
 match result-type aaa-timeout
 match authorization-status authorized
 !
 class-map type control subscriber match-all DOT1X_NO_RESP
 match method dot1x
 match result-type method dot1x agent-not-found
 !
 class-map type control subscriber match-all MAB_FAILED
 match method mab
 match result-type method mab authoritative
 !
 class-map type control subscriber match-all DOT1X_FAILED
 match method dot1x
 match result-type method dot1x authoritative

Policy map:

On the 3 following configurations if the RADIUS server is down then we will apply
 CRITICAL_AUTH_VLAN, DEFAULT_CRITICAL_VOICE_TEMPLATE and CRITICAL-ACCESS service template.
If the RADIUS server goes up then it reinitializes the authentication if the port is in
IN_CRITICAL_VLAN.

for 802.1X with MAC Authentication fallback:

 policy-map type control subscriber DOT1X_MAB
  event session-started match-all
   10 class always do-until-failure
    10 authenticate using dot1x priority 10
  event authentication-failure match-first
   5 class DOT1X_FAILED do-until-failure
    10 terminate dot1x
    20 authenticate using mab priority 20
   10 class AAA_SVR_DOWN_UNAUTHD_HOST do-until-failure
    10 activate service-template CRITICAL_AUTH_VLAN
    20 activate service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
    30 activate service-template CRITICAL-ACCESS
    40 authorize
    50 pause reauthentication
   20 class AAA_SVR_DOWN_AUTHD_HOST do-until-failure
    10 activate service-template CRITICAL_AUTH_VLAN
    20 activate service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
    30 activate service-template CRITICAL-ACCESS
    40 pause reauthentication
    50 authorize
   30 class DOT1X_NO_RESP do-until-failure
    10 terminate dot1x
    20 authenticate using mab priority 20
   40 class MAB_FAILED do-until-failure
    10 terminate mab
    20 authentication-restart 10800
   60 class always do-until-failure
    10 terminate dot1x
    20 terminate mab
    30 authentication-restart 10800
  event agent-found match-all
   10 class always do-until-failure
    10 terminate mab
    20 authenticate using dot1x priority 10
  event aaa-available match-all
   10 class IN_CRITICAL_AUTH do-until-failure
    10 clear-session
   20 class NOT_IN_CRITICAL_AUTH do-until-failure
    10 resume reauthentication
  event inactivity-timeout match-all
   10 class always do-until-failure
    10 clear-session
  event authentication-success match-all
   10 class always do-until-failure
    10 activate service-template DEFAULT_LINKSEC_POLICY_SHOULD_SECURE
  event violation match-all
   10 class always do-all
    10 replace

for MAC Authentication only:

  policy-map type control subscriber MACAUTH
   event session-started match-all
    10 class always do-until-failure
     10 authenticate using mab priority 10
   event authentication-failure match-first
    10 class AAA_SVR_DOWN_UNAUTHD_HOST do-until-failure
     10 activate service-template CRITICAL_AUTH_VLAN
     20 activate service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
     30 activate service-template CRITICAL-ACCESS
     40 authorize
     50 pause reauthentication
    20 class AAA_SVR_DOWN_AUTHD_HOST do-until-failure
     10 activate service-template CRITICAL_AUTH_VLAN
     20 activate service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
     30 activate service-template CRITICAL-ACCESS
     40 pause reauthentication
     50 authorize
    30 class always do-until-failure
     10 terminate mab
     20 authentication-restart 30
   event aaa-available match-all
    10 class IN_CRITICAL_AUTH do-until-failure
     10 clear-session
    20 class NOT_IN_CRITICAL_AUTH do-until-failure
     10 resume reauthentication
   event inactivity-timeout match-all
    10 class always do-until-failure
     10 clear-session
   event authentication-success match-all
    10 class always do-until-failure
     10 activate service-template DEFAULT_LINKSEC_POLICY_SHOULD_SECURE

for 802.1X only:

  policy-map type control subscriber DOT1X
   event session-started match-all
    10 class always do-until-failure
     10 authenticate using dot1x priority 10
   event authentication-failure match-first
    10 class AAA_SVR_DOWN_UNAUTHD_HOST do-until-failure
     10 activate service-template CRITICAL_AUTH_VLAN
     20 activate service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
     30 activate service-template CRITICAL-ACCESS
     40 authorize
     50 pause reauthentication
    20 class AAA_SVR_DOWN_AUTHD_HOST do-until-failure
     10 activate service-template CRITICAL_AUTH_VLAN
     20 activate service-template DEFAULT_CRITICAL_VOICE_TEMPLATE
     30 activate service-template CRITICAL-ACCESS
     40 pause reauthentication
     50 authorize
    30 class DOT1X_FAILED do-until-failure
     10 terminate dot1x
    40 class DOT1X_NO_RESP do-until-failure
     10 terminate dot1x
    60 class always do-until-failure
     10 terminate dot1x
     20 authentication-restart 10800
   event agent-found match-all
    10 class always do-until-failure
     10 authenticate using dot1x priority 10
   event aaa-available match-all
    10 class IN_CRITICAL_AUTH do-until-failure
     10 clear-session
    20 class NOT_IN_CRITICAL_AUTH do-until-failure
     10 resume reauthentication
   event inactivity-timeout match-all
    10 class always do-until-failure
     10 clear-session
   event authentication-success match-all
    10 class always do-until-failure
     10 activate service-template DEFAULT_LINKSEC_POLICY_SHOULD_SECURE

Interface Template (802.1X MAC Authentication):

  template identity-template-mab
   dot1x pae authenticator
   spanning-tree portfast edge
   switchport access vlan 1
   switchport mode access
   switchport voice vlan 100
   mab
   access-session host-mode multi-domain
   access-session control-direction in
   access-session closed
   access-session port-control auto
   authentication periodic
   authentication timer reauthenticate server
   service-policy type control subscriber DOT1X_MAB

Interface Template (MAC Authentication):

  template identity-template-macauth
   dot1x pae authenticator
   spanning-tree portfast edge
   switchport access vlan 1
   switchport mode access
   switchport voice vlan 100
   mab
   access-session host-mode single-host
   access-session control-direction in
   access-session closed
   access-session port-control auto
   authentication periodic
   authentication timer reauthenticate server
   service-policy type control subscriber MACAUTH

Interface Template (802.1X):

  template identity-template-dot1x
   dot1x pae authenticator
   spanning-tree portfast edge
   switchport access vlan 1
   switchport mode access
   switchport voice vlan 100
   mab
   access-session host-mode single-host
   access-session control-direction in
   access-session closed
   access-session port-control auto
   authentication periodic
   authentication timer reauthenticate server
   service-policy type control subscriber DOT1X

On each interface for 802.1X with MAC Authentication:

  source template identity-template-mab
  dot1x timeout tx-period 5

On each interface for MAC Authentication:

  source template identity-template-macauth

On each interface for 802.1X:

  source template identity-template-dot1x
  dot1x timeout tx-period 5

To see what is the status of a port let's run:

 sh access-session interface fastEthernet 0/2 details
            Interface:  FastEthernet0/2
          MAC Address:  101f.74b2.f6a5
         IPv6 Address:  Unknown
         IPv4 Address:  172.20.20.49
            User-Name:  ACME\bob
               Status:  Authorized
               Domain:  DATA
       Oper host mode:  multi-domain
     Oper control dir:  in
      Session timeout:  12380s (server), Remaining: 12206s
       Timeout action:  Terminate
    Common Session ID:  AC1487290000000C000F8B7A
      Acct Session ID:  Unknown
               Handle:  0x9C000001
       Current Policy:  DOT1X_MAB

 Local Policies:
     Service Template: DEFAULT_LINKSEC_POLICY_SHOULD_SECURE (priority 150)

 Server Policies:
           Vlan Group:  Vlan: 20
         Idle timeout:  30 sec


 Method status list:
        Method           State

        dot1x            Authc Success

Debug command:

In order to be able to debug the Identity Networking Policy you can launch the following command in the switch cli:

 term mon
 debug pre all

DHCP Option 82
++++++++++++++

In order to enable the DHCP Option 82, you need to add the following parameters.
Let's say you want to enable it for the vlan 1 to 1024:

 ip dhcp snooping
 ip dhcp snooping vlan 1-1024

On uplink interfaces:

 ip dhcp snooping trust
 

Router ISR 1800 Series 
++++++++++++++++++++++

PacketFence supports the 1800 series Router with linkUp / linkDown traps. It cannot do 
anything about the router interfaces (ie: fa0 and fa1 on a 1811). VLAN interfaces `ifIndex` should 
also be marked as uplinks in the PacketFence switch configuration as they generate traps but 
are of no interest to PacketFence (layer 3). 

Global config settings: 

  snmp-server enable traps snmp linkdown linkup 
  snmp-server host 192.168.1.5 trap version 2c public 

On each interface: 

  switchport mode access 
  switchport access vlan 4 

EAP-FAST authentication Support
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

PacketFence supports Cisco NEAT through EAP-MD5, EAP-FAST, EAP-GTC and EAP-MSCHAPv2 authentication methods. Upon successful authentication against PacketFence, the authenticator switch will give trunk access to the supplicant switch. 

Here is an official Cisco guide, from which the following configuration derives: https://www.cisco.com/c/en/us/support/docs/lan-switching/8021x/116681-config-neat-cise-00.html

The following configuration example contains required changes to be applied on both authenticator and supplicant switches to provide EAP-FAST authentication against PacketFence.

Authenticator
+++++++++++++

Global settings:

 aaa group server radius packetfence
  server 192.168.1.5 auth-port 1812 acct-port 1813
 aaa authentication dot1x default group packetfence
 aaa authorization network default group packetfence 

 cisp enable

Uplink configuration:

 interface FastEthernet0/20
  switchport mode access
  authentication port-control auto
  dot1x pae authenticator

Supplicant
++++++++++

Global settings (replace username and password): 
  
 cisp enable

 eap profile EAP_PRO
  method fast

 dot1x credentials EAP_PRO
  username switches
  password 7 03174C02120C29495D
 ! Password is switches
 !
 dot1x supplicant force-multicast

Uplink settings:

 interface GigabitEthernet1/0/24
  switchport mode trunk
  dot1x pae supplicant
  dot1x credentials EAP_PRO
  dot1x supplicant eap profile EAP_PRO  

Device Sensor for Cisco Equipment
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Device sensor is a way to be able to receive some information about endpoints from the RADIUS accounting packet. (like DHCP, CDP, LLDP and HTTP information)
In order to enable Device Sensor feature, you need to add the following parameters to your switch configuration:

 radius server packetfence
 address ipv4 192.168.1.5 auth-port 1812 acct-port 1813
  key useStrongerSecret

 aaa group server radius packetfence
  server name packetfence
 !
 aaa accounting update newinfo
 aaa accounting identity default start-stop group packetfence
 !
 !
 device-sensor filter-list dhcp list dhcp-list
  option name host-name
  option name parameter-request-list
  option name class-identifier
 !
 device-sensor filter-list lldp list lldp-list
  tlv name system-description
 !
 device-sensor filter-list cdp list cdp-list
  tlv name version-type
  tlv name platform-type
 !
 device-sensor filter-list dhcp list lldp-list
 device-sensor filter-spec dhcp include list dhcp-list
 device-sensor filter-spec lldp include list lldp-list
 device-sensor filter-spec cdp include list cdp-list
 device-sensor notify all-changes

This configuration will make the switch send information about DHCP, LLDP and CDP of the endpoint in the RADIUS accounting packets.

Cisco Small Business (SMB)
~~~~~~~~~~~~~~~~~~~~~~~~~~

The Cisco Small Business switches support MAC based authentication (MAB) as well as 802.1X and VoIP. Both technologies can be combined and will work correctly together on the same switchport.

Nothing is required to activate VoIP on the switch, you must simply configure the voice VLAN you want PacketFence to assign in the PacketFence switch configuration as well as enabling VoIP there. Note that your phones must *not* tag their packets on the network and should send their traffic untagged when connected into a PacketFence enabled port. This means you should not have the voice VLAN capabilities enabled on the switch itself as they might conflict with the authorization attributes returned by PacketFence.

Global configuration
^^^^^^^^^^^^^^^^^^^^

CAUTION: Before executing these steps, make sure you have a local account configured to login on the switch or are pointing to a RADIUS server for management. Otherwise, you will not be able to login into the switch anymore.

You must first define your RADIUS server and point it to PacketFence:

  dot1x system-auth-control 
  radius-server key useStrongerSecret
  radius-server host 192.168.1.5

  aaa accounting dot1x start-stop group radius

  snmp-server community public ro view Default 
  snmp-server community private rw view Default 

SNMP configuration for the Cisco SG300:

  snmp-server community public ro view DefaultSuper
  snmp-server community private rw view DefaultSuper

MAC Authentication
^^^^^^^^^^^^^^^^^^

In order to configure MAC authentication, you must enable it on each interface

  interface x/y/z
   dot1x host-mode multi-sessions 
   dot1x reauthentication 
   dot1x timeout quiet-period 10 
   dot1x timeout server-timeout 5 
   dot1x timeout supp-timeout 3 
   dot1x authentication mac 
   dot1x radius-attributes vlan 
   dot1x port-control auto 
   spanning-tree portfast 
   switchport mode general 
   switchport general pvid 2 

802.1X with MAB
^^^^^^^^^^^^^^^

In order to configure 802.1X with a fall-back to MAC authentication, you must enable it on each interface

  interface x/y/z
   dot1x host-mode multi-sessions 
   dot1x reauthentication 
   dot1x timeout quiet-period 10 
   dot1x timeout server-timeout 5 
   dot1x timeout supp-timeout 3 
   dot1x authentication dot1x mac 
   dot1x radius-attributes vlan 
   dot1x port-control auto 
   spanning-tree portfast 
   switchport mode general 
   switchport general pvid 2 

Once you have configured your switchports, you must configure the switch in PacketFence with the following information:

* 'Definition->Type': `Cisco SG500`
* 'Definition->Mode': `production`
* 'Definition->Deauthentication Method': `SNMP`
* 'Definition->VoIP' enabled if you need VoIP on this switch.
* 'Roles->voice VLAN' set to the VLAN you want to assign to the VoIP devices connecting to this switch.
* 'RADIUS->Secret Passphrase': `useStrongerSecret`
* 'SNMP->Version': `v2c`
* 'SNMP->Community Read': `public`
* 'SNMP->Community Write': `private`


802.1X commands
^^^^^^^^^^^^^^^

  show dot1x
  show dot1x users


D-Link
~~~~~~

PacketFence supports D-Link switches without VoIP using two different trap types: 

* linkUp/linkDown 
* MAC Notification 

*We recommend to enable linkUp/linkDown and MAC notification together.*

Don't forget to update the startup config! 

DES3526 / 3550 
^^^^^^^^^^^^^^

Global config settings 

  To be contributed... 

On each interface: 

  To be contributed... 

DGS3100/3200 
^^^^^^^^^^^^

Enable MAC notification:

  enable mac_notification
  config mac_notification interval 1 historysize 1
  config mac_notification ports 1:1-1:24 enable

Enable linkup/linkdown notification:

  enable snmp traps 
  enable snmp linkchange_traps

Add SNMP host:

  create snmp host 192.168.1.5 v2c  public

Enable MAC base access control:

  enable mac_based_access_control
  config mac_based_access_control authorization attributes radius enable local disable
  config mac_based_access_control method radius
  config mac_based_access_control password useStrongerSecret
  config mac_based_access_control password_type manual_string
  config mac_based_access_control max_users no_limit
  config mac_based_access_control trap state enable
  config mac_based_access_control log state enable

On each interface: 

  config mac_based_access_control ports 1:1 state enable
  config mac_based_access_control ports 1:1 max_users 128
  config mac_based_access_control ports 1:1 aging_time 1440
  config mac_based_access_control ports 1:1 block_time 300
  config mac_based_access_control ports 1:1 mode host_based

Dell 
~~~~

NOTE: When doing MAC Authentication, there is a known issue with some Dell switches. If you get errors where the device is using EAP type MD5, but PacketFence is expecting PEAP, you will need to edit the line *default_eap_type = peap* under the section *eap* in the file */usr/local/pf/conf/radiusd/eap.conf* to *default_eap_type = md5*.

Force 10
^^^^^^^^

PacketFence supports this switch using RADIUS, MAC-Authentication and 802.1X.

Global config settings

  radius-server host 192.168.1.5 key s3cr3t auth-port 1812
 
MAB interface configuration:

  interface GigabitEthernet 0/1
   no ip address
   switchport
   dot1x authentication 
   dot1x mac-auth-bypass 
   dot1x auth-type mab-only 
   no shutdown

802.1X interface configuration:

  interface GigabitEthernet 0/1
   no ip address
   switchport
   dot1x authentication 
   no shutdown

PowerConnect 3424 
^^^^^^^^^^^^^^^^^

PacketFence supports this switch using linkUp/linkDown traps. 

Global config settings to define the RADIUS server

   configure
   radius-server host auth 10.34.200.30
   name PacketFence
   usage 802.1x
   key s3cr3t
   exit

Configure CoA

   aaa server radius dynamic-author
   client 10.34.200.30 server-key s3cr3t
   auth-type all
   exit

Enable authentication and globally enable 802.1x client authentication via RADIUS
   
   authentication enable
   aaa authentication dot1x default radius
   aaa authorization network default radius
   dot1x system-auth-control

(Optional)

   dot1x dynamic-vlan enable

On the interface, enable MAC based authentication mode, enable MAB, and set the order of authentication to 802.1X followed by MAC authentication. Also enable periodic re-authentication.

   interface te1/0/4
   dot1x port-control mac-based
   dot1x mac-auth-bypass
   authentication order dot1x mab
   dot1x reauthentication
   default mab pap
   exit

   authentication order mab
   authentication priority mab

N1500 Series Switch
^^^^^^^^^^^^^^^^^^^

PacketFence supports this switch using RADIUS, MAC-Authentication, 802.1x and VoIP

802.1X with MAC Authentication fallback and VoIP
++++++++++++++++++++++++++++++++++++++++++++++++

We assume that the switch ip is 192.168.1.254

First on the uplink add this configuration:

  dot1x port-control force-authorized
  switchport mode trunk
  switchport trunk allowed vlan 1-5,100


Global config settings

  configure
  vlan 2,3,4,5,100
  vlan 2
  name "Registration"
  vlan 3
  name "Isolation"
  vlan 4
  name "Mac detection"
  vlan 5
  name "Guest"
  vlan 100
  name "VoIP"

  authentication enable
  dot1x system-auth-control
  aaa authentication dot1x default radius
  aaa authorization network default radius
  dot1x dynamic-vlan enable
  voice vlan
  aaa server radius dynamic-author
  client 192.168.1.5 server-key "useStrongerSecret"
  exit
  radius-server host auth 192.168.1.5
  name "PacketFence"
  usage 802.1x
  key "useStrongerSecret"
  exit
  aaa server radius dynamic-author
  client 192.168.1.5 server-key "useStrongerSecret"
  exit

  snmp-server community "private" rw
  snmp-server community "public" ro

On each interface (not uplink)

  switchport voice detect auto
  switchport mode general
  switchport access vlan 10
  dot1x port-control mac-based
  dot1x reauthentication
  dot1x mac-auth-bypass
  authentication order mab
  authentication priority mab
  lldp transmit-tlv sys-desc sys-cap
  lldp transmit-mgmt
  lldp notification
  lldp med confignotification
  voice vlan 100
  exit


N2000 Series (N2024P)
^^^^^^^^^^^^^^^^^^^^^

This configuration was tested with firmware version 6.2.1.6

Global config settings:

Radius configuration:

  aaa authentication login "defaultList" local
  authentication enable
  dot1x system-auth-control
  aaa authentication dot1x default radius
  aaa authorization network default radius
  dot1x dynamic-vlan enable
  radius-server key "useStrongerSecret"
  radius-server host auth 192.168.1.5
  name "PacketFence"

802.1X interface configuration:

  interface Gi0/0/1
  switchport mode general
  switchport general allowed vlan add 1-3,100
  dot1x port-control mac-based
  dot1x unauth-vlan 2
  dot1x mac-auth-bypass
  authentication order mab dot1x
  voice vlan 100
  exit

Edge core
~~~~~~~~~

PacketFence supports Edge-corE switches without VoIP using linkUp/linkDown traps.

PacketFence also supports MAC authentication on the Edge-corE 4510

3526XA and 3528M 
^^^^^^^^^^^^^^^^

Global config settings 

  SNMP-server host 192.168.1.5 public version 2c udp-port 162 

4510
^^^^

Basic configuration
+++++++++++++++++++

----

network-access aging
snmp-server community private rw
snmp-server community public rw


radius-server 1 host 192.168.1.5 auth-port 1812 acct-port 1813 timeout 5 retransmit 2 key useStrongerSecret
radius-server key useStrongerSecret

----

On each controlled interface
++++++++++++++++++++++++++++

----

interface ethernet 1/8
 switchport allowed vlan add <your list of allowed vlans> untagged
 network-access max-mac-count 1
 network-access mode mac-authentication
!

----

Enterasys 
~~~~~~~~~

PacketFence supports Enterasys switches _without VoIP_ using two different trap types: 

* linkUp/linkDown 
* MAC Locking (Port Security with static MACs) 

*We recommend to enable MAC locking only.*

Don't forget to update the startup config! 

Matrix N3 
^^^^^^^^^

linkUp/linkDown traps are enabled by default so we disable them and enable MAC locking 
only. Also, by default this switch doesn't do an electrical low-level linkDown when setting the 
port to admin down. So we need to activate a global option called `forcelinkdown` to enable 
this behavior. Without this option, clients don't understand that they lost their connection and 
they never do a new DHCP on VLAN change. 

Global config settings 

  set snmp community public 
  set snmp targetparams v2cPF user public security-model v2c message-processing v2c 
  set snmp notify entryPF tag TrapPF 
  set snmp targetaddr tr 192.168.1.5 param v2cPF taglist TrapPF 
  set maclock enable 
  set forcelinkdown enable 

On each interface: 

  set port trap ge.1.xx disable 
  set maclock enable ge.1.xx 
  set maclock static ge.1.xx 1 
  set maclock firstarrival ge.1.xx 0 
  set maclock trap ge.1.xx enable 

where `xx` stands for the interface index.

SecureStack C2 
^^^^^^^^^^^^^^

linkUp/linkDown traps are enabled by default so we disable them and enable MAC locking 
only. 

Global config settings 

  set snmp community public 
  set snmp targetparams v2cPF user public security-model v2c message-processing v2c 
  set snmp notify entryPF tag TrapPF 
  set snmp targetaddr tr 192.168.1.5 param v2cPF taglist TrapPF 
  set maclock enable 

On each interface: 

  set port trap fe.1.xx disable 
  set maclock enable fe.1.xx 
  set maclock static fe.1.xx 1 
  set maclock firstarrival fe.1.xx 0 

where `xx` stands for the interface index 

SecureStack C3 
^^^^^^^^^^^^^^

This switch has the particular _feature_ of allowing more than one untagged egress VLAN per 
port. This means that you must add all the VLAN created for PacketFence as untagged egress 
VLAN on the relevant interfaces. This is why there is a VLAN command on each interface 
below. 

linkUp/linkDown traps are enabled by default so we disable them and enable MAC locking 
only. 

Global config settings 

  set snmp community public 
  set snmp targetparams v2cPF user public security-model v2c message-processing v2c 
  set snmp notify entryPF tag TrapPF 
  set snmp targetaddr tr 192.168.1.5 param v2cPF taglist TrapPF 
  set maclock enable 

On each interface: 

  set vlan egress 1,2,3 ge.1.xx untagged 
  set port trap ge.1.xx disable 
  set maclock enable ge.1.xx 
  set maclock static ge.1.xx 1 
  set maclock firstarrival ge.1.xx 0 
  set maclock trap ge.1.xx enable 

where `xx` stands for the interface index 

Standalone D2 
^^^^^^^^^^^^^

linkUp/linkDown traps are enabled by default so we disable them and enable MAC locking 
only. 

CAUTION: This switch Switch accepts multiple untagged VLAN per port when configured 
through SNMP. This is problematic because on some occasions the untagged VLAN port list 
can become inconsistent with the switch’s running config. To fix that, clear all untagged VLANs 
of a port even if the CLI interface doesn’t show them. 
To do so, use: `clear vlan egress <vlans> <ports>` 

Global config settings 

  set snmp community public 
  set snmp targetparams v2cPF user public security-model v2c message-processing v2c 
  set snmp notify entryPF tag TrapPF 
  set snmp targetaddr tr 192.168.1.5 param v2cPF taglist TrapPF 
  set maclock enable 

On each interface: 

  set port trap ge.1.xx disable 
  set maclock enable ge.1.xx 
  set maclock static ge.1.xx 1 
  set maclock firstarrival ge.1.xx 0 
  set maclock trap ge.1.xx enable 

where `xx` stands for the interface index 

Extreme Networks
~~~~~~~~~~~~~~~~

PacketFence supports Extreme Networks switches using:

* linkUp/linkDown
* MAC Address Lockdown (Port Security)
* Netlogin - MAC Authentication
* Netlogin - 802.1X
* RADIUS authentication for CLI access

Don't forget to save the configuration!

All Extreme XOS based switches
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

In addition to the SNMP and VLANs settings, this switch needs the Web Services to be enabled and an administrative username and password provided in its PacketFence configuration for Web Services.

MAC Address Lockdown (Port-Security)
++++++++++++++++++++++++++++++++++++

linkUp/linkDown traps are enabled by default so we disable them and enable MAC Address Lockdown only.

Global config settings without Voice over IP (VoIP):

  enable snmp access
  configure snmp add trapreceiver 192.168.1.5 community public
  enable web http
  configure vlan "Default" delete ports <portlist>
  configure vlan registration add ports <portlist> untagged
  configure ports <portlist> vlan registration lock-learning
  disable snmp traps port-up-down ports <portlist>

where `<portlist>` are ports you want to secure. It can be an individual port or a port-range with a dash.

Global config settings with Voice over IP (VoIP):

  enable snmp access
  configure snmp add trapreceiver 192.168.1.5 community public
  enable web http
  configure vlan "Default" delete ports <portlist>
  configure vlan registration add ports <portlist> untagged
  configure vlan voice add ports <portlist> tagged
  configure ports <portlist> vlan registration lock-learning
  configure ports <portlist> vlan voice limit-learning 1
  disable snmp traps port-up-down ports <portlist>

where `<portlist>` are ports you want to secure. It can be an individual port or a port-range with a dash.

MAC Authentication
++++++++++++++++++

AAA Configuration

  configure radius netlogin primary server 192.168.1.5 1812 client-ip 10.0.0.8 vr VR-Default
  configure radius netlogin primary shared-secret 12345
  enable radius netlogin

Netlogin (MAC Authentication)

  configure netlogin vlan temp
  enable netlogin mac
  configure netlogin add mac-list default
  configure netlogin dynamic-vlan enable
  configure netlogin dynamic-vlan uplink-ports 50
  configure netlogin mac authentication database-order radius
  enable netlogin ports 1-48 mac
  configure netlogin ports 1-48 mode port-based-vlans
  configure netlogin ports 1-48 no-restart

802.1X
++++++

AAA Configuration

  configure radius netlogin primary server 192.168.1.5 1812 client-ip 10.0.0.8 vr VR-Default
  configure radius netlogin primary shared-secret 12345
  enable radius netlogin

Netlogin (802.1X)

  configure netlogin vlan temp
  enable netlogin dot1x
  configure netlogin dynamic-vlan enable
  configure netlogin dynamic-vlan uplink-ports 50
  enable netlogin ports 1-48 dot1x 
  configure netlogin ports 1-48 mode port-based-vlans
  configure netlogin ports 1-48 no-restart

NOTE: You can mix the MAC Authentication and 802.1X on the same switchport. If the device fails 802.1X authentication, it will roll back to the MAC Authentication.

RADIUS authentication for CLI access
++++++++++++++++++++++++++++++++++++

Configure RADIUS server IP address as primary server and the switch IP address as the client-ip.  Be sure to specify the correct virtual router

  configure radius mgmt-access primary server <SERVER_IP> 1815 client-ip <CLIENT_IP> vr <VR>

Configure the RADIUS shared-secret

  configure radius mgmt-access primary shared-secret <SHARED_SECRET>

Enable RADIUS for management access

  enable radius mgmt-access

Foundry
~~~~~~~

FastIron 4802
^^^^^^^^^^^^^

PacketFence support this switch with optional VoIP using two different trap types:

* linkUp/linkDown
* Port Security (with static MACs)

*We recommend to enable Port Security only.*

Don't forget to update the startup config!

Those switches support port-security with static MAC address and allow us to secure a MAC on the data VLAN so we enable it whether there is VoIP or not.

We need to secure bogus MAC addresses on ports in order for the switch to send a trap when a new MAC appears on a port.

Global config settings

  snmp-server host 192.168.1.5 public
  no snmp-server enable traps link-down
  no snmp-server enable traps link-up

On each interface _without VoIP_:

  int eth xx
    port security
      enable
      maximum 1
      secure 0200.0000.00xx 0
      violation restrict

where `xx` stands for the interface `ifIndex`.

With VoIP a little more work needs to be performed. Instead of the no-VoIP, put in the following config:

----
conf t
vlan <mac-detection-vlan>
  untagged eth xx
vlan <voice-vlan>
  tagged eth xx

int eth xx
  dual-mode <mac-detection-vlan>
  port security
    maximum 2
    secure 0200.00xx.xxxx <mac-detection-vlan>
    secure 0200.01xx.xxxx <voice-vlan>
    violation restrict
    enable
----

where `xxxxxx` stands for the interface number (filled with zeros), `<voice-vlan>` with your voice-VLAN number and `<mac-detection-vlan>` with your mac-detection VLAN number.


H3C
~~~

S5120 Switch series
^^^^^^^^^^^^^^^^^^^

PacketFence supports these switches with the following technologies:

* 802.1X (with or without VoIP)
* 802.1X with MAC Authentication fallback (with or without VoIP)
* MAC Authentication (with or without VoIP)

802.1X
++++++

RADIUS scheme creation:

  radius scheme packetfence
  primary authentication 192.168.1.5 1812 key useStrongerSecret
  primary accounting 192.168.1.5 1813 key useStrongerSecret
  user-name-format without-domain

ISP-Domain creation:

  domain packetfence
  authentication default radius-scheme packetfence
  authentication lan-access radius-scheme packetfence
  authorization lan-access radius-scheme packetfence

SNMP settings:

  snmp-agent
  snmp-agent community read public
  snmp-agent community write private
  snmp-agent sys-info version v2c

Global configuration:

  port-security enable
  dot1x authentication-method eap

Global configuration (with VoIP):

Add the following to the previous global configuration.

  undo voice vlan security enable
  lldp compliance cdp

Interfaces configuration:

  port link-type hybrid
  port hybrid vlan 5 untagged
  port hybrid pvid vlan 5
  mac-vlan enable
  stp edged-port enable
  port-security max-mac-count 1
  port-security port-mode userlogin-secure
  port-security intrusion-mode blockmac
  dot1x re-authenticate
  dot1x max-user 1
  dot1x guest-vlan 5
  undo dot1x handshake
  dot1x mandatory-domain packetfence
  undo dot1x multicast-trigger

Interfaces configuration (with VoIP):

Add the following to the previous interfaces configuration.

  port hybrid vlan 100 tagged
  undo voice vlan mode auto
  voice vlan 100 enable
  lldp compliance admin-status cdp txrx
  port-security max-mac-count 3
  dot1x max-user 2

802.1X with MAC Authentication fallback
+++++++++++++++++++++++++++++++++++++++

Since using MAC Authentication as a fallback of 802.1X, use the previous 802.1X configuration and add the followings.

This configuration is the same with or without VoIP.

Global configuration:

  mac-authentication domain packetfence

Interfaces configuration:

  mac-authentication guest-vlan 5
  port-security port-mode userlogin-secure-or-mac

MAC Authentication
++++++++++++++++++

RADIUS scheme creation:

  radius scheme packetfence
  primary authentication 192.168.1.5 1812 key useStrongerSecret
  primary accounting 192.168.1.5 1813 key useStrongerSecret
  user-name-format without-domain

ISP-Domain creation:

  domain packetfence
  authentication default radius-scheme packetfence
  authentication lan-access radius-scheme packetfence
  authorization lan-access radius-scheme packetfence

SNMP settings:

  snmp-agent
  snmp-agent community read public
  snmp-agent community write private
  snmp-agent sys-info version v2c

Global configuration:

  port-security enable
  mac-authentication domain packetfence

Global configuration (with VoIP):

Add the following to the previous global configuration.

  undo voice vlan security enable
  lldp compliance cdp

Interfaces configuration:

  port link-type hybrid
  port hybrid vlan 5 untagged
  port hybrid pvid vlan 5
  mac-vlan enable
  stp edged-port enable
  mac-authentication guest-vlan 5
  port-security max-mac-count 1
  port-security port-mode mac-authentication
  port-security intrusion-mode blockmac

Interfaces configuration (with VoIP):

Add the following to the previous interfaces configuration.

  port hybrid vlan 100 tagged
  undo voice vlan mode auto
  voice vlan 100 enable
  lldp compliance admin-status cdp txrx
  port-security max-mac-count 3

HP
~~

HPE 1910 Serie
^^^^^^^^^^^^^^

The HP 1910 Serie is based on the 3Com OS and most of the configuration will be done from the GUI.

VLAN creation:
* go to *Network*, *VLAN*,
* click on the _Create_ tab
* create the VLANs


Configure PacketFence as a RADIUS server:
* go to *Authentication*, *RADIUS*
* click on the _RADIUS Server_ tab
* from _Server Type_, select *Authentication Server*
* from _Primary Server_, give the *PacketFence IP address*
* click *Apply*

Then:
* click on the _RADIUS Setup_ tab
* check the box _Authentication Server Shared Key_
* give the *shared key*
* from _Username Format_, select *without-domain*
* click *Apply*

Create a new authentication domain:
* go to *Authentication*, *AAA*,
* click on the _Domain Setup_ tab,

WARNING: We will need to create a specific authentication domain and *not making it as the default domain*.

Configure the 802.1X and authentication method:
* go to *Authentication*
* click on the _802.1X_ tab
* check the _Enable 802.1X_ box
* from _Authentication Method_, select *EAP*

Configure the authentication domain:

INFO: Even limited, there is a command line access.

* connect to the switch using ss,
* type the command:

 _cmdline-mode on

* password is: *512900*
* Type the commands:

 System-view
 Mac-authentication domain YOUR_DOMAIN_NAME
 Mac-authentication user-name-format mac-address with-hyphen

* change the _YOUR_DOMAIN_NAME_ with the one from your environment
* do not close your terminal, we will come back to this later

* from the GUI, go to *Authentication*, *802.1X*
* from _Port_, select the port your are connected to. *GigabitEthernet X/X/X*
* from _Port Control_, select *MAC Based*
* from _Max Number of Users_, give *2*
* check the box _Enable Re-Authentication_
* click on *Apply*


Enable the MAC Authentication in SSH, as well:
* back on the SSH terminal
* type the following command:

 Mac-authentication interface gX/X/X

* modify the interface name for your environment

The configuration is done.


E4800G and E5500G Switch series
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

These are re-branded 3Com switches, see under the <<_3com,3Com section>> for their documentation.

HP ProCurve
~~~~~~~~~~~

PacketFence supports ProCurve switches _without VoIP_ using two different trap types:

* linkUp/linkDown
* Port Security (with static MACs)

*We recommend to enable Port Security only.*

Don't forget to update the startup config!

NOTE: HP ProCurve only sends one security trap to PacketFence per security violation so make sure PacketFence runs when you configure port-security. Also, because of the above limitation, it is considered good practice to reset the intrusion flag as a first troubleshooting step.

If you want to learn more about intrusion flag and port-security, please refer to the ProCurve documentation.

CAUTION: If you configure a switch that is already in production be careful that enabling port-security causes active MAC addresses to be automatically added to the intrusion list without a security trap sent to PacketFence. This is undesired because PacketFence will not be notified that it needs to configure the port. As a work-around, unplug clients before activating port-security or remove the intrusion flag after you enabled port-security with: `port-security <port> clear-intrusion-flag`.

2500 Series
^^^^^^^^^^^

linkUp/linkDown traps are enabled by default so we disable them and enable Port Security only.

On 2500's, we need to secure bogus MAC addresses on ports in order for the switch to send a trap when a new MAC appears on a port.

Global config settings:

  snmp-server community "public" Unrestricted
  snmp-server host 192.168.1.5 "public" Not-INFO
  no snmp-server enable traps link-change 1-26

On each interface: 

  port-security xx learn-mode static action send-alarm mac-address 0200000000xx

where `xx` stands for the interface index

CLI authentication
++++++++++++++++++

You can use PacketFence for RADIUS CLI authentication on the 2500 Series.

Global config settings

  radius-server host 192.168.1.5 key useStrongerSecret
  aaa authentication ssh login radius local
  aaa authentication telnet login radius local

Next, make sure you configure the switch in PacketFence accordingly as well as the proper administrative access. Refer to the Administration Guide for more details.

2600 Series and 3400cl Series
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Port-Security
+++++++++++++

linkUp/linkDown traps are enabled by default so we disable them and enable Port Security only.

On 2600's, we *don't* need to secure bogus MAC addresses on ports in order for the switch to send a trap when a new MAC appears on a port.

Global config settings

  snmp-server community public manager unrestricted
  snmp-server host 192.168.1.5 "public" Not-INFO
  no snmp-server enable traps link-change 1-26

On each interface: 

  port-security xx learn-mode configured action send-alarm

where `xx` stands for the interface index

MAC Authentication (Firmware > 11.72)
+++++++++++++++++++++++++++++++++++++

In order to enable RADIUS mac authentication on the ports, you first need to join the ports to either the registration or the mac detection vlan (as a security measure).

Next, define the RADIUS server host:

   radius-server host 192.168.1.5 key useStrongerSecret

Next, we create a server-group that points to the PacketFence server,

   aaa server-group radius "packetfence" host 192.168.1.5

Configure the AAA authentication for MAC authentication to use the right server-group:

   aaa authentication mac-based chap-radius server-group "packetfence"

Optionally, you can configure the SSH and telnet authentication to point to PacketFence (make sure you also follow instructions in the Administration Guide to activate the CLI access):

  aaa authentication login privilege-mode

  aaa authentication ssh login radius server-group packetfence local
  aaa authentication telnet login radius server-group packetfence local

Finally, enable MAC authentication on all necessary ports:

   aaa port-access mac-based 1-24

Don't forget to permit address moves and the reauth period.  x represents the port index:

   aaa port-access mac-based x addr-moves
   aaa port-access mac-based x reauth-period 14400
   
(Thanks to Jean-Francois Laporte for this contribution)

2610
^^^^

802.1X
++++++

Define the RADIUS server host:

   radius-server host 192.168.1.5 key "useStrongerSecret"
   radius-server host 192.168.1.5 acct-port 1813 key "useStrongerSecret"

Define the SNMP configuration:

   snmp-server host 192.168.1.5 community "public" informs trap-level not-info
   no snmp-server enable traps link-change C1

Configure the server-group:

   aaa server-group radius "packetfence" host 192.168.1.5

Configure authentication:

   aaa authentication port-access eap-radius server-group "packetfence"
   aaa authentication mac-based chap-radius server-group "packetfence"

Configure the port-security:

   port-security C1 learn-mode port-access action send-alarm

Configuration of the port:

   aaa port-access authenticator C1
   aaa port-access authenticator C1 client-limit 1
   aaa port-access authenticator active
   aaa port-access mac-based C1
   aaa port-access mac-based C1 addr-moves
   aaa port-access mac-based C1 reauth-period 14400
   aaa port-access C1 controlled-direction in   

(Thanks to Denis Bonnenfant for this contribution)

4100, 5300, 5400 Series
^^^^^^^^^^^^^^^^^^^^^^^

Port-Security
+++++++++++++

linkUp/linkDown traps are enabled by default and we have not found a way yet to disable them so do not forget to declare the trunk ports as uplinks in the switch config file.

On 4100's, we need to secure bogus MAC addresses on ports in order for the switch to send a trap when a new MAC appears on a port. The ports are indexed differently on 4100's: it's based on the number of modules you have in your 4100, each module is indexed with a letter.

Global config settings

  snmp-server community "public" Unrestricted
  snmp-server host 192.168.1.5 "public" Not-INFO
  no snmp-server enable traps link-change 1-26

You should configure interfaces like this:

  port-security A1 learn-mode static action send-alarm mac-address 020000000001
  ...
  port-security A24 learn-mode static action send-alarm mac-address 020000000024
  port-security B1 learn-mode static action send-alarm mac-address 020000000025
  ...
  port-security B24 learn-mode static action send-alarm mac-address 020000000048
  port-security C1 learn-mode static action send-alarm mac-address 020000000049
  ...

MAC Authentication (with VoIP)
++++++++++++++++++++++++++++++

In order to have MAC Authentication working with VoIP, you need to ensure that the Voice VLAN is tagged on all the port first. You also need to activate lldp notification on all ports that will handle VoIP. 
*Finally, make sure to change the value of the $VOICEVLANAME variable in the Procurve 5400 module's source code.*

RADIUS configuration
  radius-server host 192.168.1.5 key strongKey

MAC Authentication

  aaa port-access mac-based C5-C7
  aaa port-access mac-based C5 addr-limit 2
  aaa port-access mac-based C6 addr-limit 2
  aaa port-access mac-based C7 addr-limit 2
  aaa port-access C5 controlled-direction in
  aaa port-access C6 controlled-direction in
  aaa port-access C7 controlled-direction in

802.1X (with VoIP)
++++++++++++++++++

Same as MAC Authentication, you need to ensure that the Voice VLAN is tagged on all the port first if using 802.1X. You also need to activate lldp notification on all ports that will handle VoIP. 
*Finally, make sure to change the value of the $VOICEVLANAME variable in the Procurve 5400 module's source code.*

RADIUS configuration

  radius-server host 192.168.1.5 key strongKey

802.1X

  aaa authentication port-access eap-radius
  aaa port-access authenticator C3-C4
  aaa port-access authenticator C3 client-limit 3
  aaa port-access authenticator C4 client-limit 3
  aaa port-access authenticator active

Downloadable ACLs
+++++++++++++++++

HP and Aruba switches running the ArubaOS-Switch operating system (previously called ProVision) support dynamic RADIUS-assigned ACLs. It requires RADIUS authentication using the 802.1X, Web authentication or MAC authentication available on the switch. You can define ACLs in PacketFence so that they can be automatically applied on the ports of the switches based on the role assigned. We have tested it successfully on the Aruba 2930M and 3810 series on version 16.05.0004.

To use this feature, first configure RADIUS and the authentication method on your switch. Next, in the PacketFence web admin interface, go to 'Configuration -> Policies and Access Control -> Switches'. Click on the switch you want, then on the 'Roles' tab, and check 'Role by access list'. Now you are able to add ACLs for each role.

Configure RADIUS operation on the switch:

  radius-server host <ipv4-address> key <key-string>

Configure RADIUS network accounting on the switch (optional).

  aaa accounting network <start-stop|stop-only> radius

You can also view ACL counter hits using either of the following commands:

  show access-list radius <port-list>
  show port-access <authenticator|mac-based|web-based> <port-list> clients detailed

Configure an authentication method. Options include 802.1X, web-based authentication, and MAC authentication. You can configure 802.1X, web-based authentication, and/or MAC authentication to operate simultaneously on the same ports.

* 802.1X Option:

  aaa port-access authenticator <port-list>
  aaa authentication port-access chap-radius
  aaa port-access authenticator active

* MAC Authentication Option:

  aaa port-access mac-based <port-list>

* Web Authentication Option:

  aaa port-access web-based <port-list>

This command configures web-based authentication on the switch and activates this feature on the specified ports.

For example, if you want the users that are in the registration VLAN to only use HTTP, HTTPS, DNS and DHCP you can configure this ACL in the registration role.

image::aruba-registration-acl.png[scaledwidth="100%",alt="Registration ACL"]

Now, your normal users are placed in the 'default' role and your guests in the 'guest' role.

The 'default' role uses the network 192.168.5.0/24 and 'guest' uses the network 192.168.10.0/24.

You can prevent communications between both networks using these access lists

image::aruba-acl-default-guest.png[scaledwidth="100%",alt="Cross network deny ACL"]

You could also only prevent your guest users from using shared directories

image::aruba-acl-guest.png[scaledwidth="100%",alt="Deny shares ACL"]

You could also restrict your users to use only your DNS server where 192.168.5.2 is your DNS server

image::aruba-acl-default-dns.png[scaledwidth="100%",alt="Force DNS ACL"]


Huawei
~~~~~~

PacketFence supports the S5710 switch from Huawei.

Basic configuration
^^^^^^^^^^^^^^^^^^^

----

l2protocol-tunnel user-defined-protocol 802.1X protocol-mac 0180-c200-0003 group-mac 0100-0000-0002
domain pf

dot1x enable
dot1x dhcp-trigger

radius-server template packetfence
 radius-server shared-key cipher <yourSecret>
 radius-server authentication 192.168.1.5 1812
 radius-server accounting 192.168.1.5 1813
 radius-server retransmit 2
radius-server authorization 192.168.1.5 shared-key cipher <yourSecret>

aaa
 authentication-scheme abc
  authentication-mode radius
 accounting-scheme abc
  accounting-mode radius
 domain pf
  authentication-scheme abc
  accounting-scheme abc
  radius-server packetfence

snmp-agent
snmp-agent local-engineid 800007DB0304F9389D2360
snmp-agent community write cipher <privateKey>
snmp-agent sys-info version v2c v3

----

MAC authentication
^^^^^^^^^^^^^^^^^^

----

interface GigabitEthernet0/0/8
 dot1x mac-bypass mac-auth-first
 dot1x mac-bypass
 dot1x max-user 1
 dot1x reauthenticate
 dot1x authentication-method eap

----

802.1X
^^^^^^

----

interface GigabitEthernet0/0/8
 dot1x mac-bypass
 dot1x max-user 1
 dot1x reauthenticate
 dot1x authentication-method eap

----

IBM
~~

RackSwitch G8052
^^^^^^^^^^^^^^^^

PacketFence supports only 802.1X authentication. It has been tested on version 7.9.11.0.

RADIUS configuration
++++++++++++++++++++

----
RS G8052(config)# radius-server primary-host 192.168.1.5
RS G8052(config)# radius-server enable
RS G8052(config)# radius-server primary-host 192.168.1.5 key useStrongerSecret
----

802.1X (dot1x) configuration
++++++++++++++++++++++++++++

----
RS G8052(config)# dot1x enable
----

SNMP configuration
++++++++++++++++++

----
RS G8052(config)# snmp-server read-community packetfence
RS G8052(config)# snmp-server write-community packetfence
----

Port configuration
++++++++++++++++++

----
RS G8052(config)# configure terminal
RS G8052(config)# interface port 1
RS G8052(config-if)# dot1x mode auto
RS G8052(config-if)# dot1x quiet-time 2
RS G8052(config-if)# dot1x server-timeout 3
RS G8052(config-if)# dot1x re-authenticate
RS G8052(config-if)# dot1x re-authentication-interval 10800
RS G8052(config-if)# dot1x vlan-assign
RS G8052(config-if)# end
----

PacketFence configuration
+++++++++++++++++++++++++

In order to configure the IBM RackSwitch G8052 switch module, go in the PacketFence administration interface under *Configuration->Switches->Add switch*

Definition:

 IP: This will be the IP of the IBM StackSwitch G8052 switch on the management network
 Description: IBM StackSwitch G8052
 Type: IBM RackSwitch G8052
 Mode: Production
 Deauthentication: SNMP
 Dynamic Uplinks: Checked

Roles:

   Role by VLAN ID: checked
   registration VLAN: 2
   isolation VLAN: 3
   default: 10

Radius:

   Secret Passphrase: useStrongerSecret

Snmp:

    SNMP Version: 2c
    SNMP Read Community: packetfence
    SNMP Write Community: packetfence
   
Click Save to add the switch

Intel
~~~~~

Express 460 and Express 530
^^^^^^^^^^^^^^^^^^^^^^^^^^^

PacketFence support these switches _without VoIP_ using one trap type:

* linkUp/linkDown

Exact command-line configuration to be contributed...

Juniper
~~~~~~~

PacketFence supports Juniper switches in MAC Authentication (Juniper's MAC RADIUS) mode and 802.1X.
PacketFence supports VoIP on the EX2200 (JUNOS 12.6) and EX4200 (JUNOS 13.2)

----
# load replace terminal
[Type ^D at a new line to end input]
interfaces {
    interface-range access-ports {
        member-range ge-0/0/1 to ge-0/0/46;
        unit 0 {
            family ethernet-switching {
                port-mode access;
            }
        }
    }
}

protocols {
    dot1x {
        authenticator {
            authentication-profile-name packetfence;
            interface {
                access-ports {
                    supplicant multiple;
                    mac-radius;
                }
            }
        }
    }
}

access {
    radius-server {
        192.168.1.5 {
            port 1812;
            secret "useStrongerSecret";
        }
    }

    profile packetfence {
        authentication-order radius;
        radius {
            authentication-server 192.168.1.5;
            accounting-server 192.168.1.5;
        }
        accounting {
            order radius;
            accounting-stop-on-failure;
            accounting-stop-on-access-deny;
        }
    }
}

ethernet-switching-options {
    secure-access-port {
        interface access-ports {
            mac-limit 1 action drop;
        }
    }
}

snmp {
    name "EX 4200";
    description juniper;
    location EX;
    contact "email@example.com";
    client-list list0 {
        192.168.1.5/32;
    }
    community public {
        authorization read-only;
        client-list-name list0;
    }
    community private {
        authorization read-write;
        client-list-name list0;
    }
}

Ctrl-D
# commit comment "packetfenced"
----

Change the `interface-range` statement to reflect the ports you want to secure with PacketFence.

VoIP configuration
^^^^^^^^^^^^^^^^^^

----
# load replace terminal
[Type ^D at a new line to end input]
protocols{
    lldp {
        advertisement-interval 5;
        transmit-delay 1;
        ptopo-configuration-trap-interval 1;
        lldp-configuration-notification-interval 1;
        interface all;
    }
    lldp-med {
        interface all;
    }
}

ethernet-switching-options { 
    secure-access-port {
        interface access-ports {
            mac-limit 2 action drop;
        }
    }
    voip {
        interface access-ports {
            vlan voice;
            forwarding-class voice;
        }
    }
   }
}

vlans {
    voice {
        vlan-id 3;
    }
}

Ctrl-D
# commit comment "packetfenced VoIP"
----

802.1X configuration
^^^^^^^^^^^^^^^^^^^^

----
protocols {
    dot1x {
        authenticator {
            authentication-profile-name packetfence;
            interface {
                access-ports {
                    supplicant multiple;
                    mac-radius;
                }
            }
        }
    }
}
Ctrl-D
# commit comment "packetfenced dot1x"
----


MAC Authentication configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

----
protocols {
    dot1x {
        authenticator {
            authentication-profile-name packetfence;
            interface {
                access-ports {
                    supplicant multiple;
                    mac-radius {
                        restrict;
                    }
                }
            }
        }
    }
}
Ctrl-D
# commit comment "packetfenced mac auth"
----


Configuration for MAC authentication floating devices
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

To support floating devices on a Juniper switch you need to configure the 'flap-on-disconnect' option on each interface individually and remove it from the access-ports group.

----
# load replace terminal
[Type ^D at a new line to end input]
protocols {
    dot1x {
        authenticator {
            authentication-profile-name packetfence;
            interface {
                ge-0/0/1.0 {
                    mac-radius{
                        flap-on-disconnect;
                    }
                }
                 ge-0/0/2.0 {
                    mac-radius{
                        flap-on-disconnect;
                    }
                }
                .....

                access-ports {
                    supplicant multiple;
                    mac-radius {
                        restrict; 
                    }
                }
            }
        }
    }
}
Ctrl-D
# commit comment "configured for floating devices"
----

NOTE: `flap-on-disconnect` option takes effect only
when the `restrict` option is also set.


Radius CLI login
^^^^^^^^^^^^^^^^

----
set system authentication-order [ radius password ]

set system radius-server 192.168.1.5 secret useStrongerSecret

set system login user RO class read-only

set system login user SU class super-user
----

LG-Ericsson
~~~~~~~~~~~

PacketFence supports iPECS series switches _without VoIP_ using two different trap types:

* linkUp / linkDown
* Port Security (with static MACs)

On some recent models, we can also use more secure and robust features, like:

* MAC Authentication
* 802.1X

ES-4500G Series
^^^^^^^^^^^^^^^

LinkUp / LinkDown
+++++++++++++++++

Firmware 1.2.3.2 is required for linkUp / linkDown

Prior to config, make sure to create all necessaries VLANs and config the appropriate uplink port.

Global config settings

  snmp-server community public ro
  snmp-server community private rw
  !
  snmp-server enable traps authentication
  snmp-server host 192.168.1.5 public version 2c udp-port 162
  snmp-server notify-filter traphost.192.168.1.5.public remote 192.168.1.5

Firmware is kinda buggy so you'll need to enable linkUp / linkDown using the Web Interface under *Administration -> SNMP*.

Some reports shows that the switch doesn't always send linkDown traps.

On each interface (except uplink)

  switchport allowed vlan add 4 untagged
  switchport native vlan 4
  switchport allowed vlan remove 1
  switchport mode access

Port-Security
+++++++++++++

Firmware 1.2.3.2 is required for port-security.

Prior to config, make sure to create all necessaries VLANs and config the appropriate uplink port.

Global config settings

  snmp-server community public ro
  snmp-server community private rw
  !
  snmp-server enable traps authentication
  snmp-server host 192.168.1.5 public version 2c udp-port 162
  snmp-server notify-filter traphost.192.168.1.5.public remote 192.168.1.5

On each interface (except uplink)

  port security max-mac-count 1
  port security
  port security action trap
  switchport allowed vlan add 2 untagged
  switchport native vlan 2
  switchport allowed vlan remove 1
  switchport mode access

The above _port security_ command may not work using the CLI. In this case, use the Web Interface under the *Security -> Port Security* menu and enable each ports using the checkboxes.

It is also recommended, when using port-security, to disable link-change (UP / DOWN) traps.

Don't forget to update the startup config!

Linksys
~~~~~~~

PacketFence supports Linksys switches _without VoIP_ using one trap type:

* linkUp/linkDown

Don't forget to update the startup config!

SRW224G4
^^^^^^^^

Global config settings

  no snmp-server trap authentication
  snmp-server community CS_2000_le rw view Default 
  snmp-server community CS_2000_ls ro view Default 
  snmp-server host 192.168.1.5 public 2

On each interface

  switchport access vlan 4

Netgear
~~~~~~~

The "web-managed smart switch" models GS108Tv2/GS110/GS110TP are supported with Link up/down traps only.

Higher-end "fully managed" switches including FSM726v1 are supported in Port Security mode.

FSM726 / FSM726S version 1
^^^^^^^^^^^^^^^^^^^^^^^^^^

PacketFence supports FSM726 / FSM726S version 1 switches _without VoIP_ in Port Security mode (with static MACs) – called Trusted MAC table on Netgear's hardware.

Using the HTTP GUI, follow the steps below to configure such feature. Of course, you must create all your VLANs on the switch as well.

[float]
SNMP Settings
+++++++++++++

In *Advanced -> SNMP -> Community Table*, create a read-write community string and a trap community string. You can use the same community for all the 3 functions (Get, Set, Trap).
  
Next, under *Advanced -> SNMP -> Host Table*, enable the Host Authorization feature and add the PacketFence server into the allowed host list.

Finally, under *Advanced -> SNMP -> Trap Setting*, enable the authentication trap.

[float]
Trusted MAC Security
++++++++++++++++++++

Under *Advanced -> Advanced Security -> Trusted MAC Address*, create a fake MAC address per port (ie. 02:00:00:00:00:xx where `xx` is the port number). This will have the effect of sending a security trap to PacketFence when a new device plugs on the port.
  
Don't forget to save the configuration!

GS108Tv2 / GS110T / GS110TP
^^^^^^^^^^^^^^^^^^^^^^^^^^^

PacketFence supports certain lower-end Netgear switches in Link Up/Link Down traps. These "web-managed" switches have no command-line interface and only a subset of the port security and 802.1X functionality needed to interoperate with PacketFence in these more advanced modes. There is no way to send a trap upon port security violation, and there is only pure 802.1X, no MAC Address Bypass.

[float]
Switch Configuration
++++++++++++++++++++

It can be difficult to find the advanced features in the web GUI. We recommend using the GUI "Maintenance" tab to Upload the configuration to a file, and then edit it there.

Hints on file upload/download:

From the File Type menu, choose Text Configuration.

If you're uploading to the TFTP root directory, leave Path blank.

At the top of the config file, you need:

  vlan database
  vlan 1,2,3,4,5
  vlan name 1 "Normal"
  vlan name 2 "Registration"
  vlan name 3 "Isolation"
  vlan name 4 "MAC Detection"
  vlan name 5 "Guest"
  exit

In the same section as "users passwd", you need to specify your PacketFence server's management address:

  snmptrap useStrongerSecret ipaddr 192.168.1.5

In the same section as the "voip oui" lines, you need to allow your SNMP server:

  snmp-server community "public"
  snmp-server community rw useStrongerSecret
  snmp-server community ipaddr 192.168.1.5 public
  snmp-server community ipmask 255.255.255.0 public
  snmp-server community ipaddr 192.168.1.5 useStrongerSecret
  snmp-server community ipmask 255.255.255.0 useStrongerSecret
  no voip vlan

You should use port 1 as the uplink. If you connect port 1 of a GS108Tv2 switch into a Power over Ethernet switch, then the GS108Tv2 does not need AC power. If you bought GS110T(P) switches, presumably it's for the SFP uplink option. You'll want to configure both port 1 and the SFP ports 9-10 as trunks:

  interface 0/1
  no snmp trap link-status
  ip dhcp filtering trust
  vlan pvid 1
  vlan ingressfilter
  vlan participation include 1,2,3,4,5
  vlan tagging 2,3,4,5
  no auto-voip
  exit

Each user-facing, PacketFence-managed port should be configured like:

  interface 0/2
  vlan pvid 4
  vlan ingressfilter
  vlan participation include 4
  no auto-voip
  exit

M Series
^^^^^^^^

PacketFence supports the Netgear M series in wired MAC authentication without VoIP.

Switch configuration
++++++++++++++++++++

---

radius server host auth 192.168.1.5
radius server key auth 192.168.1.5 (then press enter and input your secret)
radius server primary 192.168.1.5
radius server host acct 192.168.1.5
radius server key acct 192.168.1.5 (then press enter and input your secret)


aaa session-id unique
dot1x system-auth-control
aaa authentication dot1x default radius
authorization network radius
radius accounting mode

---

On your uplinks
+++++++++++++++

---

dot1x port-control force-authorized

---

On your interfaces
++++++++++++++++++

---

interface 0/x
dot1x port-control mac-based
dot1x timeout guest-vlan-period 1
dot1x mac-auth-bypass
exit

---

Nortel
~~~~~~

PacketFence supports Nortel switches with VoIP using one trap type:

* Mac Security

Don't forget to update the startup config!

NOTE: if you are using a 5500 series with a firmware version of 6 or above, you must use a different module called Nortel::BayStack5500_6x in your `/usr/local/pf/conf/switches.conf`. Indeed, Nortel introduced an incompatible change of behavior in this firmware.

BayStack 470, ERS2500 Series, ERS4500 Series, 4550, 5500 Series and ES325
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[float]
Global config settings
++++++++++++++++++++++

  snmp-server authentication-trap disable
  snmp-server host 192.168.1.5 "public"
  snmp trap link-status port 1-24 disable
  no mac-security mac-address-table
  interface FastEthernet ALL
  mac-security port ALL disable
  mac-security port 1-24 enable
  default mac-security auto-learning port ALL max-addrs
  exit
  mac-security enable
  mac-security snmp-lock disable
  mac-security intrusion-detect disable
  mac-security filtering enable
  mac-security snmp-trap enable
  mac-security auto-learning aging-time 60
  mac-security learning-ports NONE
  mac-security learning disable

[float]
VoIP support
++++++++++++

You need to ensure that all your ports are tagged with the voice VLAN. The switch should do the rest for you.

  vlan create 6 name "Telephone" type port learning ivl
  vlan members 6 1-20,23-24

BPS2000
^^^^^^^

You can only configure this switch through menus.

Enable MAC Address Security:

-----
MAC Address Security: Enabled
MAC Address Security SNMP-Locked: Disabled
Partition Port on Intrusion Detected: Disabled
DA Filtering on Intrusion Detected: Enabled
Generate SNMP Trap on Intrusion: Enabled
Current Learning Mode: Disabled
Learn by Ports: NONE

Port  Trunk  Security
----  -----  --------
   1         Enabled
 ...
  24         Enabled
-----

Pica8
~~~~~

PacketFence supports Pica8 switches without VoIP using CoA to:

* bounce-host-port
* reauthenticate-host

Notes

* **SNMP is not supported yet**
* **Port Security is not supported**

For interfaces with MAC Authentication, perform the following:

  set interface gigabit-ethernet ge-1/1/25 family ethernet-switching port-mode trunk
  set protocols dot1x interface ge-1/1/25 auth-mode mac-radius
  set protocols dot1x interface ge-1/1/25 dynamic-vlan-enable true
  set protocols dot1x traceoptions interface ge-1/1/25 flag all disable false

For interfaces with 802.1X, perform:

  set interface gigabit-ethernet ge-1/1/4 family ethernet-switching port-mode trunk
  set protocols dot1x interface ge-1/1/4 auth-mode dot1x
  set protocols dot1x interface ge-1/1/4 dynamic-vlan-enable true
  set protocols dot1x traceoptions interface ge-1/1/4 flag all disable false
  
Global configuration:

  set protocols dot1x aaa radius nas-ip 10.10.51.169
  set protocols dot1x aaa radius authentication server-ip 192.168.1.5 shared-key useStrongerSecret
  set protocols dot1x aaa radius dynamic-author client 192.168.1.5 shared-key useStrongerSecret
  set protocols dot1x traceoptions interface ge-1/1/4 flag all disable false
  set protocols dot1x traceoptions flag radius disable false
  set vlans vlan-id 10
  set vlans vlan-id 20
  set vlans vlan-id 30
  commit

* `10.10.51.169` is the switch IP
* For interfaces where auth-mode is unknown, use the following command
    set protocols dot1x interface ge-1/1/12 auth-mode dot1x-mac-radius
  This allows the switch to first try 802.1X and if there is no response from the client then fallback to MAC Authentication.
* Create VLAN(s) on the switch as per your requirements
* Please note that traceoptions are only for debugging

SMC
~~~

TigerStack 6128L2, 8824M and 8848M
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

PacketFence supports these switches without VoIP using two different trap types:

* linkUp/linkDown
* Port Security (with static MACs)

*We recommend to enable Port Security only.*

Global config settings

  SNMP-server host 192.168.1.5 public version 2c udp-port 162
  no snmp-server enable traps link-up-down

On each interface: 

  port security max-mac-count 1
  port security
  port security action trap

TigerStack 6224M
^^^^^^^^^^^^^^^^

Supports linkUp/linkDown mode

Global config settings

  SNMP-server host 192.168.1.5 public version 1


Ubiquiti
~~~~~~~~

EdgeSwitch
^^^^^^^^^^

PacketFence supports the EdgeSwitch with the following techniques:

* 802.1X with MAC Authentication fallback
* 802.1X with MAC Authentication fallback with VoIP

802.1X with MAC Authentication fallback
+++++++++++++++++++++++++++++++++++++++

We assume that the switch ip is 192.168.1.254

First on the uplink add this configuration:

  dot1x port-control force-authorized
  vlan participation include 1,2,3,4,5,100
  vlan tagging 2,3,4,5,100

Global config settings:

  vlan database
  vlan 1
  vlan 2
  vlan 3
  vlan 4
  vlan 5
  vlan 100
  exit

  configure
  dot1x system-auth-control
  aaa authentication dot1x default radius
  authorization network radius
  dot1x dynamic-vlan enable
  radius accounting mode
  radius server host auth "192.168.1.5" name "PacketFence"
  radius server key auth "192.168.1.5"

  Enter secret (64 characters max):useStrongerSecret

  radius server primary "192.168.1.5"
  no radius server msgauth "192.168.1.5"
  radius server attribute 4 192.168.1.254

  radius server attribute 32 "EdgeSwitch"
  radius server host acct "192.168.1.5" name PacketFence-ACCT
  radius server key acct "192.168.1.5"

  Enter secret (64 characters max):useStrongerSecret

  snmp-server community public ro
  snmp-server community private rw
  exit

On each interface (not uplink)

  dot1x port-control mac-based
  dot1x re-authentication
  dot1x timeout reauth-period 1800
  dot1x timeout supp-timeout 10
  dot1x timeout guest-vlan-period 3
  dot1x timeout server-timeout 1800
  dot1x mac-auth-bypass
  dot1x unauthenticated-vlan 4
  vlan participation include 1,2,3,4,5,100
  exit


802.1X with MAC Authentication fallback with VoIP
+++++++++++++++++++++++++++++++++++++++++++++++++

We assume that the switch ip is 192.168.1.254

First on the uplink add this configuration:

  dot1x port-control force-authorized
  vlan participation include 1,2,3,4,5,100
  vlan tagging 2,3,4,5,100

Global config settings:

  vlan database
  vlan 1
  vlan 2
  vlan 3
  vlan 4
  vlan 5
  vlan 100
  exit

  configure
  dot1x system-auth-control
  aaa authentication dot1x default radius
  authorization network radius
  dot1x dynamic-vlan enable
  voice vlan 100
  radius accounting mode
  radius server host auth "192.168.1.5" name "PacketFence"
  radius server key auth "192.168.1.5"

  Enter secret (64 characters max):useStrongerSecret

  radius server primary "192.168.1.5"
  no radius server msgauth "192.168.1.5"
  radius server attribute 4 192.168.1.254

  radius server attribute 32 "EdgeSwitch"
  radius server host acct "192.168.1.5" name PacketFence-ACCT
  radius server key acct "192.168.1.5"

  Enter secret (64 characters max):useStrongerSecret

  snmp-server community public ro
  snmp-server community private rw
  exit

On each interface (not uplink)

  dot1x port-control mac-based
  dot1x re-authentication
  dot1x timeout reauth-period 1800
  dot1x timeout supp-timeout 10
  dot1x timeout guest-vlan-period 3
  dot1x timeout server-timeout 1800
  dot1x mac-auth-bypass
  dot1x unauthenticated-vlan 4
  vlan participation include 1,2,3,4,5,100
  voice vlan 100
  auto-voip protocol-based
  lldp transmit
  lldp receive
  lldp transmit-tlv port-desc
  lldp transmit-tlv sys-name
  lldp transmit-tlv sys-desc
  lldp transmit-tlv sys-cap
  lldp transmit-mgmt
  lldp notification
  lldp med
  lldp med confignotification
  exit


Wireless Controllers and Access Point Configuration
---------------------------------------------------

Assumptions
~~~~~~~~~~~

Throughout this configuration example we use the following assumptions for our network infrastructure:

[options="compact"]
* PacketFence is fully configured with FreeRADIUS running
* PacketFence IP address: 192.168.1.5
* Normal VLAN: 1
* Registration VLAN: 2
* Isolation VLAN: 3
* MAC Detection VLAN: 4
* Guest VLAN: 5
* VoIP, Voice VLAN: 100
* use SNMP v2c
* SNMP community name: public
* RADIUS Secret: useStrongerSecret footnote:[Be careful to change the secret key to a much stronger one. A 16 character random secret with digits, upper case and lower case characters is recommended.]
* Open SSID: PacketFence-Public
* WPA-Enterprise SSID: PacketFence-Secure


Unsupported Equipment
~~~~~~~~~~~~~~~~~~~~~

Wireless network access configuration is a lot more consistent between vendors. This is due to the fact that the situation is a lot more standardized than the wired side: VLAN assignment is done centrally with RADIUS and that the client protocol is consistent (MAC-Authentication or 802.1X).

This consistency has the benefit that a lot of the wireless network devices tend to work out-of-the-box with PacketFence. The only missing piece being, in most cases, remote deauthentication of the client which is used for VLAN assignment (deauth user so it'll reconnect and get new VLAN).

So, even if your wireless equipment is not explicitly supported by PacketFence, it's recommended that you give it a try. The next section covers the objectives that you want to accomplish for trying out your equipment even if we don't have configuration for it.

Here are the high-level requirements for proper wireless integration with PacketFence

* The appropriate VLANs must exist
* Allow controller to honor VLAN assignments from AAA (sometimes called AAA override)
* Put your open SSID (if any) in MAC-Authentication mode and authenticate against the FreeRADIUS hosted on PacketFence
* Put your secure SSID (if any) in 802.1X mode and authenticate against FreeRADIUS hosted on PacketFence.
* On registration / isolation VLANs the DHCP traffic must reach the PacketFence server
* On your production VLANs a copy of the DHCP traffic must reach PacketFence where a pfdhcplistener listens (configurable in `pf.conf` under `interfaces`)

At this point, user registration with the captive-portal is possible and registered users should have access to the appropriate VLANs. However, VLAN changes (like after a registration) won't automatically happen, you will need to disconnect / reconnect. An explanation is provided in introduction section above about this behavior.

You can try modules similar to your equipment if any (read appropriate instructions) or you can try to see if RFC3576 is supported. RFC3576 covers RADIUS Packet of Disconnect (PoD) also known as Disconnect Messages (DM) or Change of Authorization (CoA). You can try the Aruba module if you want to verify if RFC3576 is supported by your hardware.

If none of the above worked then you can fallback to inline enforcement or let us know what equipment you are using on the https://lists.sourceforge.net/lists/listinfo/packetfence-devel[packetfence-devel mailing list].

// Aerohive Networks
include::networkdevice/aerohive.asciidoc[]

[float]
Roles (User Profiles)
+++++++++++++++++++++

Since PacketFence 3.3.0, we now support user profiles on the AeroHIVE hardware.  To build a User Profile, go to *Configuration -> User Profiles*, and create what you need.  When you define the switch
definition in PacketFence, the role will match the User Profile attribute number.  Example

   roles=CategoryStudent=1;CategoryStaff=2

And in the AeroHIVE configuration, you have :

   StudentProfile attribute number 1
   StaffProfile attribute number 2

Last step is to allow the User Profile to be returned for a particular SSID.  Go to *Configuration -> SSIDs -> Your_SSID -> User Profiles for Traffic Management*, and select the User Profiles you will
return for the devices.

In version 6 or later of the HiveOS, we do return VLAN ID matching the number that the *User Profile* has. Create your *User Profile* in the HiveManager as usual, assign the matching VLAN, and in PacketFence configuration add the wanted VLAN ID in the section *Roles by VLAN*.



// Anyfi Networks
include::networkdevice/anyfi.asciidoc[]

Avaya
~~~~~

Wireless Controller
^^^^^^^^^^^^^^^^^^^

NOTE: To be contributed....

Aruba
~~~~~

All Aruba OS
^^^^^^^^^^^^

In this section, we cover the basic configuration of the Aruba wireless controller for PacketFence via the web GUI. It was done on an Aruba Controller 200 software version ArubaOS 5.0.3.3, tested on a Controller 600 with ArubaOS 6.0 but it should apply to all Aruba models.

CAUTION: If you are already using your Aruba controllers and don't want to impact your users you should create new AAA profiles and apply them to new SSIDs instead of modifying the default ones.

NOTE: Starting with PacketFence 3.3, Aruba supports role-based access control. Read the Administration Guide under "Role-based enforcement support" for more information about how to configure it on the PacketFence side.

[float]
AAA Settings
+++++++++++++

In the Web interface, go to *Configuration -> Authentication -> RADIUS Server* and add a RADIUS server named "packetfence" then edit it:

* Set Host to PacketFence's IP (192.168.1.5)
* Set the Key to your RADIUS shared secret (useStrongerSecret)
* Click Apply

Under *Configuration -> Authentication -> Server Group* add a new Server Group named "packetfence" then edit it to add your RADIUS Server "packetfence" to the group. Click Apply.

Under *Configuration -> Authentication -> RFC3576* add a new server with PacketFence's IP (192.168.1.5) and your RADIUS shared secret (useStrongerSecret). Click Apply.
Under *Configuration -> Authentication -> L2 Authentication* edit the MAC Authentication Profile called "default" then edit it to change the Delimiter to dash. Click Apply.

Under *Configuration -> Authentication -> L2 Authentication* edit the 802.1X Authentication Profile called "default" then edit it to uncheck the Opportunistic Key Caching under Advanced. Click Apply.

Under *Configuration -> Authentication -> AAA Profiles* click on the "default-mac-auth" profile then click on MAC Authentication Server Group and choose the "packetfence" server group. Click Apply. Move to the RFC3576 server sub item and choose PacketFence's IP (192.168.1.5) click add then apply.

Under *Configuration -> Authentication -> AAA Profiles* click on the "default-dot1x" profile then click on 802.1X Authentication Server Group and choose the "packetfence" server group. Click Apply. Move to the RFC3576 server sub item and choose PacketFence's IP (192.168.1.5) click add then apply.

[float]
Public SSID
++++++++++++

In the Web interface, go to *Configuration -> AP Configuration* then edit the "default" AP Group. Go in *Wireless LAN -> Virtual AP* create a new profile with the following:

* AAA Profile: default-mac-auth
* SSID Profile: Select NEW then add an SSID (PacketFence-Public) and Network authentication set to None

[float]
Secure SSID
+++++++++++

In the Web interface, go to *Configuration -> AP Configuration* then edit the "default" AP Group. Go in *Wireless LAN -> Virtual AP* create a new profile with the following:

* AAA Profile: default-dot1x
* SSID Profile: Select NEW then add an SSID (PacketFence-Secure) and Network authentication set to WPA2

[float]
Roles
+++++

Since PacketFence 3.3.0, we now support roles for the Aruba hardware.  To add roles, go in *Configuration -> Access Control -> User Roles -> Add*.  You don't need to force a VLAN usage in the Role
since we send also the VLAN ID along with the Aruba User Role in the RADIUS request.  Refer to the Aruba User Guide for more information about the Role creation.

WIPS
++++

In order to use the WIPS feature in PacketFence, please follow those simple steps to send the traps to PacketFence.

First, configure PacketFence to be a trap receiver.  Under *Configuration > SNMP > Trap Receivers*, add an entry for the PF management IP.  By default, all traps will be enabled.  If you want to disable some, you will need
to connect via CLI, and run the *snmp-server trap disable <trapname>* command.

WebAuth
+++++++

First of all you will need to configure a guest VLAN.

image::aruba-create-guest-vlan.png[scaledwidth="100%",alt="Guest VLAN"]

Next, you will need to configure a RADIUS server.

image::aruba-radius-server.png[scaledwidth="100%",alt="RADIUS server"]

  aaa authentication-server radius "packetfence"
  host 192.168.1.5
  key useStrongerSecret

Add your RADIUS server to a AAA group, under `Security -> Authentication -> Servers -> Server Group`:

  aaa server-group "packetfence"
  auth-server "packetfence" position 1

Then define the `RFC 3576` server, which will allow you to do CoA.

image::aruba-config-coa.png[scaledwidth="100%",alt="RADIUS CoA server"]

  aaa rfc-3576-server "192.168.1.5"
  key useStrongerSecret

Next, you will need to create the policy that will redirect users to the PacketFence captive portal when they are not authenticated. Go to `Security -> Authentication -> L3 Authentication -> Captive Portal Authentication Profile`.

image::aruba-l3-auth1.png[scaledwidth="100%",alt="Layer 3 profile"]
image::aruba-l3-auth2.png[scaledwidth="100%",alt="Layer 3 profile 2"]

  aaa authentication captive-portal "packetfence-externalportal"
  default-role auth-guest
  redirect-pause 3
  no logout-popup-window
  login-page https://192.168.1.5/Aruba
  switchip-in-redirection-url

Now create the policy for the guest access, for example Internet only.

Add the authentication for the Captive Portal Profile via `Security -> Authentication -> L3 Authentication -> Captive Portal Authentication Profile -> Server Group`:

  aaa authentication captive-portal "packetfence-externalportal"
  server-group "packetfence"

Adjust the configuration of the AAA profile through `Security -> Authentication -> Profiles -> AAA Profiles`:

image::aruba-config-aaa-profile1.png[scaledwidth="30%",alt="AAA profile 1"]
image::aruba-config-aaa-profile2.png[scaledwidth="100%",alt="AAA profile 2"]
image::aruba-config-aaa-profile3.png[scaledwidth="100%",alt="AAA profile 3"]
image::aruba-config-aaa-profile4.png[scaledwidth="100%",alt="AAA profile 4"]
image::aruba-config-aaa-profile5.png[scaledwidth="100%",alt="AAA profile 5"]
image::aruba-config-aaa-profile6.png[scaledwidth="100%",alt="AAA profile 6"]

  aaa profile "packetfence-externalportal"
  initial-role packetfence-portal
  radius-interim-accounting
  radius-accounting "packetfence"
  rfc-3576-server "192.168.1.5"

Define a policy to permit the traffic.

First add a destination, `Advanced Services -> Stateful Firewall -> Destinations`:

  netdestination packetfence-portal
  host 192.168.1.5

Create an ACL for the redirection, `Security -> Firewall Policies`:

image::aruba-config-policy1.png[scaledwidth="100%",alt="Policy 1"]
image::aruba-config-policy2.png[scaledwidth="100%",alt="Policy 2"]
image::aruba-config-policy3.png[scaledwidth="100%",alt="Policy 3"]
image::aruba-config-policy4.png[scaledwidth="100%",alt="Policy 4"]
image::aruba-config-policy5.png[scaledwidth="100%",alt="Policy 5"]

Source NAT on VLAN

  ip access-list session "packetfence-externalportal"
  alias "user" alias "packetfence-portal" "svc-http" permit queue low
  alias "user" alias "packetfence-portal" "svc-https" permit queue low

Enable the "firewall allow-tri-session" :

  firewall allow-tri-session

Source NAT per Application

  ip access-list session "packetfence-externalportal"
  alias "user" alias "packetfence-portal" "svc-http" src-nat queue low
  alias "user" alias "packetfence-portal" "svc-https" src-nat queue low

Now add the newly created policy to the Captive Portal Profile, `Security -> User Roles`:

image::aruba-config-user-role.png[scaledwidth="100%",alt="User Role"]
image::aruba-interface-redirection.png[scaledwidth="100%",alt="Interface de redirection"]

  user-role "packetfence-portal"
  access-list session "packetfence-externalportal" position 1
  access-list session "captiveportal" position 2
  access-list session "guest-logon-access" position 3
  access-list session "block-internal-access" position 4
  access-list session "v6-logon-control" position 5
  access-list session "captiveportal6" position 6
  captive-portal "packetfence-externalportal"

Finaly create the SSID and associate the profile to it, `Virtual AP profile`:

  wlan virtual-ap "packetfence-externalportal"
  ssid-profile "packetfence-externalportal"
  aaa-profile "packetfence"

General AP settings and master-slave controller case.

image::aruba-ap-config1.png[scaledwidth="30%",alt="Config AP 1"]
image::aruba-ap-config2.png[scaledwidth="100%",alt="Config AP 2"]
image::aruba-ap-config3.png[scaledwidth="100%",alt="Config AP 3"]
image::aruba-ap-config4.png[scaledwidth="100%",alt="Config AP 4"]
image::aruba-ap-config5.png[scaledwidth="100%",alt="Config AP 5"]
image::aruba-ap-config6.png[scaledwidth="100%",alt="Config AP 6"]
image::aruba-ap-config7.png[scaledwidth="100%",alt="Config AP 7"]
image::aruba-ap-config8.png[scaledwidth="100%",alt="Config AP 8"]
image::aruba-ap-config9.png[scaledwidth="100%",alt="Config AP 9"]
image::aruba-ap-config10.png[scaledwidth="100%",alt="Config AP 10"]
image::aruba-ap-config11.png[scaledwidth="100%",alt="Config AP 11"]

image::aruba-secondary-controller.png[scaledwidth="100%",alt="Secondary controller configuration"]

The next step will be to configure the Aruba WiFi controller for WebAuth in PacketFence, add the switch with the model choice `Aruba Network`, 

image::aruba-wlc1.png[scaledwidth="80%",alt="Add Aruba wireless controller"]
image::aruba-wlc-roles.png[scaledwidth="80%",alt="Aruba wireless controller roles configuration"]

Check the box `External Portal Enforcement`, in the Roles section, choose `Role by Switch Role`, as the registration role, enter your default role: `packetfence-portal` and choose the policy matching roles, for instance guest: `internet-only`.

CLI authentication
++++++++++++++++++

In order to enable CLI login on the Aruba controller via the PacketFence server, you need to point management authentication to the RADIUS server you created while configuring the SSIDs in the previous sections above.

aaa authentication mgmt
  default-role read-only
  enable
  server-group PacketFence

Aruba Controller 200
^^^^^^^^^^^^^^^^^^^^

In this section, we cover the basic configuration of the Aruba Controller 200 for PacketFence using the command line interface. We suggest you to use the instructions above for the Web GUI instead.

[float]
VLAN definition
+++++++++++++++

Here, we create our PacketFence VLANs, and our AccessPoint VLAN (VID 66). It is recommended to isolate the management of the thin APs in a separate VLAN. 

  vlan 2 
  vlan 3 
  vlan 5 
  vlan 10 
  vlan 66 

[float]
AAA Authentication Server
+++++++++++++++++++++++++

  aaa authentication-server radius "PacketFence"
     host 192.168.1.5
     key useStrongerSecret
  aaa server-group "Radius-Group"
   auth-server PacketFence

[float]
AAA Profiles
++++++++++++

  aaa profile "default-dot1x"
     authentication-dot1x "default"
     dot1x-default-role "authenticated"
     dot1x-server-group "Radius-Group"
     radius-accounting "Radius-Group"
  aaa profile "PacketFence"
     authentication-mac "pf_mac_auth"
     mac-server-group "Radius-Group"
     radius-accounting "Radius-Group"

[float]
WLAN SSIDs: profiles and virtual AP
+++++++++++++++++++++++++++++++++++

  wlan ssid-profile "PacketFence-Public"
     essid "PacketFence-Public"
  wlan ssid-profile "PacketFence-Secure"
     essid "PacketFence-Secure"
     opmode wpa2-aes
  wlan virtual-ap "Inverse-Guest"
     aaa-profile "PacketFence"
     ssid-profile "PacketFence-Public"
  wlan virtual-ap "Inverse-Secure"
     aaa-profile "default-dot1x"
     ssid-profile "PacketFence-Secure"
  ap-group "Inverse"
     virtual-ap "Inverse-Guest"
     virtual-ap "Inverse-Secure"
     ids-profile "ids-disabled"

All Aruba Instant OS
^^^^^^^^^^^^^^^^^^^^

Add your packetfence instance to your configuration:

wlan auth-server packetfence

  ip 192.168.1.5
  port 1812
  acctport 1813
  timeout 10
  retry-count 5
  key useStrongerSecret
  nas-ip [Aruba Virtual Controller IP]
  rfc3576


Add dynamic vlan rules and mac auth to your ssid profile:

wlan ssid-profile SSID

  index 0 
  type employee
  essid ESSID
  wpa-passphrase WPA-Passphrase
  opmode wpa2-psk-aes
  max-authentication-failures 0
  vlan 1
  auth-server packetfence
  set-vlan Tunnel-Private-Group-Id contains 1 1
  set-vlan Tunnel-Private-Group-Id contains 4 4
  rf-band all
  captive-portal disable
  mac-authentication
  dtim-period 1
  inactivity-timeout 1000
  broadcast-filter none
  radius-reauth-interval 5
  dmo-channel-utilization-threshold 90

Belair Networks (now Ericsson)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

BE20
^^^^

The Belair Networks BE20s are fairly easy to configure.

Add VLANs
+++++++++

On the BE20 Web Interface, click on *Eth-1-1*.  By default, there will be nothing in there.  You need to first create an untagged VLAN (VLAN 0). In order to do that, you need to set
the PVID, Reverse PVID, and the VLAN field to 0.  Then click add.

Repeat that step for each of your VLANs by entering the proper VLAN ID in the VLAN field.
   
AAA Servers
+++++++++++

Once you have the VLANs setup, you need to add PacketFence into the AAA Server list.  Go to *System -> Radius Servers*.  Click on *Add server*, and fill out the proper information.

* Ensure the Enabled checkbox is selected
* IP Address: Insert the IP Address of the PacketFence Management Interface
* Shared Secret: Insert the shared secret for RADIUS communication

When done, click on the *Apply* button.

Secure SSID
+++++++++++
Since the BE20 doesn't support Open SSID with MAC Authentication, we will only describe how to configure a WPA2-Enterprise SSID.  First, we will configure the 5GHz antenna.

Click on *Wifi-1-1 -> Access SSID Config*.  From the *Configuration for SSID* dropdown, select the 1 entry.  Modify the fields like the following:

* SSID: Put your SSID Name you would like
* Type: Broadcast
* Use Privacy Mode: WPA2(AES) with EAP/DOT1x
* RADIUS NAS Identifier: You can put a string to identify your AP
* Radius Accounting Enabled: Checkbox Selected
* Radius Station ID Delimiter: dash
* Radius StationId Append Ssid: Checkbox Selected
* RADIUS Server 1: Select the AAA Server you created earlier

When done click *Apply*.  Repeat the same configuration for the 2.4GHz Antenna (Wifi-1-2).

That should conclude the configuration.  You can now save the configs to the flash by hitting the *Config Save* button on top of the Interface.

Brocade
~~~~~~~

RF Switches
^^^^^^^^^^^

See the <<_motorola,Motorola RF Switches>> documentation.

Cambium
~~~~~~~

cnPilot E410
^^^^^^^^^^^^

802.1X
++++++

To setup the Cambium cnPilot E410 AP to use 802.1x, first, you need to already have configured the VLANs that will be used in the AP under *Configure -> Network*. Make sure that in *Configure -> Network -> Ethernet Ports*, the port is configured to *Trunk Multiple VLANs*, and the list of VLANs are allowed.

Next, go to *Configure -> WLAN*, and click on *Add WLAN*. Give it the desired ID, and enter your SSID, default VLAN, and select *WPA2 Enterprise* for Security.

image::cambium-dot1x-basic.png[scaledwidth="100%",alt="Cambium WLAN Basic"]

In the *RADIUS Server* tab, enter the management IP address of PacketFence (VIP in case of a cluster) and the Radius secret for Authentication and Accounting servers.

Check the *Dynamic Authorization* and *Dynamic VLAN* boxes and save.

image::cambium-dot1x-radius.png[scaledwidth="100%",alt="Cambium WLAN Radius"]

MAC Authentication
++++++++++++++++++

To enable MAC authentication in the Cambium E410, go to *Configure -> WLAN*, select your WLAN, set the Security to open and click on the tab *Access*.

In the *MAC Authentication* section, select Radius as the policy, and check the box for *Password* to use the MAC address as the password in the Radius request. Click on Save.

image::cambium-mac-auth.png[scaledwidth="100%",alt="Cambium MAC Authentication"]

Web Authentication
++++++++++++++++++

To enable Web Authentication, go to your WLAN in *Configure -> WLAN*, create a new WLAN with open Security, and click on the tab *Guest Access* to set the following:

* Enable: check the box
* Portal Mode: External Hotspot
* Access Policy: Radius
* Redirect Mode: HTTP
* External Page URL: http://_IP_ADDRESS_OF_PACKETFENCE/Cambium
* External Portal Type: Standard
* Success Action: Your preferred action.
* Prefix Query Strings in Redirect URL: check the box
* Redirection URL Query String: check Client IP
* Redirect: check HTTP-only

Click Save.

In the *Add Whitelist* section, add the IP address or domain name of your PacketFence server, then save.

image::cambium-web-auth.png[scaledwidth="100%",alt="Cambium Web Authentication"]

image::cambium-web-auth-whitelist.png[scaledwidth="100%",alt="Cambium Web Authentication Whitelist"]

On PacketFence web admin, in the Switch configuration for your AP, Roles tab, check Role by Web Auth URL box, and enter http://_IP_ADDRESS_OF_PACKETFENCE/Cambium in the registration field.

image::cambium-role-web-auth.png[scaledwidth="100%",alt="Cambium Role for Web Authentication"]


Cisco
~~~~~

Aironet 1121, 1130, 1242, 1250, 1600
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

CAUTION: With this equipment, the same VLAN cannot be shared between two SSIDs. Have this in mind in your design. For example, you need two isolation VLAN if you want to isolate hosts on the public and secure SSIDs.

[float]
MAC-Authentication + 802.1X configuration
+++++++++++++++++++++++++++++++++++++++++

Radio Interfaces:

----
dot11 vlan-name normal vlan 1
dot11 vlan-name registration vlan 2
dot11 vlan-name isolation vlan 3
dot11 vlan-name guest vlan 5

interface Dot11Radio0
  encryption vlan 1 mode ciphers aes-ccm
  encryption vlan 2 mode ciphers aes-ccm
  ssid PacketFence-Public
  ssid PacketFence-Secure

interface Dot11Radio0.2
  encapsulation dot1Q 2
  no ip route-cache
  bridge-group 253
  bridge-group 253 subscriber-loop-control
  bridge-group 253 block-unknown-source
  no bridge-group 253 source-learning
  no bridge-group 253 unicast-flooding
  bridge-group 253 spanning-disabled

interface Dot11Radio0.3
  encapsulation dot1Q 3
  no ip route-cache
  bridge-group 254
  bridge-group 254 subscriber-loop-control
  bridge-group 254 block-unknown-source
  no bridge-group 254 source-learning
  no bridge-group 254 unicast-flooding
  bridge-group 254 spanning-disabled

interface Dot11Radio0.5
  encapsulation dot1Q 5
  no ip route-cache
  bridge-group 255
  bridge-group 255 subscriber-loop-control
  bridge-group 255 block-unknown-source
  no bridge-group 255 source-learning
  no bridge-group 255 unicast-flooding
  bridge-group 255 spanning-disabled
----

LAN interfaces:

----
interface FastEthernet0.2
  encapsulation dot1Q 2
  no ip route-cache
  bridge-group 253
  no bridge-group 253 source-learning
  bridge-group 253 spanning-disabled

interface FastEthernet0.3
  encapsulation dot1Q 3
  no ip route-cache
  bridge-group 254
  no bridge-group 254 source-learning
  bridge-group 254 spanning-disabled

interface FastEthernet0.5
  encapsulation dot1Q 5
  no ip route-cache
  bridge-group 255
  no bridge-group 255 source-learning
  bridge-group 255 spanning-disabled
----

Then create the two SSIDs:

----
dot11 ssid PacketFence-Secure
  vlan 3 backup normal
  authentication open eap eap_methods
  authentication key-management wpa

dot11 ssid PacketFence-Public
  vlan 2 backup guest
  authentication open mac-address mac_methods
  mbssid guest-mode
----

Configure the RADIUS server (we assume here that the FreeRADIUS server and the PacketFence server are located on the same box):

----
radius-server host 192.168.1.5 auth-port 1812 acct-port 1813 key useStrongerSecret
aaa group server radius rad_eap
  server 192.168.1.5 auth-port 1812 acct-port 1813
aaa authentication login eap_methods group rad_eap
aaa group server radius rad_mac
  server 192.168.1.5 auth-port 1812 acct-port 1813
aaa authentication login mac_methods group rad_mac
----

Aironet 1600
^^^^^^^^^^^^

CoA and radius:

----
radius-server attribute 32 include-in-access-req format %h
radius-server vsa send accounting
aaa server radius dynamic-author
 client 192.168.1.5
 server-key 7 useStrongerSecret
 port 3799
 auth-type all
----

Aironet (WDS)
^^^^^^^^^^^^^

  To be contributed...


Wireless LAN Controller (WLC) or Wireless Services Module (WiSM)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

In this section, we cover the basic configuration of the WiSM for PacketFence using the web interface.

* First, globally define the FreeRADIUS server running on PacketFence
  (PacketFence's IP) and make sure _Support for RFC 3576_ (also called _Support for CoA_) is enabled. When the option is missing from your WLC, it is enabled by default.

image::cisco-wlc-radius-define.png[scaledwidth="100%",alt="Freeradius server"]

* Then we create two SSIDs:
[options="compact"]
** PacketFence-Public: non-secure with MAC authentication only
** PacketFence-Secure: secure with WPA2 Enterprise PEAP/MSCHAPv2

image::cisco-wlc-ssid-create.png[scaledwidth="100%",alt="SSID creation"]

* In the secure SSID, make sure 802.1X is enabled and select the appropriate encryption for your needs (recommended: WPA + WPA2)

image::cisco-wlc-l2-secu.png[scaledwidth="100%",alt="SSID L2 secure"]

* No layer 3 security

image::cisco-wlc-l3-secu.png[scaledwidth="100%",alt="SSID L3 secure"]

* We set the IP of the FreeRADIUS server

image::cisco-wlc-secure-radius.png[scaledwidth="100%",alt="Radius secure"]

* VERY IMPORTANT: Allow AAA override (this allows VLAN assignment from RADIUS)

image::cisco-wlc-secure-radius-advance.png[scaledwidth="100%",alt="Radius advanced secure"]

* Edit the non-secure SSID: Enable MAC authentication at level 2

image::cisco-wlc-l2-non-secure.png[scaledwidth="100%",alt="SSID L2 non secure"]

* Nothing at level 3

image::cisco-wlc-l3-non-secure.png[scaledwidth="100%",alt="SSID L3 non secure"]

* We set the IP of the FreeRADIUS server

image::cisco-wlc-secure-radius.png[scaledwidth="100%",alt="Radius secure"]

* VERY IMPORTANT: Allow AAA override (this allows VLAN assignment from RADIUS)

image::cisco-wlc-non-secure-radius-advance.png[scaledwidth="100%",alt="Radius advanced non secure"]

* Finally, in _Controller > Interfaces_ tab, create an interface per VLAN that could be assigned

image::cisco-wlc-interface-ssid.png[scaledwidth="100%",alt="SSID Interface"]

WARNING: When creating interfaces, it's important to configure DHCP servers. Otherwise, WLC will block DHCP requests.

You are good to go!

Wireless LAN Controller (WLC) Web Auth
++++++++++++++++++++++++++++++++++++++

In this section, we cover the basic configuration of the WLC Web Auth for PacketFence using the web interface.
The idea is to forward the device to the captive portal with an ACL if the device is in an unreg state and 
allow the device to reach Internet (or the normal network) by changing the ACL once registered.
In the unreg state, the WLC will intercept the HTTP traffic and forward the device to the captive portal.

In this sample configuration, the captive portal uses the IP address 172.16.0.250, the administration interface
uses the IP address 172.16.0.249 and the WLC uses the IP address 172.16.0.248.
The DHCP and DNS servers are not managed by PacketFence (WLC DHCP Server, Production DHCP Server)

* First, globally define the FreeRADIUS server running on PacketFence
  (PacketFence's Administration Interface) and make sure _Support for RFC 3576_ is enabled (if not present it is enabled by default)

* Then we create a SSID:
[options="compact"]
** OPEN SSID: non-secure with MAC authentication only

image::SSID_1.png[scaledwidth="100%",alt="SSID step 1"]

image::SSID_2.png[scaledwidth="100%",alt="SSID step 2"]

image::SSID_3.png[scaledwidth="100%",alt="SSID step 3"]

image::SSID_4.png[scaledwidth="100%",alt="SSID step 4"]

image::SSID_5.png[scaledwidth="100%",alt="SSID step 5"]

image::SSID_6.png[scaledwidth="100%",alt="SSID step 6"]

NOTE: On more recent controllers, the value 'Radius NAC' in the 'NAC State' setting will be called 'ISE NAC'.

image::SSID_7.png[scaledwidth="100%",alt="SSID step 7"]

* Then you have to create two ACLs - one to deny all traffic except the required one to hit the portal (Pre-Auth-For-WebRedirect ) and the other
one to allow anything (Authorize_any) .

image::ACL.png[scaledwidth="100%",alt="ACL"]

* Then the last step is to configure the WLC in PacketFence.
Role by Web Auth URL

image::wlc_packetfence.png[scaledwidth="100%",alt="ACL"]

Role definition

image::wlc_packetfence2.png[scaledwidth="100%",alt="ACL"]

Wireless LAN Controller (WLC) IPSK
++++++++++++++++++++++++++++++++++

In this section, we cover the basic configuration of the WLC IPSK feature.
Starting from WLC 8.5 release, Cisco introduces the IPSK feature.
Identity PSKs are unique pre-shared keys created for individuals or groups of users on the same SSID.

In this section we will cover the WLC configuration and the PacketFence configuration.

WLC Configuration:


* First, globally define the RADIUS server running on PacketFence
  (PacketFence's IP) and make sure _Support for RFC 3576_ (also called _Support for CoA_) is enabled. When the option is missing from your WLC, it is enabled by default.

* Next, configure a new SSID like in the following screenshots

image::ipsk1.png[scaledwidth="100%",alt="SSID step 1"]

image::ipsk2.png[scaledwidth="100%",alt="SSID step 2"]

image::ipsk_radius.png[scaledwidth="100%",alt="SSID step 3"]

image::ipsk_advanced.png[scaledwidth="100%",alt="SSID step 4"]

PacketFence Configuration:

* First because there is no way to detect in the RADIUS request that the request is for an SSID configured for IPSK, you need to configure PacketFence to trigger IPSK on a connection profile.
  To do that, create a new connection profile, set a Filter based on the SSID (Example SSID PSK_SSID), enable IPSK and set a default PSK key.
  So each time a device will connect on this specific SSID PacketFence will know that it has to answer with specific VSA attributes.

* Second step is to associate the device to a user, you have two ways to do it, the first one is to manually edit an user and in Miscellaneous tab fill the PSK entry (8 characters minimum) then edit
  a node and change the owner with the one you just edit before.
  The second way to associate the device is to use a provisioner. There are also 2 ways to do it, use the "IPSK" provisioner (it will show you a page on the portal with the PSK key to use and the 
  SSID to connect to, or use the "Windows/Apple Devices/Android" provisioner and configure it to do IPSK.

image::dpsk_provisioner.png[scaledwidth="100%",alt="Provisioner IPKS"]


Troubleshooting ignored RADIUS replies
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

In the event the WLC ignores the RADIUS replies from PacketFence (you receive multiple requests but access is never granted), validate the following elements : 

* RADIUS secret is properly configured in PacketFence and the WLC controller.
* The SSL certificate used by PacketFence is not expired.

Device Sensor
^^^^^^^^^^^^^

When using a Cisco WLC, you can enable device sensor by making sure the configuration looks like the following screenshot:

image::wlc-device-sensor.png[scaledwidth="100%",alt="Device Sensor"]

NOTE: Please refer to the wired configuration of Cisco equipment to learn more about device sensor.

// CoovaChilli

include::networkdevice/coovachilli.asciidoc[]


D-Link
~~~~~~

DWL Access-Points and DWS 3026
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

NOTE: To be contributed...


Extricom
~~~~~~~~

EXSW Wireless Switches (Controllers)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

In order to have the Extricom controller working with PacketFence, you need to define two ESSID definition, one for the "public" network, and one for the "secure" network. This can be done under a very short time period since Extricom supports RADIUS assigned VLANs out of the box.

You first need to configure you RADIUS server. This is done under the: *WLAN Settings -> RADIUS* tab. Enter the PacketFence RADIUS server information. For the ESSID configuration. in the administration UI, go to *WLAN Settings -> ESSID definitions*. Create the profiles per the following:

[float]
Public SSID
+++++++++++

* MAC Authentication must be ticked
* Encryption method needs to be set to None
* Select PacketFence as the MAC Authentication RADIUS server (previously added)

[float]
Secure SSID
+++++++++++

* Encryption method needs to be set to WPA Enterprise/WPA2 Enterprise
* AES only needs to be selected
* Select PacketFence as the RADIUS server (previously added)

The final step is to enable SNMP Agent and SNMP Traps on the controller. This is done under the following tab in the administrative UI: *Advanced -> SNMP*.

Fortinet FortiGate
~~~~~~~~~~~~~~~~~~

This section shows how to configure a 802.1X SSID on a Fortigate 50E running on FortiOS 5.4.

You will need to have the CLI access on the Fortigate to do the configuration.

RADIUS
^^^^^^

 FGT50E # config user radius 
 FGT50E (radius) # edit packetfence
 new entry 'packetfence' added
 FGT50E (packetfence) # set server 192.168.1.5
 FGT50E (packetfence) # set secret useStrongerSecret
 FGT50E (packetfence) # set nas-ip 192.168.1.1
 FGT50E (packetfence) # set radius-coa enable 
 FGT50E (packetfence) # config accounting-server 
 FGT50E (accounting-server) # edit 1
 new entry '1' added
 FGT50E (1) # set status enable
 FGT50E (1) # set server 192.168.1.5
 FGT50E (1) # set secret useStrongerSecret
 FGT50E (1) # end
 FGT50E (packetfence) # end

802.1X SSID
^^^^^^^^^^^

 FGT50E #config wireless-controller vap
 FGT50E (vap) # edit PF-Secure
 new entry 'PF-Secure' added
 FGT50E (PF-Secure) # edit "PF-Secure"
 FGT50E (PF-Secure) # set vdom "root"
 FGT50E (PF-Secure) # set ssid "PF-Secure"
 FGT50E (PF-Secure) # set security wpa2-only-enterprise
 FGT50E (PF-Secure) # set auth radius
 FGT50E (PF-Secure) # set radius-server "packetfence"
 FGT50E (PF-Secure) # set schedule "always"
 FGT50E (PF-Secure) # set local-bridging enable
 FGT50E (PF-Secure) # set dynamic-vlan enable
 FGT50E (PF-Secure) # end

// Hostapd

include::networkdevice/hostapd.asciidoc[]

Huawei
~~~~~~

AC6605 Controller
^^^^^^^^^^^^^^^^^

PacketFence supports this controller with the following technologies:

* Wireless 802.1X
* Wireless MAC Authentication

Controller configuration
+++++++++++++++++++++++++

Setup NTP server:

	<AC>system-view
	[AC] ntp-service unicast-server 208.69.56.110

Setup the radius server (@IP of PacketFence) authentication + accounting:

[NOTE]
===============================
In this configuration I will use the ip address of the VIP of PacketFence: 192.168.1.2; Registration VLAN : 145, Isolation VLAN : 146
===============================

	<AC>system-view
	[AC] radius-server template radius_packetfence
	[AC-radius-radius_packetfence] radius-server authentication 192.168.1.2 1812 weight 80
	[AC-radius-radius_packetfence] radius-server accounting 192.168.1.2 1813 weight 80
	[AC-radius-radius_packetfence] radius-server shared-key cipher s3cr3t
	[AC-radius-radius_packetfence] undo radius-server user-name domain-included
	[AC-radius-radius_packetfence] quit
	[AC] radius-server authorization 192.168.1.2 shared-key cipher s3cr3t server-group radius_packetfence
	[AC] aaa
	[AC-aaa] authentication-scheme radius_packetfence
	[AC-aaa-authen-radius_packetfence] authentication-mode radius
	[AC-aaa-authen-radius_packetfence] quit
	[AC-aaa] accounting-scheme radius_packetfence
	[AC-aaa-accounting-radius_packetfence] accounting-mode radius
	[AC-aaa-accounting-radius_packetfence] quit
	
	[AC-aaa] domain your.domain.com
	[AC-aaa-domain-your.domain.com] authentication-scheme radius_packetfence
	[AC-aaa-domain-your.domain.com] accounting-scheme radius_packetfence
	[AC-aaa-domain-your.domain.com] radius-server radius_packetfence
	[AC-aaa-domain-your.domain.com] quit
	[AC-aaa] quit

Create an Secure dot1x SSID
+++++++++++++++++++++++++++

Activate the dotx globally:

	<AC>system-view
	[AC] dot1x enable

Create your secure dot1x ssid:

Configure WLAN-ESS 0 interfaces:
	
	[AC] interface Wlan-Ess 0
	[AC-Wlan-Ess0] port hybrid untagged vlan 145 to 146
	[AC-Wlan-Ess0] dot1x enable
	[AC-Wlan-Ess0] dot1x authentication-method eap
	[AC-Wlan-Ess0] permit-domain name your.domain.com
	[AC-Wlan-Ess0] force-domain name your.domain.com
	[AC-Wlan-Ess0] default-domain your.domain.com
	[AC-Wlan-Ess0] quit

Configure AP parameters:
+++++++++++++++++++++++
	
Configure radios for APs:

	[AC] wlan
	[AC-wlan-view] wmm-profile name huawei-ap
	[AC-wlan-wmm-prof-huawei-ap] quit
	[AC-wlan-view] radio-profile name huawei-ap
	[AC-wlan-radio-prof-huawei-ap] radio-type 80211gn
	[AC-wlan-radio-prof-huawei-ap] wmm-profile name huawei-ap
	[AC-wlan-radio-prof-huawei-ap] quit
	[AC-wlan-view] ap 1 radio 0
	[AC-wlan-radio-1/0] radio-profile name huawei-ap
	Warning: Modify the Radio type may cause some parameters of Radio resume defaul
	t value, are you sure to continue?[Y/N]: y
	[AC-wlan-radio-1/0] quit
	
Configure a security profile named huawei-ap. Set the security policy to WPA authentication, authentication method to 802.1X+PEAP, and encryption mode to CCMP:

	[AC-wlan-view] security-profile name huawei-ap-wpa2
	[AC-wlan-sec-prof-huawei-ap-wpa2] security-policy wpa2
	[AC-wlan-sec-prof-huawei-ap-wpa2] wpa-wpa2 authentication-method dot1x encryption-method ccmp
	[AC-wlan-sec-prof-huawei-ap-wpa2] quit

Configure a traffic profile:

	[AC-wlan-view] traffic-profile name huawei-ap
	[AC-wlan-wmm-traffic-huawei-ap] quit

Configure service sets for APs, and set the data forwarding mode to direct forwarding:

The direct forwarding mode is used by default.
	
	[AC-wlan-view] service-set name PacketFence-dot1x
	[AC-wlan-service-set-PacketFence-dot1x] ssid PacketFence-Secure
	[AC-wlan-service-set-PacketFence-dot1x] wlan-ess 0
	[AC-wlan-service-set-PacketFence-dot1x] service-vlan 1
	[AC-wlan-service-set-PacketFence-dot1x] security-profile name huawei-ap-wpa2
	[AC-wlan-service-set-PacketFence-dot1x] traffic-profile name huawei-ap
	[AC-wlan-service-set-PacketFence-dot1x] forward-mode tunnel
	[AC-wlan-service-set-PacketFence-dot1x] quit

Configure VAPs and deliver configurations to the APs:

	[AC-wlan-view] ap 1 radio 0
	[AC-wlan-radio-1/0] service-set name PacketFence-dot1x
	[AC-wlan-radio-1/0] quit
	[AC-wlan-view] commit ap 1

Create your Open ssid
+++++++++++++++++++++

Activate the mac-auth globally:

	<AC>system-view
	[AC] mac-authen
	[AC] mac-authen username macaddress format with-hyphen
	[AC] mac-authen domain your.domain.com

Create your Open ssid:

Configure WLAN-ESS 1 interfaces:

	[AC] interface Wlan-Ess 1
	[AC-Wlan-Ess1] port hybrid untagged vlan 145 to 146
	[AC-Wlan-Ess1] mac-authen
	[AC-Wlan-Ess1] mac-authen username macaddress format without-hyphen
	[AC-Wlan-Ess1] permit-domain name your.domain.com
	[AC-Wlan-Ess1] force-domain name your.domain.com
	[AC-Wlan-Ess1] default-domain your.domain.com
	[AC-Wlan-Ess1] quit

Configure AP parameters:

Configure a security profile named huawei-ap-wep. Set the security policy to WEP authentication.
	
	[AC]wlan
	[AC-wlan-view] security-profile name huawei-ap-wep
	[AC-wlan-sec-prof-huawei-ap-wep] security-policy wep
	[AC-wlan-sec-prof-huawei-ap-wep] quit

Configure service sets for APs, and set the data forwarding mode to direct forwarding:

The direct forwarding mode is used by default.
	
	[AC-wlan-view] service-set name PacketFence-WEP
	[AC-wlan-service-set-PacketFence-WEP] ssid PacketFence-Open
	[AC-wlan-service-set-PacketFence-WEP] wlan-ess 1
	[AC-wlan-service-set-PacketFence-WEP] service-vlan 1
	[AC-wlan-service-set-PacketFence-WEP] security-profile name huawei-ap-wep
	[AC-wlan-service-set-PacketFence-WEP] traffic-profile name huawei-ap (already created before)
	[AC-wlan-service-set-PacketFence-WEP] forward-mode tunnel
	[AC-wlan-service-set-PacketFence-WEP] quit

Configure VAPs and deliver configurations to the APs:

	[AC-wlan-view] ap 1 radio 0
	[AC-wlan-radio-1/0] service-set name PacketFence-WEP
	[AC-wlan-radio-1/0] quit
	[AC-wlan-view] commit ap 1



Meraki
~~~~~~

To add the AP on PacketFence use the internal IP of the AP.

The 'Disconnect port' field must be set to '1700'.

WebAuth
^^^^^^^

In this section, we will cover the configuration of the Meraki controller to use Web authentication.

NOTE: While using the WebAuth mode on the Meraki controller, you need to use "Role mapping by Switch Role" and "Role by Web Auth URL" in the tab 'Roles' from the switch configuration.

Configure your SSID as shown below:

image::Meraki-V2-1.png[scaledwidth="100%",alt="Security and RADIUS configuration"]

image::Meraki-V2-2.png[scaledwidth="100%",alt="Network configuration"]

NOTE: It is mandatory that you use the Airespace-ACL-Name as "RADIUS attribute specifying group policy name".

The switch module to use for this configuration is "Meraki cloud controller V2".

Next, configure the roles for the devices on your network. Go in 'Network-wide->Group policies', then you will be able to create policies that can be configured as roles in the switch configuration of PacketFence. Creation of the policy `Guest`:

image::Meraki-config-policy.png[scaledwidth="100%",alt="Group policies"]

Your configuration for the tab "Roles" in PacketFence will look like the following:

image::meraki-config-pf-role.png[scaledwidth="100%",alt="PacketFence role configuration"]

image::meraki-config-pf-url.png[scaledwidth="100%",alt="PacketFence URL configuration"]

URL in registration field should be in the form: 'http://<your_captive_portal_ip>/Meraki::MR_v2'

VLAN enforcement
^^^^^^^^^^^^^^^^

This section will cover how to configure the Meraki WiFI controller to use with VLAN enforcement, use the configuration in the section `WebAuth` for the SSID.

In the configuration of PacketFence, use "Role by VLAN ID" and fill your VLANs matching roles.

image::meraki-vlan-pf.png[scaledwidth="100%",alt="PacketFence role configuration"]

Switch MS220-8
++++++++++++++

NOTE: You should already have one port setup as Uplink, using a mode trunk, with at least your Registration and Production VLAN allowed on it.

The Meraki switch offer configuration for VLAN enforcement only.

You will need to access the Meraki dashboard to configure your switch. When you reach it you will need first to create a policy. You can create a "MAC authentication bypass" or a "802.1X" policy. Depending if you want to authenticate user via dot1x or MAB. You cannot combine both neither use a fallback mode on the same port, each port with a policy applied will be exclusive to MAB or dot1x.

To access the policy creation go to 'Switch->Access policies' in the Meraki dashboard menu. From there create a new policy, use the example below to create your policy.

image::Meraki-switch-policies.png[scaledwidth="100%",alt="Access policies"]

You now need to apply one of your policies to ports. To do so, go to 'Switch->Switch ports' and chose your options. To add a policy you created earlier, select it in the drop down list in `Access policy`. You need to configure the port in "mode access", the default access VLAN is not important if your VLANs are properly configured on PacketFence.

image::Meraki-switch-port.png[scaledwidth="100%",alt="Switch Ports"]

RADSEC
++++++

It is possible to use RADSEC between Meraki and PacketFence in order to perform RADIUS over TCP and encrypted using TLS. Before performing the steps outlined in this section, make sure you have a working SSID using normal unencrypted RADIUS by following the steps in the sections above

Then, in order to enable RADSEC, go in your SSID configuration and under 'RADIUS proxy', select 'Use Meraki proxy' and save the settings.

After saving, check the RADSEC checkbox and save your settings.

Now, on your PacketFence server, you must add the Meraki CA root to the trusted Certificate Authorities of FreeRADIUS when performing RADSEC. You should download the Meraki CA certificate from here http://changeme.com/meraki-root.crt and append it to the content of /usr/local/pf/raddb/certs/ca.pem on your PacketFence server.

Next, restart radiusd to reload the CA certificates using:

  # /usr/local/pf/bin/pfcmd service radiusd restart

NOTE: RADSEC is done over port 2083 so make sure your server is available via a public IP address for this port and allows connections from your Meraki cloud controller. Refer to the Meraki documentation for details.

Mikrotik
~~~~~~~~

This configuration has been tested on Access Point OmniTIK U-5hnD with RouterOS v6.18 and only MAC-Authentication is available now.
The only deauthentication method available is SSH, so create an account in the Mikrotik AP and fill the information in PacketFence switch configuration.
Also don't forget to use the pf account to ssh on the Access Point to receive the ssh key.

[float]
Open SSID
^^^^^^^^^

In this setup we use the interface ether5 for the bridge (Trunk interface) and ether1 as the management interface.

Configure your access point with the following configuration:

  /interface wireless
  # managed by CAPsMAN
  # channel: 5180/20-Ce/an(17dBm), SSID: OPEN, local forwarding
  set [ find default-name=wlan1 ] band=5ghz-a/n channel-width=20/40mhz-Ce disabled=no l2mtu=1600 mode=ap-bridge ssid=MikroTik-05A64D
  /interface ethernet
  set [ find default-name=ether1 ] name=ether1-gateway
  set [ find default-name=ether2 ] name=ether2-master-local
  set [ find default-name=ether3 ] master-port=ether2-master-local name=ether3-slave-local
  set [ find default-name=ether4 ] master-port=ether2-master-local name=ether4-slave-local
  set [ find default-name=ether5 ] name=ether5-master-local
  /interface vlan
  add interface=BR-CAPS l2mtu=1594 name=default vlan-id=1
  add interface=BR-CAPS l2mtu=1594 name=isolation vlan-id=3
  add interface=BR-CAPS l2mtu=1594 name=registration vlan-id=2
  /caps-man datapath
  add bridge=BR-CAPS client-to-client-forwarding=yes local-forwarding=yes name=datapath1
  /caps-man interface
  # 
  add arp=enabled configuration.mode=ap configuration.ssid=OPEN datapath=datapath1 disabled=no l2mtu=1600 mac-address=\
      D4:CA:6D:05:A6:4D master-interface=none mtu=1500 name=cap1 radio-mac=D4:CA:6D:05:A6:4D
  /caps-man aaa
  set interim-update=5m
  /caps-man access-list
  add action=query-radius interface=cap1 radius-accounting=yes signal-range=-120..120 time=0s-1d,sun,mon,tue,wed,thu,fri,sat
  /caps-man manager
  set enabled=yes
  /interface bridge port
  add bridge=bridge-local interface=ether2-master-local
  add bridge=bridge-local interface=ether1-gateway
  add bridge=BR-CAPS interface=ether5-master-local
  /interface wireless cap
  set bridge=BR-CAPS discovery-interfaces=BR-CAPS enabled=yes interfaces=wlan1
  /ip accounting
  set enabled=yes
  /radius
  add address=192.168.1.5 secret=useStrongerSecret service=wireless
  /radius incoming
  set accept=yes

Webauth
^^^^^^^

You can use webauth (external captive portal) on Mikrotik APs. In order to do so, you will have to activate the hotspot feature in the AP configuration as well as modify the redirection template so that it points to PacketFence.

First, you must establish an FTP connection to your access point and replace the content of `hotspot/login.html` with the following:

  <html>
  <head><title>...</title></head>
  <body>
  $(if chap-id)
  <noscript>
  <center><b>JavaScript required. Enable JavaScript to continue.</b></center>
  </noscript>
  $(endif)
  <center>If you are not redirected in a few seconds, click 'continue' below<br>
  <form name="redirect" action="http://192.168.1.5/Mikrotik" method="get">
    <input type="hidden" name="mac" value="$(mac)">
    <input type="hidden" name="ip" value="$(ip)">
    <input type="hidden" name="username" value="$(username)">
    <input type="hidden" name="link-login" value="$(link-login)">
    <input type="hidden" name="link-orig" value="$(link-orig)">
    <input type="hidden" name="error" value="$(error)">
    <input type="hidden" name="chap-id" value="$(chap-id)">
    <input type="hidden" name="chap-challenge" value="$(chap-challenge)">
    <input type="hidden" name="link-login-only" value="$(link-login-only)">
    <input type="hidden" name="link-orig-esc" value="$(link-orig-esc)">
    <input type="hidden" name="mac-esc" value="$(mac-esc)">
    <input type="hidden" name="ap-id" value="AP_IP_ADDRESS_HERE">
    <input type="submit" value="continue">
  </form>
  <script language="JavaScript">
  <!--
     document.redirect.submit();
  //-->
  </script></center>
  </body>
  </html>

Next, in the `login.html` you have just uploaded, make sure you change `AP_IP_ADDRESS_HERE` by the management IP address of your access point and `192.168.1.5` by the IP address of your PacketFence captive portal.

Now, you must configure the hotspot feature on your AP. This configuration is done on top of an existing SSID you have previously configured which is on interface `wlan1`. Adjust the interface name if needed.

  /ip hotspot
  setup

  hotspot interface: wlan1

  local address of network: 10.5.50.1/24
  masquerade network: yes
  
Set pool for HotSpot addresses 

  address pool of network: 10.5.50.2-10.5.50.254

Select hotspot SSL certificate 

  select certificate: none

Select SMTP server 

  ip address of smtp server: 0.0.0.0
  
Setup DNS configuration 

  dns servers: 8.8.8.8
  
DNS name of local hotspot server 

  dns name: myhotspot
  
Create local hotspot user 

  name of local hotspot user: admin
  password for the user: 


Next, you need to allow access to the PacketFence portal in the hotspot access list. Change `192.168.1.5` with the IP address you pointed to in `login.html`

  /ip hotspot walled-garden
  add dst-host=192.168.1.5
  add src-address=192.168.1.5

  /ip hotspot walled-garden ip
  add action=accept disabled=no dst-host=192.168.1.5
  add action=accept disabled=no src-address=192.168.1.5

Now, you will also need to configure the hotspot to point to your PacketFence RADIUS server:

  /radius
  add address=192.168.1.5 secret=useStrongerSecret service=hotspot

  /ip hotspot profile
  add hotspot-address=10.5.50.1 name=hsprof1 use-radius=yes

Next, you need to configure PacketFence to use webauth for this Access Point using the following `switches.conf` configuration. Change `AP_IP_ADDRESS_HERE` by the IP address you've put in login.html.

  [AP_IP_ADDRESS_HERE]
  VlanMap=Y
  RoleMap=N
  mode=production
  ExternalPortalEnforcement=Y
  type=Mikrotik
  radiusSecret=useStrongerSecret
  registrationVlan=-1

HP
~~

ProCurve Controller MSM710
^^^^^^^^^^^^^^^^^^^^^^^^^^

  To be contributed...

Meru
~~~~

Meru Controllers (MC)
^^^^^^^^^^^^^^^^^^^^^

In this section, we cover the basic configuration of the Meru wireless controller for PacketFence via the web GUI.

[float]
Disable PMK Caching
+++++++++++++++++++

If you are running a WPA2 SSID, you may need to disable PMK caching in order to avoid deauthentication issues.  This is true if you are running AP 300s using any 5.0 versions including 5.0-87, or any versions below 4.0-160.

Here are the commands to run to disable the PMK caching at the AP level.  First, login the AP, and run this command to see which radios are broadcasting your SSID.
   vap display

Second, disable the PMK caching on those radios.
   radio pmkid radio00 disable

You can also add those commands to the AP bootscript.  Contact your Meru support representative for that part.

[float]
VLAN Definition
+++++++++++++++

Here, we create our PacketFence VLANs for client use. Go to *Configuration -> Wired -> VLAN*, and select Add.

* VLAN Name is the human readable name (ie. RegistrationVLAN)
* Tag is the VLAN ID
* Fast Ethernet Interface Index refers to the controller's ethernet interface
* IP Address – An IP address for this controller on this VLAN
* Netmask – Network mask for this VLAN
* IP Address of the default gateway – Wired IP router for this VLAN
* Set the Override Default DHCP server flag to off
* Leave the DHCP server IP address and the DHCP relay Pass-Through to default

Click *OK* to add the VLAN.

[float]
AAA Authentication Server 
+++++++++++++++++++++++++

Here, we create our PacketFence RADIUS server for use. Under *Configuration -> Security -> Radius*, select *Add*.

* Give the RADIUS Profile a name
* Write a description of the profile
* Give the RADIUS IP, RADIUS Secret and the RADIUS authentication port
* Select Colon for the MAC address delimiter
* Select MAC Address as the password type

Click *OK* to add the RADIUS profile.

[float]
AAA Accounting Server 
+++++++++++++++++++++

Here, we create our PacketFence RADIUS server for use. Under *Configuration -> Security -> Radius*, select *Add*.

* Give the RADIUS Profile a name
* Write a description of the profile
* Give the RADIUS IP, RADIUS Secret and the RADIUS accounting port
* Select Colon for the MAC address delimiter
* Select MAC Address as the password type

Click *OK* to add the RADIUS accounting profile.

[float]
AAA Profiles – Open SSID
++++++++++++++++++++++++

Here, we create our wireless security profiles for use. 
Under *Configuration -> Security -> Profile*, select *Add*.

* Give the security profile a name
* Select Clear as the L2 Modes Allowed
* Leave Data Encrypt empty
* Disable the Captive Portal
* Enable the Mac Filtering

Click *OK* to save the profile.

[float]
MAC Filtering
+++++++++++++

When using the OpenSSID, you need to activate the mac filtering. 
Under *Configuration -> Mac Filtering*:

* Set ACL Environment State to Permit list enabled
* Select your RADIUS profile

[float]
AAA Profiles – Secure SSID
++++++++++++++++++++++++++

Here, we create our wireless security profiles for use. 
Under *Configuration -> Security -> Profile*, select *Add*.

* Give the security profile a name
* Select WPA2 as the L2 Modes Allowed
* Select CCMP-AES for Data Encrypt
* Select your PacketFence RADIUS Authentication Profile
* Disable the Captive Portal
* Enable the 802.1X network initiation
* Leave the Mac Filtering to off

Click *OK* to save the profile.

[float]
WLAN SSIDs
++++++++++

Here, we create our SSID and tie it to a security profile. 
Under *Configuration -> Wireless -> ESS*, select *Add*.

* Give the ESS profile a name, and enable it
* Write an SSID name
* Select your security profile name previously created
* Select your PacketFence RADIUS Accounting Profile (if you want to do accounting)
* Enable the SSID Broadcast
* Make the new AP to join the ESS
* Set the tunnel interface type to RADIUS and Configured VLAN
* Select the registration VLAN for the VLAN Name

Click *OK* to create the SSID. Repeat those steps for the open and secure SSID by choosing the right security profile.

[float]
WLAN SSIDs – Adding to access point
+++++++++++++++++++++++++++++++++++

Here, we tie our SSIDs to access points. 
Under *Configuration -> Wireless -> ESS*, select the SSID you want to add to your aps. Then, select the *ESS-AP Table*, and click *Add*.

* Select the AP ID from the drop down list
* Click *OK* to associate the SSID with this AP

[float]
Roles (Per-User Firewall)
+++++++++++++++++++++++++

Since PacketFence 3.3.0, we now support roles (per-user firewall rules) for the Meru hardware.  To add firewall rules, go in *Configuration -> QoS System Settings -> QoS and Firewall Rules*.  When you add a rule, you have to pay attention to two things:

* The rule is applied to the controller physical interface right away, so make sure you are not too wide on your ACL to lock you out!
* The rules are grouped using the Firewall Filter ID (We will use this ID for the roles)

So, since the matching is done using the Firewall Filter ID configuration field, your roles line in switches.conf would look like :

   roles=Guests=1;Staff=2

NOTE: You need to have the *Per-User Firewall* license in order to benefit this feature.

Mojo Networks
~~~~~~~~~~~~~

PacketFence supports SSIDs configured with 802.1X and Web Authentication

Create the RADIUS Profile
^^^^^^^^^^^^^^^^^^^^^^^^^

First, create a RADIUS Profile for PacketFence.

* Login to the https://dashboard.mojonetworks.com
* Go to *Wireless Manager*
* Then click on *Configuration -> Device Configuration -> RADIUS Profiles -> Add a RADIUS Profile* 

   Profile Name: NAME_OF_PROFILE_FOR_PACKETFENCE
   IP Address: IP_OF_PACKETFENCE
   Authentication Port: 1812
   Accounting Port: 1813
   Shared Secret: useStrongerSecret

Click on 'Save'.

Configure the SSID:
^^^^^^^^^^^^^^^^^^^

[float]
802.1X Secure
+++++++++++++

* Login to the https://dashboard.mojonetworks.com
* Go to *Wireless Manager*
* Then click on *Configuration -> Device Configuration -> SSID Profiles -> Add a new Profile -> WLAN* 

NOTE: (Leave the default configuration for the other settings)

   Profile Name: PF-Secure-802.1X
   SSID: PF-Secure
   Security: WPA2; 802.1X
   NAS ID: %m-%s
   Dynamic VLANs: Enable VLAN Pool 1,2,4,5 (All VLANs that you will use)
   Called-Station-ID: %m-%s
   COA: Checked

   RADIUS Authentication
    Primary Authentication Server: PacketFence RADIUS profile created above.

   RADIUS Accounting Server Details
    Primary Accounting Server: PacketFence RADIUS profile created above.

Click the 'Save' button to save the PF-Secure SSID configuration.

[float]
Web Authentication
++++++++++++++++++

To enable the external captive portal, go to the *SSID Profiles* page in *Device Configuration*. Add a new Wi-Fi profile with the following attributes:

   Profile Name: Name of the new profile
   SSID: Name of your SSID
   Security: Open

image::mojo-security.png[scaledwidth="100%",alt="Mojo Security"]   
   
   Network: VLAN ID for clients

image::mojo-network-vlan.png[scaledwidth="100%",alt="Mojo Network"]

   Captive Portal: select and fill in External Splash Page with RADIUS Authentication with “http://IP_OR_HOSTNAME_OF_PACKETFENCE/Mojo” and the RADIUS shared secret. Click on *RADIUS Settings* to select PacketFence as authentication and accounting server.

image::mojo-external-splash.png[scaledwidth="100%",alt="Mojo External Splash Page"]

   On the right, add the IP address or hostname of PacketFence to the Walled Garden Sites.

image::mojo-walled-garden.png[scaledwidth="100%",alt="Mojo Walled Garden"]

Save the newly created profile.

Broadcast the SSID on the Access Point:
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

* Go to *Configuration -> Device Template -> System Template* 
* Then *Radio Settings -> Define settings for model -> Chose your AP model*
* Finally *Radio 1 - 2x2 b/g/n Configuration -> Add SSID Profile -> Select your SSID profile previously created(802.1X or Web authentication profile) -> Ok*

Click the 'Save' button to broadcast the PF-Secure SSID.

Configure the Mojo Networks AP in PacketFence:
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

[float]
802.1X
++++++

Add a Switch with the IP address of the Access Point (AP) with the following configuration:

* Go to *Configuration -> Network -> Switches -> Add switch to group -> Default*

   Definition:
    IP Address/MAC Address/Range (CIDR): Local IP of the AP
    Description: Mojo Networks Access Point
    Type: Mojo Networks AP
    Mode: Production
    Switch Group: None
    Deauthentication Method: RADIUS
    Use CoA: Checked

   Roles:
    Role by VLAN ID: Checked
    registration: 2
    isolation: 3
    guest: 5
    default: 1

   NOTE: Role by VLAN ID remain the only category checked.

   Radius:
    Secret Passphrase: useStrongerSecret

[float]
Web Authentication
++++++++++++++++++

Add a switch with the IP address fo the Access Point (AP) with the following configuration:

* Go to *Configuration -> Network -> Switches -> Add switch to group -> Default*

   Definition:
    IP Address/MAC Address/Range (CIDR): Local IP of the AP
    Description: Mojo Networks Access Point
    Type: Mojo Networks AP
    Mode: Production
    Switch Group: None
    Deauthentication Method: RADIUS
    Use CoA: Checked

   Roles:
    Uncheck Role by VLAN ID

   Radius:
    Secret Passphrase: useStrongerSecret

Click the 'Save' button to save the AP configuration.

IMPORTANT: Clone the newly created switch and enter *192.0.2.254* or the MAC address of the AP.

Motorola
~~~~~~~~

In order to have the Motorola RFS controller working with PacketFence, you
need to define two Wireless LANs definition, one for the "public" network,
and one for the "secure" network.

WiNG (Firmware >= 5.0)
^^^^^^^^^^^^^^^^^^^^^^

[float]
AAA Policy (RADIUS server)
++++++++++++++++++++++++++

First, we need to build the AAA Policy. Under *Configuration -> Wireless -> AAA Policy*, click on the *Add* button at the bottom right. Configure the RADIUS profile like the following:

* Host: Choose IP Address in the drop down, and put the RADIUS server (PF) IP
* Insert a RADIUS secret passphrase
* Select "Through Wireless Controller" Request Mode

CAUTION: Since we are using RADIUS Dynamic Authorization, we need to enable the RADIUS accounting. Under the RADIUS accounting tab, click the Add button at the bottom right, and insert the proper values.

[float]
Open SSID
+++++++++

Under *Configuration -> Wireless -> Wireless LANs*, click on the *Add* button at the bottom right. Under Basic Configuration:

* Profile Name : Give a convenient name
* SSID: This is the ESSID name
* Ensure that the WLAN Status is set to enable
* Select Single VLAN as VLAN assignment technique
* Ensure that "Allow RADIUS Override" is selected

.Security configuration:
* Select MAC as authentication type
* Select your AAA Policy previously created
* Ensure that you selected Open as the Encryption

.Accounting configuration:
* Make sure you select "Enable RADIUS Accounting"
* Select the previously configured AAA Policy

.Advanced configuration:
* Make sure you select RADIUS Dynamic Authorization

[float]
Secure SSID
+++++++++++

Under *Configuration -> Wireless -> Wireless LANs*, click on the *Add* button at the bottom right. Under Basic Configuration:

* Profile Name : Give a convenient name
* SSID: This is the ESSID name
* Ensure that the WLAN Status is set to enable
* Select Single VLAN as VLAN assignment technique
* Ensure that "Allow RADIUS Override" is selected

.Security configuration:
* Select EAP as authentication type
* Select your AAA Policy previously created
* Ensure that you selected WPA/WPA2-TKIP as the Encryption
* Unselect everything under Fast Roaming (Disable caching)

.Accounting configuration:
* Make sure you select "Enable RADIUS Accounting"
* Select the previously configured AAA Policy

.Advanced configuration:
* Make sure you select RADIUS Dynamic Authorization

[float]
Profile (WLAN Mapping)
++++++++++++++++++++++

You have multiple options here. Either, you create a general AP profile, and you assign it to your Aps, or you modify the AP device configuration to map the WLAN to the radio interfaces. For the purpose of this document, we will modify the general profile. Under *Profiles -> default-apXXX* (where XXX is your AP model), in *Interface -> Radios*, edit the existing radios settings. Go to the *WLAN Mapping* tab, select the two SSIDs and click on the *<<* button.

[float]
Profile (Management)
++++++++++++++++++++

Here, we can configure our SNMP community strings. Located in *Configuration -> Management -> Management Policy*. Again, you can modify the default one, or you can create a brand new Policy.

[float]
VLANs
+++++

You need to ensure that the uplink interface of the controller is configured as a trunk, and that all the necessary VLANs are created on the device. This is configured under *Device -> rfsXXXX-MAC* (where XXXX is your controller series, and MAC is the latest 3 octets of its mac address). Edit the device configuration, and go to *Interface -> Ethernet Ports*. Ensure that the up1 interface is set as trunk, with all the allowed VLANs. Next, create the VLAN under *Interface -> Virtual Interfaces*.

[float]
Roles (Per-User Firewall)
+++++++++++++++++++++++++

Since PacketFence 3.3.0, we now support roles for the Motorola hardware using WiNGS 5.x.  To add roles, go in *Configuration -> Security -> Wireless Client Roles*.  First create a global policy that
will contain your roles.  Next, create your Roles by clicking on the *Add* button on the bottom right.  It is important to configure the Group Configuration line properly by setting the string
name that we will use in the RADIUS packet.  For example, for a Guests Role, you can put *Group Configuration Exact Guests*, and for a Staff Roles, you can put *Group Configuration Exact Staff*. 
In the roles configuration in switches.conf, you would have something like :

   roles=CategoryGuests=Guests;CategoryStaff=Staff

Finally, don't forget to configure the appropriate firewall rules for your Roles!  Make sure also to commit the configuration upon your changes.

NOTE: You need to have an *Advanced Security* license to enable the Per-User Firewall feature.

WIPS
++++

In order to enable the WIPS functionality on the Motorola, you need to follow this procedure.  The steps have been done using the CLI.

First, Create a wips-policy:

   wips-policy Rogue-AP
   history-throttle-duration 86400
   event ap-anomaly airjack
   event ap-anomaly null-probe-response
   event ap-anomaly asleap
   event ap-anomaly ad-hoc-violation
   event ap-anomaly ap-ssid-broadcast-in-beacon
   event ap-anomaly impersonation-attack
   ap-detection

Next, create an event policy:

   event-system-policy PF-WIDS
   event wips wips-event syslog off snmp on forward-to-switch off email off

Next, create or adjust your management policy to configure the SNMP traps.  Here is an example policy, please note the two last lines:

   management-policy default
   no http server
   https server
   ssh
   user admin password 1 e4c93663e3356787d451312eeb8d4704ef09f2331a20133764c3dc3121f13a5b role superuser access all
   user operator password 1 7c9b1fbb2ed7d5bb50dba0b563eac722b0676b45fed726d3e4e563b0c87d236d role monitor access all
   no snmp-server manager v3
   snmp-server community public ro
   snmp-server community private rw
   snmp-server user snmpoperator v3 encrypted des auth md5 0 operator
   snmp-server user snmptrap v3 encrypted des auth md5 0 motorola
   snmp-server user snmpmanager v3 encrypted des auth md5 0 motorola
   snmp-server enable traps
   snmp-server host 10.0.0.100 v2c 162

You then need to tell your controller to use the event policy:

   rfs6000 5C-0E-8B-17-F2-E3
   ...
   use event-system-policy PF-WIDS

Finally, you need to configure a radio interface on your AP to act as a sensor.  Here is an example configuration for a dual-radio AP650:

   ap650 00-23-68-86-EB-BC
   use profile default-ap650
   use rf-domain default
   hostname ap650-86EBBC
   country-code ca
   use wips-policy Rogue-AP
   interface radio1
   rf-mode sensor
   channel smart
   power smart
   data-rates default
   no preamble-short
   radio-share-mode off
   interface radio2
   ...


Older Firmwares (< 5.0)
^^^^^^^^^^^^^^^^^^^^^^^

.Option for Public Wireless LAN
* Check the Dynamic Assignment check-box
* Select "MAC Authentication" under Authentication
* Click "Config..." choose the Colon delimiter format
* Un-check all encryption options
* Under RADIUS put in PacketFence's RADIUS Server information

.Option for Secure Wireless LAN
* Check the Dynamic Assignment check-box
* Select "802.1X EAP" under Authentication
* Check WPA/WPA2-TKIP encryption option
* Under RADIUS put in PacketFence's RADIUS Server information

[float]
SNMP Global configuration
+++++++++++++++++++++++++

Add the two Read-Only and Read-Write users under *Management Access -> SNMP Access*.


Ruckus
~~~~~~

[float]
AAA Servers
+++++++++++

We need to define the RADIUS and RADIUS accounting (mandatory):

Under *Configuration -> AAA Servers*, click on the *Create New* button.  Enter the proper configuration:

* Enter a server name
* Select either RADIUS or RADIUS accounting as the type
* Use PAP as the Auth Method
* Enter the IP address, and shared secret.
* Hit OK

Repeat the steps for the RADIUS and RADIUS accounting types.  We need 1 definition for each otherwise RADIUS dynamic authorization won't work.

[float]
WLAN Definitions
++++++++++++++++

Under *Configuration -> WLAN*, click on the *Create New* button.  Enter the proper configuration:

.Open SSID
* Enter a Name/SSID
* Select *Standard Usage* as the Type
* Select *MAC Address* as the authentication type
* Select *Open* as the encryption method
* Select the proper RADIUS server as the authentication server
* Select the proper RADIUS server as the accounting server

NOTE: The Open SSID does *NOT* support dynamic VLAN assignments (Firmware 9.3.0.0.83)

.Secure SSID
* Enter a Name/SSID
* Select *Standard Usage* as the Type
* Select *WPA2* as the authentication type
* Select *AES* as the encryption method
* Select the proper RADIUS server as the authentication server
* Select the proper RADIUS server as the accounting server
* Check the *Enable Dynamic VLAN* checkbox

[float]
WIPS
++++

To enable the WIPS feature of the Ruckus in order to send SNMP traps to PacketFence, the setup is fairly simple.  

First, configure the controller to send the traps to PacketFence.  Under *Configure > System > Network Management > SNMP Trap*:

*Select "Enable SNMP Trap"
*Put the PacketFence Management IP in the Trap Server IP field

NOTE: The traps will arrive with the "public" community string

Next, you need to configure the Alarm Settings.  Under *Configure > Alarm Settings*, make sure the following are selected:

*Rogue AP Detected
*SSID-Spoofing AP Detected
*MAC-Spoofing AP Detected
*LAN Rogue AP Detected

Finally, enable the WIPS feature on the controller.  Under *Configure > WIPS > Intrusion Detection and Prevention*, make sure both box are selected, click Apply. 

Web Authentication
^^^^^^^^^^^^^^^^^^

In order to use PacketFence as an external captive portal for web authentication, you will need to configure first your RADIUS authentication and accounting server (see steps above).

[float]
Hotspot configuration
+++++++++++++++++++++

Configure the Hotspot service profile to redirect devices to your PacketFence portal. Go on the ZoneDirector administration web page to the section *Configure->Hotspot Services->Create New*

image::ruckus_hotspot_service.png[scaledwidth="100%",alt="Hotspot Service"]

 1 - Name of your Hotspot service
 2 - Login Page: Url of PacketFence portal interface (http://192.168.1.5/Ruckus)
 3 - Start Page: redirect to the following URL: http://192.168.1.5
 4 - Authentication Server: Select the PacketFence authentication RADIUS server (default port 1812)
 5 - Accounting Server: Select the PacketFence accounting RADIUS server (default 1813)
 6 - Click on the Walled Garden and authorize the IP of PacketFence management interface

Save your configuration.

[float]
WLAN configuration
++++++++++++++++++

Go to *Configure->WLANs->WLANs->Create New*

image::ruckus_create_ssid.png[scaledwidth="100%",alt="Hotspot Service"]

 1 - Name of your SSID
 2 - Type: Hotspot Service (WISPr)
 3 - Authentication Method: Open
 4 - Encryption Method: None
 5 - Hotspot Services: Your hotspot service name that you configured
 6 - Access VLAN: The VLAN ID that should be assigned to devices after authentication

Save your configuration.

[float]
PacketFence configuration
+++++++++++++++++++++++++

On the ZoneDirector configuration in PacketFence, you will need to specify -1 as the registration VLAN in order to display the captive portal to the end device. 

You will need to deactivate the force secure redirect on the captive portal under *Configuration->Captive Portal->Secure redirect->Unchecked*

The captive portal needs to listen on the management interface, so you will need to add the portal daemon to the management interface under *Configuration->Interfaces->Management Interface*


Example:

 [interface eth0]
 ip=192.168.1.5
 type=management,portal
 mask=255.255.255.0

To apply the configuration, restart PacketFence using the following command: service packetfence restart

Ruckus Roles
^^^^^^^^^^^^

[float]
Roles Configuration
+++++++++++++++++++

Ruckus allows you to define roles. These roles link all users to the internal WLAN and permit access to all WLAN by default. You can still limit access to certain WLAN.

To create a new user Role:

 1 - Go to Admin & Services > System > Roles. The Roles page appears, displaying a Default role in the Roles table.
 2 - Click Create New.
 3 - Enter a Name and a short Description for this role.
 4 - Choose the options for this role from the following:
    Group Attributes: Fill in this field only if you are creating a user role based on Group attributes extracted from an Active Directory server. Enter the User Group name here. Active Directory/LDAP users with the same group attributes are automatically mapped to this user role.
    Allow All WLANs: You have two options: (1) Allow Access to all WLANs, or (2) Specify WLAN Access. If you select the second option, you must specify the WLANs by clicking the check box next to each one.

image::Ruckus_Roles.png[scaledwidth="100%",alt="Ruckus Roles"]
image::Ruckus_CreateNewRole.png[scaledwidth="100%",alt="Create new role"]


[float]
PacketFence Configuration
+++++++++++++++++++++++++

On the PacketFence side you need to use role by switch role and add the Group Attribute you created on the Ruckus side.

So when a device will connect on the SSID, PacketFence will return a VLAN identifier and a RuckusUserGroup attribute and if the role is allowed on the WLAN then the device will be authorized on the WLAN.
In the case that the role is not allowed on the WLAN then the device will not be allowed to connect.


Ruckus SmartZone
~~~~~~~~~~~~~~~~

Webauth
^^^^^^^

SmartZone configuration
^^^^^^^^^^^^^^^^^^^^^^^

First, you will need to define your RADIUS server in 'Configuration->Service and Profiles->Authentication'.

Create your server using the following information (where 192.168.1.5 is the IP address of your PacketFence management interface):

* 'IP Address:' 192.168.1.5
* 'Port': 1812
* 'Secret': useStrongerSecret

Then, in 'Configuration->Service and Profiles->Accounting', create a server with the following information:

* 'IP Address:' 192.168.1.5
* 'Port': 1813
* 'Secret': useStrongerSecret

After, create a Hotspot in 'Configuration->AP Zones->Your Zone->Hotspot WISPr->Create New'. Adjust 192.168.1.5 to the IP address of your portal.

image::ruckus-smartzone-webauth-hotspot.png[scaledwidth="100%",alt="Ruckus SmartZone Hotspot"]

Then, still on this page, in the 'Walled Gardens', make sure you add the portal IP address in this list.

Next, you will need to configure your WLAN to use the Hotspot authentication and point it to PacketFence. Also ensure you set 'Use the controller as a proxy'.

image::ruckus-smartzone-webauth-ssid.png[scaledwidth="100%",alt="Ruckus SmartZone SSID"]

Now, you should configure the Northbound API of the SmartZone so PacketFence can communicate with it. In order to do so, go in 'Configuration->System->Northbound Portal Interface' and set the 'Password' and save it. Keep the password closeby as it will be required for the PacketFence configuration. In this example, it will be `passwordForNorthboundAPI`.

In order to receive the information not encrypted in the URL, you will need to connect on the Ruckus SmartZone controller using SSH and do the following command:

 no encrypt-mac-ip


PacketFence configuration
^^^^^^^^^^^^^^^^^^^^^^^^^

In PacketFence, add a switch in 'Configuration->Switches' with the following configuration:

* 'Definition->External Portal Enforcement' should be enabled
* 'Definition->Type': `Ruckus SmartZone Wireless Controller`
* 'Definition->Mode': `production`
* 'Roles->Role by VLAN ID' should be enabled
* 'Roles->registration VLAN': `-1`
* 'Roles->Role by Switch Role' should be disabled
* 'RADIUS->Secret passphrase': `useStrongerSecret`
* 'Web Services->Password': `passwordForNorthboundAPI`

Trapeze
~~~~~~~

In order to have the Trapeze controller working with PacketFence, you need to define the RADIUS configuration and the proper service profiles.

[float]
RADIUS configuration
++++++++++++++++++++

  set radius server PF address 192.168.1.5 timeout 5 retransmit 3 deadtime 0 key secret
  set server group PF-RADIUS members PF

[float]
Service Profiles
++++++++++++++++

Here we define two service profiles, one for the open SSID (PacketFence-Public)
and one for the WPA2-Enterprise SSID (PacketFence-Secure):

----
set service-profile PF-Open ssid-name PacketFence-Public
set service-profile PF-Open ssid-type clear
set service-profile PF-Open auth-fallthru last-resort
set service-profile PF-Open cipher-tkip enable
set service-profile PF-Open auth-dot1x disable
set service-profile PF-Open 11n mode-na required
set service-profile PF-Open attr vlan-name WLAN_REG

set service-profile PF-Secure ssid-name PacketFence-Secure
set service-profile PF-Secure cipher-tkip enable
set service-profile PF-Secure cipher-ccmp enable
set service-profile PF-Secure wpa-ie enable
set service-profile PF-Secure rsn-ie enable
set service-profile PF-Secure 11n mode-na required
set service-profile PF-Secure attr vlan-name Wlan

set radio-profile default service-profile PacketFence-Public
set radio-profile default service-profile PacketFence-Secure
----

[float]
AAA configuration
+++++++++++++++++

Finally, we need to tie the service profiles with the proper AAA configuration.

  set accounting dot1x ssid PacketFence-Secure ** start-stop PF-RADIUS
  set accounting mac ssid PacketFence-Public * start-stop PF-RADIUS
  set authentication mac ssid PacketFence-Public * PF-RADIUS
  set authentication dot1x ssid PacketFence-Secure ** pass-through PF-RADIUS

=== Ubiquiti


==== Web Authentication

===== Unifi side

In order to configure web authentication (external captive-portal) on Ubiquiti access points, you must have access to a Unifi controller and your APs must be connected to it.

First, you must configure the guest policy. Go in _Settings->hotspot->general_ and configure it as shown below:

image::ubiquiti-unifi-guest-policy.png[scaledwidth="100%",alt="Unifi web-auth policy"]

Next, you must allow the device to reach the portal. Go in _Settings->hotspot->advanced_ and configure it as shown below:

image::ubiquiti-unifi-guest-policy_access.png[scaledwidth="100%",alt="Unifi web-auth policy"]

Make sure you enabled _Enable Guest Portal_, and that you've set _External portal server_.

You also need to enter the IP address of a portal enabled interface on the PacketFence server in _Custom Portal_. Then in the _ACCESS CONTROL_ section, add that same IP address to the _Pre-Authorization Access_

Then, still in the settings, create or edit a new SSID with the following settings:

image::ubiquiti-unifi-guest-ssid.png[scaledwidth="100%",alt="Unifi web-auth SSID"]

You need to ensure link:https://help.ubnt.com/hc/en-us/articles/115015457668-UniFi-Troubleshooting-STUN-Communication-Errors#whatisstun[STUN protocol] is allowed between access points and
controller so that controller gets link:https://help.ubnt.com/hc/en-us/articles/204976094#1[instant notifications] from access points. That's important to have a correct deauthentication mechanism.

===== PacketFence side

Once this is done, you will need to define all your APs MAC addresses in the PacketFence switches with a configuration similar to this:

  [00:11:22:33:44:55]
  description=Ubiquiti AP
  ExternalPortalEnforcement=Y
  type=Ubiquiti::Unifi
  controllerIp=1.2.3.4
  wsTransport=HTTPS
  wsUser=admin
  wsPwd=admin

Where :

[options="compact"]
* *wsTransport* is the protocol used to connect to port 8443 of the Unifi controller and should be HTTPS. This is configured in the 'Web Services' tab of the switch.
* *wsUser* is a valid administrator username on your Unifi controller. This is configured in the 'Web Services' tab of the switch.
* *wsPwd* is the password that is associated to the wsUser. This is configured in the 'Web Services' tab of the switch.
* *controllerIp* is the IP address of your Unifi controller. This is configured in the 'Definition' tab of the switch.

==== VLAN Enforcement


In order to configure VLAN enforcement on the Unifi controller, you need first to configure a RADIUS profile, then a secure wireless network.

Important : You cannot reuse a VLAN ID for dynamic VLAN if it is set as a static value for another SSID on the same AP. So, if you have a SSID set to use VLAN 10, you cannot use VLAN ID 10 for RADIUS controlled VLAN users as those users will not get an IP address.

Note that VLAN enforcement for an open SSID is not supported yet by the controller and access point.

===== AAA Configuration


image::unifi-radius.png[scaledwidth="100%",alt="Unifi Radius Profile"]

===== Secure SSID


There is a special case when you want to be able to deauthenticate a device when it is connected on the secure SSID.

By default pmksa caching is enabled and applies even when a deauthentication request is sent to the controller, meaning you will not get a new RADIUS request afterwards. To disable this cache you will need to create a file on the controller.

First verify the site where your access point is managed. To do this, under the administration interface of the controller, select the appropriate "Current Site" then in the URI check the value just after site.

In this case the URL is https://192.168.1.6:8443/manage/site/4j4ee7x4/ so the site id is 4j4ee7x4.

Next connect on the controller via SSH and go in /usr/lib/unifi/data/sites/4j4ee7x4 (replace 4j4ee7x4 with your site id) and create a file named config.properties with the following content:

 config.system_cfg.1=aaa.1.auth_cache=disabled
 config.system_cfg.2=aaa.4.auth_cache=disabled

The numbers 1 and 4 are the profile id configured on the access point. To be sure you have the correct id, you can connect on the access point via SSH or via the debug terminal and do:

  BZ.v3.9.3# cat /tmp/system.cfg | grep ssid
  aaa.1.ssid=PacketFence-Secure
  wireless.1.ssid=PacketFence-Secure
  wireless.1.hide_ssid=false
  aaa.2.ssid=PacketFence-Public
  wireless.2.ssid=PacketFence-Public
  wireless.2.hide_ssid=false
  aaa.3.ssid=vport-802AA8863D5B
  wireless.3.ssid=vport-802AA8863D5B
  wireless.3.hide_ssid=true
  aaa.4.ssid=PacketFence-Secure
  wireless.4.ssid=PacketFence-Secure
  wireless.4.hide_ssid=false
  aaa.5.ssid=PacketFence-Public
  wireless.5.ssid=PacketFence-Public
  wireless.5.hide_ssid=false

You can see that PacketFence-Secure appears in 1 and 4 (2 radios).

Fore additional details, feel free to ask for support directly in the Ubiquiti forum: https://community.ubnt.com/t5/UniFi-Wireless/Feature-request-disable-pmksa-caching/m-p/2112479#M257628

Next you will need to create a secured profile:

image::unifi-secure.png[scaledwidth="100%",alt="Unifi Secure SSID"]


Xirrus
~~~~~~

Xirrus WiFi Arrays
^^^^^^^^^^^^^^^^^^

Xirrus Access Points can be configured to work with PacketFence quickly since Xirrus supports RADIUS assigned VLANs out of the box.

First, RADIUS server configuration. Set the RADIUS server to be PacketFence's IP: 

  radius-server  ! (global settings)
    !
    external
      primary     server 192.168.1.5
      primary     secret useStrongerSecret
      !
      accounting
        primary   server 192.168.1.5
        primary   secret useStrongerSecret
      exit
    exit
  exit

Enable SNMP Agent on the access point:

  snmp
    !
    v2
      community read-write public
      community read-only public
    exit
    !
  exit

Finally, don't forget to create the SSID you want and the proper bindings with the LAN. Open SSID should be configured to perform MAC Authentication and Secure SSID should be configured to perform 802.1X (WPA-Enterprise or WPA2-Enterprise).

External portal SSID
++++++++++++++++++++
* Set *Encryption / Authentication* to None / Open
* Then check the WPR checkbox
* Then in in the section Web Page Redirect Configuration set *Server* to External Login
* Set the *Redirect URL* to http://192.168.1.5/Xirrus
* Set the *Redirect Secret* to any passphrase of your choice
* In the *RADIUS Configuration* section set the RADIUS server to point to your PacketFence server

VPN Configuration
-----------------

Cisco ASA
~~~~~~~~~

AnyConnect
^^^^^^^^^^

PacketFence supports Cisco ASA VPN with AnyConnect.

You can force VPN users to authenticate first on the captive portal and based on the role of the device allow it and/or set dynamic ACL.

In this example we assume that the Cisco ASA have 2 interfaces, one Management (192.168.2.1) where the VPN is activated and another one Registration (192.168.1.6) that is facing the PacketFence server (192.168.1.5).

Before trying to configure PacketFence with the Cisco ASA first be sure that when you connect with AnyConnect and when the VPN is up that your device is able to reach Internet.

 ip local pool VPN_POOL 192.168.255.10-192.168.255.254 mask 255.255.255.0
 !
 interface GigabitEthernet0/0
  nameif MANAGEMENT
  security-level 0
  ip address 192.168.2.1 255.255.255.0 
 !
 interface GigabitEthernet0/1
  nameif Registration
  security-level 0
  ip address 192.168.1.5 255.255.0.0 
 !
 same-security-traffic permit inter-interface
 same-security-traffic permit intra-interface
 !
 object network NETWORK_OBJ_192.168.255.0_24
  subnet 192.168.255.0 255.255.255.0
 access-list redirect extended deny udp any any eq domain 
 access-list redirect extended deny ip any host 192.168.1.5 
 access-list redirect extended deny icmp any any 
 access-list redirect extended permit tcp any any eq www 
 access-list redirect extended permit tcp any any eq https 
 !
 route MANAGEMENT 0.0.0.0 0.0.0.0 192.168.2.254 1
 !
 aaa-server PacketFence protocol radius
  authorize-only
  interim-accounting-update periodic 1
  merge-dacl before-avpair
  dynamic-authorization
 aaa-server PacketFence (Registration) host 192.168.1.5
  timeout 5
  key useStrongerSecret
  authentication-port 1812
  accounting-port 1813
 !
 http server enable
 http 192.168.0.0 255.255.0.0 MANAGEMENT
 !
 webvpn
  enable MANAGEMENT
  anyconnect image disk0:/anyconnect-win-4.0.00051-k9.pkg 8
  anyconnect image disk0:/anyconnect-linux-64-4.0.00051-k9.pkg 9
  anyconnect image disk0:/anyconnect-macosx-i386-4.0.00051-k9.pkg 10
  anyconnect profiles VPN_client_profile disk0:/VPN_client_profile.xml
  anyconnect enable
  tunnel-group-list enable
  cache
   disable
  error-recovery disable
 group-policy GroupPolicy_VPN internal
 group-policy GroupPolicy_VPN attributes
  dns-server value 1.1.1.1
  vpn-tunnel-protocol ikev2 ssl-client 
  split-tunnel-policy tunnelall
  split-tunnel-network-list none
  default-domain value acme.com
  webvpn
   anyconnect profiles value VPN_client_profile type user
 tunnel-group VPN type remote-access
 tunnel-group VPN general-attributes
  address-pool (MANAGEMENT) VPN_POOL
  address-pool VPN_POOL
  authentication-server-group PacketFence
  accounting-server-group PacketFence
  default-group-policy GroupPolicy_VPN
 tunnel-group VPN webvpn-attributes
  group-alias VPN enable


include::includes/additional-info.asciidoc[]

include::includes/commercial-support.asciidoc[]

include::includes/license.asciidoc[]

// vim: set syntax=asciidoc tabstop=2 shiftwidth=2 expandtab:
